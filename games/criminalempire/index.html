<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Criminal Empire</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { height: 100%; overflow: hidden; overscroll-behavior: none; touch-action: manipulation; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; color: white; display: flex; flex-direction: column; height: 100vh; font-size: 14px; transition: background 1s; }
        .rank-0 { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); }
        .rank-1 { background: linear-gradient(135deg, #1a1a2e 0%, #2d1b4e 100%); }
        .rank-2 { background: linear-gradient(135deg, #1e3a5f 0%, #2d1b4e 100%); }
        .rank-3 { background: linear-gradient(135deg, #2d1b4e 0%, #4a1942 100%); }
        .rank-4 { background: linear-gradient(135deg, #4a1942 0%, #6b1d1d 100%); }
        .rank-5 { background: linear-gradient(135deg, #6b1d1d 0%, #8b6914 100%); }
        .rank-6 { background: radial-gradient(circle at 50% 50%, #ffd700 0%, #1a1a2e 70%); }


    .header { background: rgba(0,0,0,0.4); padding: 5px 10px; display: flex; justify-content: space-between; align-items: center; }
    .money-main { font-size: 1.4em; font-weight: bold; color: #4ade80; display: flex; align-items: center; gap: 6px; }
    .money-label { font-size: 0.5em; color: #94a3b8; font-weight: normal; }
    .combo-badge { font-size: 0.5em; background: linear-gradient(135deg, #f59e0b, #ef4444); padding: 2px 6px; border-radius: 8px; animation: comboPulse 0.3s infinite; }
    @keyframes comboPulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
    .money-sub { font-size: 0.55em; color: #64748b; display: flex; gap: 8px; }
    .money-sub .cash { color: #4ade80; }
    .money-sub .banked { color: #3b82f6; }
    .header-right { display: flex; align-items: center; gap: 6px; }
    .header-settings-btn { background: rgba(255,255,255,0.1); border: none; color: white; width: 28px; height: 28px; border-radius: 50%; cursor: pointer; font-size: 1em; display: flex; align-items: center; justify-content: center; }
    .header-settings-btn:hover { background: rgba(255,255,255,0.2); }
    .rank-badge { padding: 3px 8px; border-radius: 10px; font-weight: bold; font-size: 0.65em; }
    .rank-0-badge { background: linear-gradient(135deg, #6b7280, #4b5563); }
    .rank-1-badge { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
    .rank-2-badge { background: linear-gradient(135deg, #3b82f6, #2563eb); }
    .rank-3-badge { background: linear-gradient(135deg, #ec4899, #db2777); }
    .rank-4-badge { background: linear-gradient(135deg, #ef4444, #dc2626); }
    .rank-5-badge { background: linear-gradient(135deg, #f59e0b, #d97706); }
    .rank-6-badge { background: linear-gradient(135deg, #ffd700, #ffed4a); color: #1a1a2e; animation: legendBadge 2s infinite; }
    @keyframes legendBadge { 0%, 100% { box-shadow: 0 0 10px #ffd700; } 50% { box-shadow: 0 0 25px #ffd700; } }
    
    .progress-row { background: rgba(0,0,0,0.2); padding: 3px 10px; display: flex; align-items: center; gap: 6px; }
    .progress-bar-container { flex: 1; background: rgba(255,255,255,0.1); border-radius: 6px; height: 8px; overflow: hidden; }
    .progress-fill { background: linear-gradient(90deg, #4ade80, #22c55e); height: 100%; transition: width 0.3s; }
    .progress-text { font-size: 0.55em; color: #94a3b8; white-space: nowrap; text-align: right; min-width: 70px; }
    
    .stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 3px; padding: 4px 8px; background: rgba(0,0,0,0.15); font-size: 0.7em; }
    .stat-item { text-align: center; background: rgba(0,0,0,0.2); border-radius: 4px; padding: 3px 2px; cursor: pointer; }
    .stat-item:hover { background: rgba(255,255,255,0.1); }
    .stat-value { font-weight: bold; color: #fbbf24; font-size: 1.15em; }
    .stat-label { color: #64748b; font-size: 0.75em; }
    
    .click-section { display: flex; justify-content: center; align-items: center; padding: 8px; gap: 8px; position: fixed; bottom: 54px; left: 0; right: 0; background: linear-gradient(to top, rgba(0,0,0,0.95), rgba(0,0,0,0.7)); z-index: 100; pointer-events: none; min-height: 115px; }
    .click-section > * { pointer-events: auto; }
    .click-button { width: 98px; height: 98px; border-radius: 50%; font-size: 2.6em; cursor: pointer; transition: all 0.1s; position: relative; overflow: visible; display: flex; align-items: center; justify-content: center; border: none; user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; }
    .click-button::before { content: ''; position: absolute; inset: -15px; border-radius: 50%; background: transparent; }
    .click-button:active { transform: scale(0.88); }
    .click-0 { border: 3px solid #22c55e; background: linear-gradient(145deg, #4ade80, #16a34a); box-shadow: 0 4px 15px rgba(74, 222, 128, 0.4); }
    .click-1 { border: 3px solid #8b5cf6; background: linear-gradient(145deg, #a78bfa, #7c3aed); box-shadow: 0 4px 15px rgba(139, 92, 246, 0.5); }
    .click-2 { border: 3px solid #3b82f6; background: linear-gradient(145deg, #60a5fa, #2563eb); box-shadow: 0 4px 20px rgba(59, 130, 246, 0.6); }
    .click-3 { border: 3px solid #ec4899; background: linear-gradient(145deg, #f472b6, #db2777); box-shadow: 0 4px 20px rgba(236, 72, 153, 0.6); }
    .click-4 { border: 4px solid #ef4444; background: linear-gradient(145deg, #f87171, #dc2626); box-shadow: 0 6px 25px rgba(239, 68, 68, 0.7); }
    .click-5 { border: 4px solid #fbbf24; background: linear-gradient(145deg, #fcd34d, #f59e0b); box-shadow: 0 6px 30px rgba(251, 191, 36, 0.8); }
    .click-6 { border: 5px solid #ffd700; background: linear-gradient(145deg, #fff, #ffd700); box-shadow: 0 0 40px rgba(255, 215, 0, 1); animation: godButton 1s infinite; }
    @keyframes godButton { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
    
    .click-effect { position: absolute; pointer-events: none; font-weight: bold; animation: floatUp 0.5s ease-out forwards; text-shadow: 0 2px 4px rgba(0,0,0,0.8); z-index: 1000; }
    .click-effect.normal { font-size: 0.8em; color: #fff; }
    .click-effect.crit { font-size: 1.2em; color: #ffd700; animation: critFloat 0.6s ease-out forwards; }
    @keyframes floatUp { 0% { opacity: 1; transform: translateY(0) scale(1); } 100% { opacity: 0; transform: translateY(-60px) scale(1.2); } }
    @keyframes critFloat { 0% { opacity: 1; transform: translateY(0) scale(1.5); } 100% { opacity: 0; transform: translateY(-80px) scale(2); } }
    
    .side-panel { display: flex; flex-direction: column; gap: 5px; font-size: 0.7em; width: 70px; }
    .side-stat { background: linear-gradient(135deg, rgba(0,0,0,0.5), rgba(0,0,0,0.3)); padding: 5px 6px; border-radius: 8px; text-align: center; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 2px 8px rgba(0,0,0,0.3); }
    .side-stat .val { font-weight: bold; color: #4ade80; display: block; font-size: 1.2em; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
    .side-stat .lbl { color: #94a3b8; font-size: 0.85em; }
    
    .event-banner { position: absolute; top: -25px; left: 50%; transform: translateX(-50%); background: linear-gradient(90deg, #f59e0b, #ef4444); padding: 3px 12px; border-radius: 10px; font-size: 0.7em; font-weight: bold; white-space: nowrap; animation: eventPop 0.3s ease-out; }
    @keyframes eventPop { 0% { transform: translateX(-50%) scale(0); } 100% { transform: translateX(-50%) scale(1); } }
    
    .content-area { flex: 1; overflow-y: auto; padding: 5px 5px 210px 5px; -webkit-overflow-scrolling: touch; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .tab-bar { display: grid; grid-template-columns: repeat(5, 1fr); background: rgba(0,0,0,0.95); border-top: 2px solid rgba(251, 191, 36, 0.3); position: fixed; bottom: 0; left: 0; right: 0; z-index: 99; height: 58px; }
    .tab-btn { padding: 8px 4px; text-align: center; background: none; border: none; color: #64748b; font-size: 0.65em; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 2px; transition: all 0.2s; }
    .tab-btn.active { color: #fbbf24; background: rgba(251, 191, 36, 0.15); border-top: 2px solid #fbbf24; margin-top: -2px; }
    .tab-btn.locked { color: #374151; pointer-events: none; }
    .tab-btn span { font-size: 1.6em; }
    .tab-btn .unlock-hint { font-size: 0.75em; color: #6b7280; }
    
    .grid-2col { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; }
    .section-title { font-size: 0.65em; font-weight: bold; color: #fbbf24; margin: 4px 0; display: flex; align-items: center; gap: 4px; }
    
    /* Upgrade Cards */
    .upgrade-card { padding: 6px; background: rgba(0,0,0,0.25); border-radius: 6px; border: 1px solid rgba(255,255,255,0.05); transition: all 0.2s; position: relative; overflow: hidden; }
    .upgrade-card.affordable { border-color: rgba(74, 222, 128, 0.5); box-shadow: 0 0 10px rgba(74, 222, 128, 0.3); }
    .upgrade-card.maxed { border-color: rgba(255, 215, 0, 0.5); background: rgba(255, 215, 0, 0.1); }
    .upgrade-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 3px; }
    .upgrade-name { font-size: 0.75em; font-weight: bold; display: flex; align-items: center; gap: 3px; }
    .upgrade-tier { font-size: 0.6em; padding: 1px 4px; border-radius: 3px; font-weight: bold; }
    .tier-0 { background: #374151; } .tier-1 { background: #cd7f32; } .tier-2 { background: #c0c0c0; color: #1a1a2e; } .tier-3 { background: #ffd700; color: #1a1a2e; } .tier-4 { background: linear-gradient(90deg, #00ffff, #ff00ff); color: #1a1a2e; } .tier-5 { background: linear-gradient(90deg, #ff0000, #ffd700, #00ff00); color: #1a1a2e; animation: rainbow 1s linear infinite; }
    @keyframes rainbow { 0% { filter: hue-rotate(0deg); } 100% { filter: hue-rotate(360deg); } }
    .upgrade-tier-bar { height: 3px; background: rgba(255,255,255,0.1); border-radius: 2px; margin: 3px 0; overflow: hidden; }
    .upgrade-tier-fill { height: 100%; transition: width 0.3s; }
    .tier-0-fill { background: #6b7280; } .tier-1-fill { background: #cd7f32; } .tier-2-fill { background: #c0c0c0; } .tier-3-fill { background: #ffd700; } .tier-4-fill { background: linear-gradient(90deg, #00ffff, #ff00ff); } .tier-5-fill { background: linear-gradient(90deg, #ff0000, #ffd700, #00ff00); }
    .upgrade-meta { font-size: 0.6em; color: #94a3b8; display: flex; justify-content: space-between; }
    .upgrade-meta b { color: #fbbf24; }
    .upgrade-btn { width: 100%; margin-top: 4px; padding: 5px; background: linear-gradient(145deg, #ef4444, #dc2626); border: none; border-radius: 4px; color: white; font-weight: bold; font-size: 0.7em; cursor: pointer; transition: all 0.15s; }
    .upgrade-btn:disabled { background: #374151; color: #6b7280; }
    .upgrade-btn:not(:disabled):active { transform: scale(0.95); }
    .minigame-btn { background: linear-gradient(145deg, #a855f7, #7c3aed) !important; animation: mgPulse 1.5s infinite; }
    @keyframes mgPulse { 0%, 100% { box-shadow: 0 0 5px #a855f7; } 50% { box-shadow: 0 0 15px #a855f7; } }
    
    /* Territory Cards */
    .territory-card { position: relative; background: rgba(59, 130, 246, 0.1); border: 2px solid rgba(59, 130, 246, 0.4); border-radius: 8px; padding: 8px; transition: all 0.2s; overflow: hidden; min-height: 100px; background-size: cover; background-position: center; display: flex; flex-direction: column; justify-content: flex-end; }
    .territory-card::before { content: ''; position: absolute; inset: 0; background: linear-gradient(to top, rgba(0,0,0,0.75) 0%, rgba(0,0,0,0.3) 40%, transparent 100%); z-index: 0; }
    .territory-card > * { position: relative; z-index: 1; }
    .territory-card.owned { border-color: #22c55e; box-shadow: 0 0 15px rgba(34, 197, 94, 0.3); }
    .territory-card.owned::before { background: linear-gradient(to top, rgba(0,0,0,0.75) 0%, rgba(0,0,0,0.3) 40%, transparent 100%); }
    .territory-card .upgrade-header { text-shadow: 0 2px 4px rgba(0,0,0,0.9); }
    .territory-card .upgrade-header .upgrade-name { font-weight: bold; font-size: 0.85em; }
    .territory-pips { display: flex; gap: 3px; margin: 4px 0; }
    .territory-pip { flex: 1; height: 4px; border-radius: 2px; background: rgba(255,255,255,0.2); transition: background 0.3s; box-shadow: 0 1px 2px rgba(0,0,0,0.5); }
    .territory-pip.filled { background: linear-gradient(90deg, #22c55e, #4ade80); }

    /* Purchase Animation */
    @keyframes purchasePulse { 0% { transform: scale(1); box-shadow: 0 0 0 rgba(34, 197, 94, 0.7); } 50% { transform: scale(1.05); box-shadow: 0 0 20px rgba(34, 197, 94, 0.7); } 100% { transform: scale(1); box-shadow: 0 0 0 rgba(34, 197, 94, 0); } }
    .just-purchased { animation: purchasePulse 0.5s ease-out; }
    @keyframes raidFlash { 0%, 100% { filter: none; } 25% { filter: brightness(0.5) saturate(0) hue-rotate(240deg); } 50% { filter: brightness(0.7) saturate(0) hue-rotate(240deg); } 75% { filter: brightness(0.5) saturate(0) hue-rotate(240deg); } }
    @keyframes eventPop { 0% { transform: scale(0.8) rotate(-5deg); opacity: 0; } 50% { transform: scale(1.05) rotate(2deg); } 100% { transform: scale(1) rotate(0deg); opacity: 1; } }
    @keyframes hireSuccess { 0% { transform: scale(1) rotate(0deg); } 25% { transform: scale(1.15) rotate(-5deg); } 50% { transform: scale(1.1) rotate(5deg); } 75% { transform: scale(1.15) rotate(-3deg); } 100% { transform: scale(1) rotate(0deg); } }
    @keyframes crewAppear { 0% { transform: translateY(30px) scale(0.8); opacity: 0; } 60% { transform: translateY(-10px) scale(1.05); } 100% { transform: translateY(0) scale(1); opacity: 1; } }

    /* Heist Cards */
    .heist-card { background: linear-gradient(135deg, rgba(168, 85, 247, 0.15), rgba(236, 72, 153, 0.15)); border: 1px solid rgba(168, 85, 247, 0.3); border-radius: 6px; padding: 6px; position: relative; transition: all 0.2s; }
    .heist-card.on-cooldown { opacity: 0.6; }
    .heist-difficulty { position: absolute; top: 4px; right: 4px; font-size: 0.5em; padding: 2px 5px; border-radius: 3px; font-weight: bold; text-transform: uppercase; }
    .heist-difficulty.easy { background: #22c55e; color: white; }
    .heist-difficulty.medium { background: #eab308; color: #1a1a2e; }
    .heist-difficulty.hard { background: #ef4444; color: white; }
    .heist-difficulty.legendary { background: linear-gradient(90deg, #a855f7, #ec4899); color: white; }
    .heist-name { font-size: 0.8em; font-weight: bold; margin-bottom: 2px; }
    .heist-info { font-size: 0.6em; color: #94a3b8; }
    .heist-bar { height: 4px; background: rgba(0,0,0,0.3); border-radius: 2px; overflow: hidden; margin: 4px 0; }
    .heist-bar-fill { height: 100%; background: linear-gradient(90deg, #ef4444, #eab308, #22c55e); transition: width 0.3s; }
    
    /* Police Cards */
    .police-card { background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 6px; padding: 6px; transition: all 0.2s; }
    .police-card.owned { opacity: 0.7; border-color: #22c55e; background: rgba(34, 197, 94, 0.1); }
    
    /* Heat Info Panel */
    .heat-info-panel { background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 6px; padding: 8px; margin-bottom: 8px; font-size: 0.65em; }
    .heat-info-panel h4 { color: #ef4444; margin-bottom: 4px; display: flex; align-items: center; gap: 4px; }
    .heat-info-panel p { color: #94a3b8; margin: 2px 0; }
    .heat-info-panel b { color: #fbbf24; }
    
    /* Crew/Thief Cards */
    .thief-card { position: relative; background: rgba(168, 85, 247, 0.15); border: 2px solid rgba(168, 85, 247, 0.4); border-radius: 8px; padding: 0; font-size: 0.7em; overflow: hidden; min-height: 140px; background-size: cover; background-position: right center; }
    .thief-card::before { content: ''; position: absolute; inset: 0; background: linear-gradient(to right, rgba(0,0,0,0.95) 0%, rgba(0,0,0,0.85) 40%, rgba(0,0,0,0.3) 70%, transparent 100%); z-index: 0; }
    .thief-card > * { position: relative; z-index: 1; }
    .thief-card-header { padding: 6px; }
    .thief-rank-badge { font-size: 0.75em; padding: 2px 6px; border-radius: 4px; margin-left: 4px; color: white; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
    .thief-stats { display: flex; flex-direction: column; gap: 6px; margin: 6px 6px 8px 6px; max-width: 50%; }
    .thief-stat { background: rgba(0,0,0,0.5); padding: 6px 8px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.15); display: flex; align-items: center; gap: 6px; }
    .thief-stat-icon { font-size: 1.2em; }
    .thief-stat-info { flex: 1; }
    .thief-stat-label { font-size: 0.7em; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.5px; }
    .thief-stat-value { font-weight: bold; color: #4ade80; font-size: 1em; }
    .train-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; margin: 0 6px 6px 6px; }
    .train-btn { padding: 6px 4px; background: linear-gradient(135deg, rgba(59, 130, 246, 0.3), rgba(37, 99, 235, 0.3)); border: 1px solid rgba(59, 130, 246, 0.5); border-radius: 6px; color: white; font-size: 0.8em; cursor: pointer; text-align: center; transition: all 0.2s; font-weight: bold; }
    .train-btn:disabled { background: rgba(55, 65, 81, 0.3); border-color: rgba(107, 114, 128, 0.3); color: #6b7280; }
    .train-btn:not(:disabled):hover { background: linear-gradient(135deg, rgba(59, 130, 246, 0.5), rgba(37, 99, 235, 0.5)); transform: translateY(-1px); }
    .train-btn-label { display: block; font-size: 0.7em; color: #94a3b8; margin-top: 2px; }
    
    /* Storage Cards */
    .storage-card { background: rgba(251, 191, 36, 0.1); border: 1px solid rgba(251, 191, 36, 0.3); border-radius: 6px; padding: 6px; font-size: 0.7em; }
    .storage-bar { height: 5px; background: rgba(0,0,0,0.3); border-radius: 3px; margin: 4px 0; overflow: hidden; }
    .storage-fill { height: 100%; background: linear-gradient(90deg, #fbbf24, #f59e0b); transition: width 0.3s; }
    .storage-btns { display: grid; grid-template-columns: repeat(3, 1fr); gap: 3px; }
    .storage-btns button { padding: 4px; font-size: 0.85em; }
    
    /* Empty State */
    .empty-state { text-align: center; padding: 20px; color: #64748b; font-size: 0.75em; grid-column: span 2; }
    
    /* Locked Tab Content */
    .locked-content { text-align: center; padding: 30px 20px; color: #64748b; }
    .locked-content .lock-icon { font-size: 3em; margin-bottom: 10px; opacity: 0.5; }
    .locked-content h3 { color: #94a3b8; margin-bottom: 5px; }
    .locked-content p { font-size: 0.8em; }
    
    /* Buttons */
    .btn { padding: 4px 8px; border: none; border-radius: 4px; font-weight: bold; font-size: 0.6em; cursor: pointer; transition: all 0.15s; user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; }
    .btn:not(:disabled):active { transform: scale(0.95); }
    .btn-green { background: linear-gradient(145deg, #22c55e, #16a34a); color: white; }
    .btn-purple { background: linear-gradient(145deg, #a855f7, #9333ea); color: white; }
    .btn-gold { background: linear-gradient(145deg, #fbbf24, #f59e0b); color: #1a1a2e; }
    .btn-red { background: linear-gradient(145deg, #ef4444, #dc2626); color: white; }
    .btn-blue { background: linear-gradient(145deg, #3b82f6, #2563eb); color: white; }
    .btn:disabled { background: #374151; color: #6b7280; }
    
    /* Notifications */
    .notification { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 12px 20px; border-radius: 12px; font-weight: bold; z-index: 1000; animation: notifPop 0.25s ease-out; cursor: pointer; text-align: center; max-width: 280px; font-size: 0.85em; }
    @keyframes notifPop { 0% { transform: translate(-50%, -50%) scale(0.3); opacity: 0; } 50% { transform: translate(-50%, -50%) scale(1.1); } 100% { transform: translate(-50%, -50%) scale(1); opacity: 1; } }
    .notification.level { background: linear-gradient(135deg, #fbbf24, #f59e0b); color: #1a1a2e; }
    .notification.rank-up { background: linear-gradient(135deg, #a855f7, #ec4899); color: white; box-shadow: 0 0 30px rgba(168, 85, 247, 0.6); }
    .notification.police { background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; }
    .notification.income { background: linear-gradient(135deg, #22c55e, #16a34a); color: white; }
    .notification.theft { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; }
    .notification.heist-win { background: linear-gradient(135deg, #a855f7, #ec4899); color: white; box-shadow: 0 0 20px rgba(168, 85, 247, 0.5); }
    .notification.heist-fail { background: linear-gradient(135deg, #6b7280, #374151); color: white; }
    .notification.event { background: linear-gradient(135deg, #f59e0b, #ef4444); color: white; }
    .notification.offline { background: linear-gradient(135deg, #22c55e, #3b82f6); color: white; }
    .notification.achievement { background: linear-gradient(135deg, #ffd700, #f59e0b); color: #1a1a2e; box-shadow: 0 0 25px rgba(255, 215, 0, 0.6); }
    .notification.tip { background: linear-gradient(135deg, #06b6d4, #3b82f6); color: white; }
    .notification small { display: block; font-weight: normal; margin-top: 3px; font-size: 0.85em; opacity: 0.9; }
    
    /* Achievements */
    .achievement-card { background: rgba(255, 215, 0, 0.1); border: 1px solid rgba(255, 215, 0, 0.3); border-radius: 6px; padding: 8px; display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
    .achievement-card.locked { background: rgba(100, 116, 139, 0.1); border: 1px solid rgba(100, 116, 139, 0.3); opacity: 0.6; }
    .achievement-icon { font-size: 1.8em; width: 40px; text-align: center; }
    .achievement-info { flex: 1; }
    .achievement-name { font-weight: bold; font-size: 0.85em; color: #fbbf24; }
    .achievement-card.locked .achievement-name { color: #94a3b8; }
    .achievement-desc { font-size: 0.7em; color: #94a3b8; margin-top: 2px; }
    .achievement-progress { font-size: 0.65em; color: #4ade80; margin-top: 3px; font-weight: bold; }
    .achievement-checkmark { color: #22c55e; font-size: 1.5em; }

    /* Settings Modal */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 2000; display: none; justify-content: center; align-items: center; padding: 20px; }
    .modal-overlay.active { display: flex; }
    .modal-container { width: 100%; max-width: 340px; background: linear-gradient(145deg, #1a1a2e, #2d1b4e); border-radius: 12px; border: 2px solid #fbbf24; padding: 15px; max-height: 80vh; overflow-y: auto; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .modal-title { font-size: 1.1em; font-weight: bold; color: #fbbf24; }
    .modal-close { background: none; border: none; color: #ef4444; font-size: 1.3em; cursor: pointer; }
    .settings-group { margin-bottom: 12px; }
    .settings-group h4 { font-size: 0.75em; color: #94a3b8; margin-bottom: 6px; text-transform: uppercase; }
    .settings-row { display: flex; justify-content: space-between; align-items: center; padding: 8px; background: rgba(0,0,0,0.2); border-radius: 6px; margin-bottom: 4px; }
    .settings-row label { font-size: 0.8em; }
    .toggle { width: 44px; height: 24px; background: #374151; border-radius: 12px; position: relative; cursor: pointer; transition: background 0.3s; }
    .toggle.on { background: #22c55e; }
    .toggle::after { content: ''; position: absolute; width: 20px; height: 20px; background: white; border-radius: 50%; top: 2px; left: 2px; transition: left 0.3s; }
    .toggle.on::after { left: 22px; }
    .settings-btn { width: 100%; padding: 10px; margin-top: 4px; font-size: 0.8em; }
    .danger-zone { border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 6px; padding: 8px; margin-top: 8px; }
    .danger-zone h4 { color: #ef4444; }
    
    /* Achievements */
    .achievement-card { background: rgba(255, 215, 0, 0.1); border: 1px solid rgba(255, 215, 0, 0.3); border-radius: 6px; padding: 6px; display: flex; align-items: center; gap: 8px; }
    .achievement-card.locked { opacity: 0.5; filter: grayscale(1); }
    .achievement-icon { font-size: 1.5em; }
    .achievement-info { flex: 1; }
    .achievement-name { font-size: 0.75em; font-weight: bold; }
    .achievement-desc { font-size: 0.6em; color: #94a3b8; }
    
    /* Debug Buttons */
    .debug-btns { position: fixed; bottom: 55px; right: 5px; display: flex; flex-direction: column; gap: 3px; z-index: 500; }
    .debug-btn { background: rgba(239,68,68,0.8); border: none; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.55em; cursor: pointer; }
    .debug-btn.blue { background: rgba(59,130,246,0.8); }
    
    /* Slot Machine Styles */
    .slot-machine { background: linear-gradient(145deg, #4a1942, #2d1b4e); border-radius: 12px; padding: 15px; border: 3px solid #ffd700; }
    .slot-reels { display: flex; justify-content: center; gap: 8px; margin: 15px 0; }
    .slot-reel { width: 70px; height: 80px; background: linear-gradient(180deg, #1a1a2e, #0a0a1a); border-radius: 8px; border: 2px solid #fbbf24; overflow: hidden; position: relative; }
    .slot-reel::before, .slot-reel::after { content: ''; position: absolute; left: 0; right: 0; height: 15px; z-index: 2; pointer-events: none; }
    .slot-reel::before { top: 0; background: linear-gradient(180deg, #1a1a2e, transparent); }
    .slot-reel::after { bottom: 0; background: linear-gradient(0deg, #1a1a2e, transparent); }
    .reel-strip { display: flex; flex-direction: column; align-items: center; }
    .reel-symbol { height: 80px; width: 70px; display: flex; align-items: center; justify-content: center; font-size: 2.8em; flex-shrink: 0; }
    .slot-controls { display: flex; flex-direction: column; gap: 8px; }
    .slot-bet-row { display: flex; align-items: center; justify-content: center; gap: 10px; }
    .slot-bet-row button { width: 40px; height: 40px; border-radius: 50%; font-size: 1.2em; border: 2px solid #fbbf24; background: linear-gradient(145deg, #4a1942, #2d1b4e); color: white; cursor: pointer; }
    .slot-bet-row button:disabled { opacity: 0.5; }
    .slot-bet-row button:active { transform: scale(0.9); }
    .slot-bet { font-size: 1.1em; min-width: 100px; text-align: center; }
    .slot-bet b { color: #4ade80; font-size: 1.2em; }
    .slot-spin-btn { width: 100%; padding: 15px; font-size: 1.3em; font-weight: bold; background: linear-gradient(145deg, #ef4444, #dc2626); border: 3px solid #fbbf24; border-radius: 10px; color: white; cursor: pointer; text-transform: uppercase; letter-spacing: 2px; }
    .slot-spin-btn:disabled { background: #374151; border-color: #6b7280; }
    .slot-bonus-btn { width: 100%; padding: 10px; font-size: 0.9em; background: linear-gradient(145deg, #a855f7, #7c3aed); border: 2px solid #ffd700; border-radius: 8px; color: white; cursor: pointer; margin-top: 8px; }
    .slot-bonus-btn:disabled { opacity: 0.5; }
    .slot-result { text-align: center; font-size: 1.1em; font-weight: bold; min-height: 30px; margin-top: 8px; }
    .slot-result.win { color: #4ade80; animation: winFlash 0.3s ease-in-out 3; }
    .slot-result.lose { color: #ef4444; }
    .slot-result.jackpot { color: #ffd700; animation: jackpot 0.5s ease-in-out infinite; font-size: 1.4em; }
    @keyframes winFlash { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
    @keyframes jackpot { 0%, 100% { transform: scale(1) rotate(-2deg); text-shadow: 0 0 10px #ffd700; } 50% { transform: scale(1.15) rotate(2deg); text-shadow: 0 0 20px #ffd700; } }
    .slot-paytable { display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; margin-top: 10px; font-size: 0.65em; background: rgba(0,0,0,0.3); padding: 8px; border-radius: 6px; }
    .slot-paytable div { text-align: center; padding: 3px; }
    .slot-select { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 6px; margin-bottom: 10px; }
    .slot-select-btn { padding: 6px 4px; border-radius: 8px; border: 2px solid #6b7280; background: rgba(0,0,0,0.3); color: white; cursor: pointer; text-align: center; transition: all 0.2s; }
    .slot-select-btn.active { border-color: #ffd700; background: rgba(255,215,0,0.15); box-shadow: 0 0 15px rgba(255,215,0,0.3); }
    .slot-select-btn .icon { font-size: 1.3em; display: block; margin-bottom: 2px; }
    .slot-select-btn .name { font-weight: bold; font-size: 0.7em; }
    .slot-select-btn .desc { font-size: 0.55em; color: #94a3b8; margin-top: 1px; display: none; }
    .mega-reels { display: flex; justify-content: center; gap: 4px; margin: 10px 0; }
    .mega-reel { width: 48px; background: linear-gradient(180deg, #1a1a2e, #0a0a1a); border-radius: 6px; border: 2px solid #fbbf24; overflow: hidden; position: relative; display: flex; flex-direction: column; }
    .mega-symbol { height: 36px; display: flex; align-items: center; justify-content: center; font-size: 1.6em; transition: all 0.3s; }
    .mega-symbol.winning { animation: megaWin 0.4s ease-in-out; background: rgba(255,215,0,0.3); }
    .mega-symbol.cascade { animation: cascadeFall 0.3s ease-out; }
    @keyframes megaWin { 0%,100% { transform: scale(1); } 50% { transform: scale(1.2); } }
    @keyframes cascadeFall { 0% { transform: translateY(-100%); opacity: 0; } 100% { transform: translateY(0); opacity: 1; } }
    .mega-info { display: flex; justify-content: space-between; font-size: 0.75em; margin: 8px 0; padding: 6px; background: rgba(0,0,0,0.3); border-radius: 6px; }
    .mega-info .ways { color: #fbbf24; } .mega-info .mult { color: #a855f7; }
    .mega-cascade-info { text-align: center; font-size: 0.8em; color: #4ade80; min-height: 20px; }
    .mg-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 2000; display: none; justify-content: center; align-items: center; }
    .mg-overlay.active { display: flex; }
    .mg-container { width: 95%; max-width: 360px; background: linear-gradient(145deg, #1a1a2e, #2d1b4e); border-radius: 16px; border: 2px solid #ffd700; padding: 12px; position: relative; max-height: 90vh; overflow-y: auto; }
    .mg-close { position: absolute; top: 8px; right: 10px; background: none; border: none; color: #ef4444; font-size: 1.5em; cursor: pointer; }
    .mg-title { text-align: center; font-size: 1.2em; font-weight: bold; margin-bottom: 8px; background: linear-gradient(90deg, #ffd700, #f59e0b); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .mg-balance { text-align: center; font-size: 0.9em; color: #4ade80; margin-bottom: 10px; }
    /* Safe Cracker */
    .safe-game { text-align: center; }
    .safe-dial { width: 180px; height: 180px; margin: 10px auto; background: radial-gradient(circle, #374151, #1a1a2e); border-radius: 50%; border: 6px solid #6b7280; position: relative; box-shadow: inset 0 0 20px rgba(0,0,0,0.5); }
    .safe-dial::before { content: ''; position: absolute; top: 5px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 8px solid transparent; border-right: 8px solid transparent; border-top: 15px solid #ef4444; z-index: 10; }
    .safe-pointer { position: absolute; width: 4px; height: 70px; background: linear-gradient(180deg, #ffd700, #f59e0b); left: 50%; bottom: 50%; transform-origin: bottom center; transform: translateX(-50%); border-radius: 2px; transition: transform 0.1s; z-index: 5; }
    .safe-marker { position: absolute; width: 100%; height: 100%; top: 0; left: 0; display: flex; justify-content: center; }
    .safe-marker span { position: absolute; top: 8px; font-size: 0.75em; font-weight: bold; color: #94a3b8; background: rgba(0,0,0,0.5); padding: 2px 4px; border-radius: 3px; }
    .safe-combo { display: flex; justify-content: center; gap: 8px; margin: 10px 0; }
    .safe-combo-num { width: 45px; height: 45px; background: rgba(0,0,0,0.4); border: 2px solid #6b7280; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.3em; font-weight: bold; }
    .safe-combo-num.active { border-color: #ffd700; box-shadow: 0 0 10px #ffd700; }
    .safe-combo-num.correct { border-color: #22c55e; background: rgba(34, 197, 94, 0.2); }
    .safe-combo-num.wrong { border-color: #ef4444; background: rgba(239, 68, 68, 0.2); }
    .safe-controls { display: flex; justify-content: center; gap: 12px; margin: 12px 0; }
    .safe-controls button { width: 55px; height: 55px; border-radius: 50%; font-size: 1.3em; border: 3px solid #fbbf24; background: linear-gradient(145deg, #4a1942, #2d1b4e); color: white; cursor: pointer; }
    .safe-submit { padding: 10px 25px; font-size: 1em; background: linear-gradient(145deg, #22c55e, #16a34a); border: 2px solid #ffd700; border-radius: 8px; color: white; cursor: pointer; font-weight: bold; }
    .safe-info { font-size: 0.75em; color: #94a3b8; margin: 6px 0; }
    /* Dice Game */
    .dice-game { text-align: center; }
    .dice-container { display: flex; justify-content: center; gap: 15px; margin: 15px 0; }
    .dice { width: 80px; height: 80px; background: linear-gradient(145deg, #fff, #e8e8e8); border-radius: 12px; display: grid; grid-template-areas: 'a . b' '. c .' 'd . e'; padding: 8px; gap: 4px; box-shadow: 0 6px 16px rgba(0,0,0,0.4), inset 0 2px 4px rgba(255,255,255,0.5); position: relative; }
    .dice::before { content: ''; position: absolute; inset: 3px; border-radius: 8px; background: linear-gradient(145deg, rgba(255,255,255,0.3), transparent); }
    .dice-dot { width: 12px; height: 12px; background: #1a1a2e; border-radius: 50%; box-shadow: 0 2px 3px rgba(0,0,0,0.3); }
    .dice.rolling { animation: diceRoll 0.15s linear infinite; }
    @keyframes diceRoll { 0% { transform: rotate(0deg) scale(1); } 25% { transform: rotate(90deg) scale(0.9); } 50% { transform: rotate(180deg) scale(1); } 75% { transform: rotate(270deg) scale(0.9); } 100% { transform: rotate(360deg) scale(1); } }
    .dice-bet-options { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; margin: 8px 0; }
    .dice-bet-opt { padding: 8px 4px; background: rgba(59, 130, 246, 0.2); border: 2px solid #3b82f6; border-radius: 6px; cursor: pointer; font-size: 0.75em; transition: all 0.2s; }
    .dice-bet-opt.selected { background: rgba(59, 130, 246, 0.5); border-color: #ffd700; }
    .dice-bet-opt .payout { color: #4ade80; font-weight: bold; }
    .dice-roll-btn { width: 100%; padding: 12px; font-size: 1.1em; font-weight: bold; background: linear-gradient(145deg, #3b82f6, #2563eb); border: 3px solid #fbbf24; border-radius: 10px; color: white; cursor: pointer; margin-top: 8px; }
    .dice-roll-btn:disabled { background: #374151; border-color: #6b7280; }
</style>

</head>
<body class="rank-0">
    <div class="debug-btns" id="debugBtns" style="display:none">
        <button class="debug-btn" onclick="money+=1e12;saveGame();updateAll()">+$1T</button>
        <button class="debug-btn blue" onclick="money=0;storageLocations.forEach(s=>s.stored=0);saveGame();updateAll()">ZERO</button>
    </div>

<div class="modal-overlay" id="settingsModal">
    <div class="modal-container">
        <div class="modal-header">
            <span class="modal-title">‚öôÔ∏è Settings</span>
            <button class="modal-close" onclick="closeSettings()">‚úï</button>
        </div>
        <div class="settings-group">
            <h4>Preferences</h4>
            <div class="settings-row">
                <label>Sound Effects</label>
                <div class="toggle" id="toggleSound" onclick="toggleSetting('sound')"></div>
            </div>
            <div class="settings-row">
                <label>Vibration</label>
                <div class="toggle" id="toggleVib" onclick="toggleSetting('vibration')"></div>
            </div>
            <div class="settings-row">
                <label>Show Tips</label>
                <div class="toggle" id="toggleTips" onclick="toggleSetting('tips')"></div>
            </div>
            <div class="settings-row">
                <label>Debug Mode</label>
                <div class="toggle" id="toggleDebug" onclick="toggleSetting('debug')"></div>
            </div>
        </div>
        <div class="settings-group">
            <h4>Save Data</h4>
            <button class="btn btn-blue settings-btn" onclick="exportSave()">üì§ Export Save</button>
            <button class="btn btn-purple settings-btn" onclick="importSave()">üì• Import Save</button>
        </div>
        <div class="danger-zone">
            <h4>‚ö†Ô∏è Danger Zone</h4>
            <button class="btn btn-red settings-btn" onclick="hardReset()">üóëÔ∏è Reset ALL Progress</button>
        </div>
        <div style="font-size:0.6em;color:#64748b;text-align:center;margin-top:10px">Auto-saves every 5 seconds</div>
    </div>
</div>

<div class="modal-overlay" id="achievementsModal">
    <div class="modal-container">
        <div class="modal-header">
            <span class="modal-title">üèÜ Achievements</span>
            <button class="modal-close" onclick="closeAchievements()">‚úï</button>
        </div>
        <div id="achievementsList"></div>
        <div style="font-size:0.65em;color:#64748b;text-align:center;margin-top:10px">
            <span id="achievementCount">0/15</span> unlocked
        </div>
    </div>
</div>

<div class="modal-overlay" id="welcomeBackModal">
    <div class="modal-container" style="max-width:400px">
        <div class="modal-header" style="background:linear-gradient(135deg,#8b5cf6,#6d28d9)">
            <span class="modal-title">üí§ Welcome Back!</span>
            <button class="modal-close" onclick="closeWelcomeBack()">‚úï</button>
        </div>
        <div style="padding:20px;text-align:center">
            <div style="font-size:3em;margin:10px 0" id="wbEmoji">üò¥</div>
            <div style="font-size:1.2em;font-weight:bold;color:#fbbf24;margin:10px 0" id="wbEarnings">+$0</div>
            <div style="font-size:0.85em;color:#94a3b8;margin:5px 0">earned while away</div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:15px 0;padding:15px;background:rgba(0,0,0,0.3);border-radius:8px">
                <div><div style="font-size:0.7em;color:#64748b">Time Away</div><div style="font-weight:bold;color:#a78bfa" id="wbTime">0m</div></div>
                <div><div style="font-size:0.7em;color:#64748b">Per Hour</div><div style="font-weight:bold;color:#4ade80" id="wbRate">$0/hr</div></div>
            </div>
            <button class="btn btn-purple" onclick="closeWelcomeBack()" style="width:100%;padding:12px;font-size:1em">Continue Empire Building!</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="prestigeModal">
    <div class="modal-container" style="max-width:500px">
        <div class="modal-header" style="background:linear-gradient(135deg,#f59e0b,#d97706)">
            <span class="modal-title">üëë Legacy System</span>
            <button class="modal-close" onclick="closePrestige()">‚úï</button>
        </div>
        <div style="padding:20px">
            <div style="text-align:center;margin-bottom:15px">
                <div style="font-size:2.5em">üèùÔ∏è</div>
                <h3 style="margin:10px 0;color:#fbbf24">Retire to Paradise</h3>
                <p style="font-size:0.85em;color:#94a3b8;margin:5px 0">Reset your empire and gain permanent bonuses</p>
            </div>
            <div style="background:rgba(0,0,0,0.3);padding:15px;border-radius:8px;margin:15px 0">
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:10px">
                    <div><div style="font-size:0.7em;color:#64748b">Prestige Level</div><div style="font-weight:bold;font-size:1.3em;color:#fbbf24" id="currentPrestige">0</div></div>
                    <div><div style="font-size:0.7em;color:#64748b">Legacy Points</div><div style="font-weight:bold;font-size:1.3em;color:#22c55e" id="currentLegacy">0</div></div>
                </div>
                <div style="border-top:1px solid rgba(255,255,255,0.1);padding-top:10px;margin-top:10px">
                    <div style="font-size:0.75em;color:#94a3b8;margin-bottom:5px">You will earn:</div>
                    <div style="font-size:1.8em;font-weight:bold;color:#4ade80;text-align:center" id="prestigeReward">+0 LP</div>
                    <div style="font-size:0.7em;color:#64748b;text-align:center;margin-top:5px">Based on lifetime earnings: <span id="lifetimeDisplay">$0</span></div>
                </div>
            </div>
            <div style="background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);border-radius:6px;padding:10px;margin:15px 0">
                <div style="font-size:0.75em;color:#ef4444;font-weight:bold;margin-bottom:5px">‚ö†Ô∏è You will lose:</div>
                <div style="font-size:0.7em;color:#fca5a5">
                    ‚Ä¢ All money and upgrades<br>
                    ‚Ä¢ All territories and crew<br>
                    ‚Ä¢ All progress (except achievements)
                </div>
            </div>
            <div style="background:rgba(34,197,94,0.1);border:1px solid rgba(34,197,94,0.3);border-radius:6px;padding:10px;margin:15px 0">
                <div style="font-size:0.75em;color:#22c55e;font-weight:bold;margin-bottom:5px">‚úì You will keep:</div>
                <div style="font-size:0.7em;color:#86efac">
                    ‚Ä¢ All achievements<br>
                    ‚Ä¢ All Legacy Points<br>
                    ‚Ä¢ All prestige upgrades
                </div>
            </div>
            <button class="btn btn-red" onclick="confirmPrestige()" style="width:100%;padding:14px;font-size:1.1em;font-weight:bold" id="prestigeBtn">üèùÔ∏è Retire to Paradise</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="prestigeShopModal">
    <div class="modal-container">
        <div class="modal-header" style="background:linear-gradient(135deg,#f59e0b,#d97706)">
            <span class="modal-title">üëë Legacy Upgrades</span>
            <button class="modal-close" onclick="closePrestigeShop()">‚úï</button>
        </div>
        <div style="padding:10px;max-height:70vh;overflow-y:auto">
            <div style="text-align:center;background:rgba(251,191,36,0.1);padding:10px;border-radius:6px;margin-bottom:10px">
                <span style="font-size:0.75em;color:#94a3b8">Legacy Points Available:</span>
                <div style="font-size:1.5em;font-weight:bold;color:#fbbf24" id="lpDisplay">0 LP</div>
            </div>
            <div class="grid-2col" id="prestigeUpgradesList"></div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="eventModal">
    <div class="modal-container" style="max-width:380px">
        <div class="modal-header" id="eventHeader" style="background:linear-gradient(135deg,#f59e0b,#d97706)">
            <span class="modal-title" id="eventTitle">‚ö° Event!</span>
            <button class="modal-close" onclick="closeEvent()">‚úï</button>
        </div>
        <div style="padding:20px;text-align:center">
            <div style="font-size:3.5em;margin:15px 0" id="eventIcon">‚ö°</div>
            <div style="font-size:1.2em;font-weight:bold;margin:10px 0" id="eventName">Something Happened!</div>
            <div style="font-size:0.85em;color:#94a3b8;margin:8px 0" id="eventDesc">Description</div>
            <div style="font-size:1.1em;font-weight:bold;margin:15px 0;padding:12px;border-radius:8px;background:rgba(0,0,0,0.3)" id="eventResult">Result</div>
            <div id="eventActions" style="display:none;margin-top:15px">
                <button class="btn btn-green" onclick="acceptEventChoice()" style="margin:5px">Accept</button>
                <button class="btn btn-red" onclick="declineEventChoice()" style="margin:5px">Decline</button>
            </div>
            <button class="btn btn-purple" onclick="closeEvent()" id="eventContinue" style="width:100%;padding:12px;margin-top:10px">Continue</button>
        </div>
    </div>
</div>

<div class="mg-overlay" id="mgOverlay">
    <div class="mg-container" id="mgContainer"></div>
</div>

<div class="header">
    <div>
        <div class="money-main">
            <span id="money">$0</span>
            <span class="combo-badge" id="comboBadge" style="display:none">x1</span>
        </div>
        <div class="money-sub">
            <span class="cash">üíµ Cash: <span id="onHand">$0</span></span>
            <span class="banked">üè¶ Safe: <span id="stored">$0</span></span>
        </div>
    </div>
    <div class="header-right">
        <div class="rank-badge rank-0-badge" id="rankBadge">üî∞ Thug</div>
        <button class="header-settings-btn" onclick="openPrestigeShop()" style="display:none" id="lpBtn" title="Legacy Shop"><span style="font-size:0.7em" id="lpBadge">0</span> üëë</button>
        <button class="header-settings-btn" onclick="openAchievements()">üèÜ</button>
        <button class="header-settings-btn" onclick="openSettings()">‚öôÔ∏è</button>
    </div>
</div>
<div class="progress-row">
    <div class="progress-bar-container"><div class="progress-fill" id="progressBar"></div></div>
    <div class="progress-text" id="progressText">‚Üí Hustler</div>
</div>
<div class="stats-row">
    <div class="stat-item" title="Passive income per second"><div class="stat-value" id="perSec">$0</div><div class="stat-label">/sec</div></div>
    <div class="stat-item" title="Money earned per click"><div class="stat-value" id="clickVal">$1</div><div class="stat-label">/click</div></div>
    <div class="stat-item" title="Critical hit chance"><div class="stat-value" id="critChance">5%</div><div class="stat-label">‚ö°crit</div></div>
    <div class="stat-item" onclick="switchTab('heist',document.querySelector('[data-tab=heist]'))" title="Police heat - tap for info"><div class="stat-value" id="heatVal">0%</div><div class="stat-label">üöîheat</div></div>
</div>
<div class="click-section">
    <div class="side-panel">
        <div class="side-stat"><span class="val" id="heistBonus">+0%</span><span class="lbl">heist</span></div>
        <div class="side-stat"><span class="val" id="territoryCount">0</span><span class="lbl">turf</span></div>
        <div class="side-stat"><span class="val" id="shieldVal">0%</span><span class="lbl">shield</span></div>
    </div>
    <button class="click-button click-0" id="clickBtn" onclick="clickMoney()">üí∞</button>
    <div class="side-panel">
        <div class="side-stat"><span class="val" id="crewPower">0</span><span class="lbl">crew</span></div>
        <div class="side-stat"><span class="val" id="multVal">x1.0</span><span class="lbl">mult</span></div>
        <div class="side-stat"><span class="val" id="luckVal">0%</span><span class="lbl">luck</span></div>
    </div>
    <div class="event-banner" id="eventBanner" style="display:none">üéâ LUCKY!</div>
</div>
<div class="content-area">
    <div class="tab-content active" id="tab-shop">
        <div class="section-title">üìà Income Sources</div>
        <div class="grid-2col" id="bizList"></div>
        <div class="section-title" style="margin-top:6px">üëÜ Click Power</div>
        <div class="grid-2col" id="clickList"></div>
    </div>
    <div class="tab-content" id="tab-territory">
        <div id="territoryContent"></div>
    </div>
    <div class="tab-content" id="tab-heist">
        <div id="heistContent"></div>
    </div>
    <div class="tab-content" id="tab-crew">
        <div id="crewContent"></div>
    </div>
    <div class="tab-content" id="tab-empire">
        <div id="prestigeSection" style="display:none">
            <div class="section-title">üëë Legacy System</div>
            <div style="background:linear-gradient(135deg,rgba(245,158,11,0.15),rgba(217,119,6,0.15));border:2px solid rgba(251,191,36,0.4);border-radius:8px;padding:15px;margin-bottom:12px">
                <div style="text-align:center;margin-bottom:10px">
                    <div style="font-size:2em">üèùÔ∏è</div>
                    <div style="font-size:1.1em;font-weight:bold;color:#fbbf24;margin:5px 0">Retire to Paradise</div>
                    <div style="font-size:0.75em;color:#94a3b8">Reset for permanent bonuses</div>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin:10px 0">
                    <div style="text-align:center"><div style="font-size:0.65em;color:#64748b">Prestige</div><div style="font-weight:bold;color:#fbbf24" id="prestigeLvlDisplay">0</div></div>
                    <div style="text-align:center"><div style="font-size:0.65em;color:#64748b">Legacy Points</div><div style="font-weight:bold;color:#22c55e" id="lpCount">0</div></div>
                    <div style="text-align:center"><div style="font-size:0.65em;color:#64748b">Next Reward</div><div style="font-weight:bold;color:#4ade80" id="nextLpReward">0 LP</div></div>
                </div>
                <button class="btn btn-gold" onclick="openPrestige()" style="width:100%;padding:10px;font-weight:bold;background:linear-gradient(145deg,#fbbf24,#f59e0b);border:2px solid #ffd700">üèùÔ∏è Retire & Get Bonuses</button>
            </div>
        </div>
        <div class="section-title">üè¶ Secure Storage <span style="font-weight:normal;color:#94a3b8;font-size:0.9em">(Protected from raids!)</span></div>
        <div class="grid-2col" id="storageList"></div>
        <div class="section-title" style="margin-top:6px">‚ö° Special Upgrades</div>
        <div class="grid-2col" id="specialList"></div>
    </div>
</div>
<div class="tab-bar" id="tabBar">
    <button class="tab-btn active" data-tab="shop" onclick="switchTab('shop',this)"><span>üè™</span>Shop</button>
    <button class="tab-btn locked" data-tab="territory" onclick="switchTab('territory',this)"><span>üîí</span><span class="unlock-hint">Rank 4</span></button>
    <button class="tab-btn locked" data-tab="heist" onclick="switchTab('heist',this)"><span>üîí</span><span class="unlock-hint">Rank 2</span></button>
    <button class="tab-btn locked" data-tab="crew" onclick="switchTab('crew',this)"><span>üîí</span><span class="unlock-hint">Rank 1</span></button>
    <button class="tab-btn" data-tab="empire" onclick="switchTab('empire',this)"><span>üèõÔ∏è</span>Empire</button>
</div>

<script>
// === SETTINGS & PERSISTENCE ===
const SAVE_KEY = 'criminalEmpireSave';
const SAVE_VERSION = 2;
let settings = { vibration: true, tips: true, debug: false, sound: true };
let lastSeen = Date.now();
let shownTips = new Set();

// === GAME STATE ===
let money=0,moneyPerSecond=0,clickPower=1,reputation=0,policeHeat=0,heatShield=0,heatDecay=0;
let critChance=0.05,critMult=3,luckChance=0,combo=0,lastClickTime=0,comboTimeout=null;
let storageLocations=[],thieves=[],ownedTerritories=[],globalMult=1,heistBonus=0;
let totalEarned=0,totalClicks=0,totalHeists=0,totalOfflineEarnings=0,achievementsUnlocked=[];
let prestigeLevel=0,legacyPoints=0,lifetimeEarnings=0,prestigeUpgrades=[];
let eventHistory=[],lastEventTime=0,activeEffects={};
let isResetting=false;
let maxThieves=6;

const ranks=[{name:"üî∞ Thug",rep:0},{name:"üíú Hustler",rep:100},{name:"üíô Runner",rep:400},{name:"üíó Boss",rep:1500},{name:"‚ù§Ô∏è Kingpin",rep:6000},{name:"üß° Godfather",rep:25000},{name:"üëë Legend",rep:100000}];
const tierThresholds=[0,5,15,30,50,100];
const tierNames=['üîò','ü•â','ü•à','ü•á','üíé','üåü'];
const MINIGAME_TIER=3;

const bizUpgrades=[
    {name:"Lemonade",icon:"üçã",income:1,baseCost:15,owned:0,mult:1.12,minigame:null,maxOwned:100},
    {name:"Food Cart",icon:"üå≠",income:6,baseCost:120,owned:0,mult:1.12,minigame:null,maxOwned:90},
    {name:"Shop",icon:"üè™",income:30,baseCost:900,owned:0,mult:1.13,minigame:null,maxOwned:80},
    {name:"Restaurant",icon:"üçΩÔ∏è",income:120,baseCost:6000,owned:0,mult:1.13,minigame:null,maxOwned:70},
    {name:"Factory",icon:"üè≠",income:500,baseCost:35000,owned:0,mult:1.14,minigame:'factory',maxOwned:30},
    {name:"Corp",icon:"üè¢",income:2500,baseCost:250000,owned:0,mult:1.14,minigame:null,maxOwned:50},
    {name:"Bank",icon:"üè¶",income:12000,baseCost:2000000,owned:0,mult:1.15,minigame:'safe',maxOwned:30},
    {name:"Casino",icon:"üé∞",income:60000,baseCost:25000000,owned:0,mult:1.16,minigame:'casino',maxOwned:30}
];

const clickUpgrades=[
    {name:"Gloves",icon:"üß§",mult:1.5,baseCost:50,owned:0,costMult:1.4,maxOwned:50},
    {name:"Rings",icon:"üíç",mult:1.5,baseCost:400,owned:0,costMult:1.5,maxOwned:50},
    {name:"Watch",icon:"‚åö",mult:1.8,baseCost:4000,owned:0,costMult:1.6,maxOwned:40},
    {name:"Briefcase",icon:"üíº",mult:2,baseCost:40000,owned:0,costMult:1.65,maxOwned:40},
    {name:"Lambo",icon:"üèéÔ∏è",mult:2,baseCost:400000,owned:0,costMult:1.7,maxOwned:30},
    {name:"Yacht",icon:"üõ•Ô∏è",mult:2.5,baseCost:5000000,owned:0,costMult:1.75,maxOwned:20},
    {name:"Jet",icon:"‚úàÔ∏è",mult:3,baseCost:80000000,owned:0,costMult:1.8,maxOwned:10}
];

const territories=[
    {id:0,name:"Downtown",icon:"üèôÔ∏è",bonus:"income",val:0.1,cost:30000,level:0,maxLvl:5,upCost:60000},
    {id:1,name:"Docks",icon:"‚öì",bonus:"heist",val:0.05,cost:100000,level:0,maxLvl:5,upCost:200000},
    {id:2,name:"Industrial",icon:"üèóÔ∏è",bonus:"click",val:0.1,cost:350000,level:0,maxLvl:5,upCost:700000},
    {id:3,name:"Suburbs",icon:"üè°",bonus:"crit",val:0.02,cost:1200000,level:0,maxLvl:5,upCost:2400000},
    {id:4,name:"Hideout",icon:"üèöÔ∏è",bonus:"crew",val:1,cost:2500000,level:0,maxLvl:5,upCost:5000000},
    {id:5,name:"Airport",icon:"‚úàÔ∏è",bonus:"luck",val:0.01,cost:5000000,level:0,maxLvl:5,upCost:10000000},
    {id:6,name:"Casino District",icon:"üé∞",bonus:"all",val:0.03,cost:20000000,level:0,maxLvl:5,upCost:40000000}
];

const heists=[
    {id:0,name:"üè™ Corner Store",reward:[150,600],chance:0.9,cd:8,diff:"easy",heat:1},
    {id:1,name:"üíé Jewelry",reward:[1500,6000],chance:0.7,cd:15,diff:"medium",heat:3},
    {id:2,name:"üè¶ Bank",reward:[15000,60000],chance:0.5,cd:35,diff:"hard",heat:7},
    {id:3,name:"üé∞ Casino",reward:[150000,600000],chance:0.35,cd:70,diff:"hard",heat:12},
    {id:4,name:"üèõÔ∏è Reserve",reward:[1500000,8000000],chance:0.2,cd:150,diff:"legendary",heat:25}
];
let heistCDs={};

const policeUpgrades=[
    {id:"scanner",name:"üì° Scanner",desc:"-5% heat gain",cost:20000,owned:false,fx:()=>heatShield+=0.05},
    {id:"safehouse",name:"üè† Safehouse",desc:"+1 heat decay/sec",cost:80000,owned:false,fx:()=>heatDecay+=1},
    {id:"insider",name:"üïµÔ∏è Insider",desc:"-10% heat gain",cost:400000,owned:false,fx:()=>heatShield+=0.1},
    {id:"judge",name:"‚öñÔ∏è Judge",desc:"-15% heat gain",cost:1500000,owned:false,fx:()=>heatShield+=0.15},
    {id:"chief",name:"üëÆ Chief",desc:"+3 heat decay/sec",cost:8000000,owned:false,fx:()=>heatDecay+=3}
];

const specialUpgrades=[
    {id:"luck1",name:"üçÄ Lucky Charm",desc:"+2% luck",cost:50000,owned:false,fx:()=>luckChance+=0.02},
    {id:"crit1",name:"‚ö° Sharp Eye",desc:"+3% crit",cost:100000,owned:false,fx:()=>critChance+=0.03},
    {id:"crit2",name:"üí• Crit Master",desc:"+1x crit mult",cost:500000,owned:false,fx:()=>critMult+=1},
    {id:"luck2",name:"üé≤ Gambler",desc:"+3% luck",cost:1000000,owned:false,fx:()=>luckChance+=0.03},
    {id:"crit3",name:"üî• Devastation",desc:"+5% crit +2x",cost:5000000,owned:false,fx:()=>{critChance+=0.05;critMult+=2}},
    {id:"luck3",name:"‚ú® Fortune",desc:"+5% luck",cost:10000000,owned:false,fx:()=>luckChance+=0.05}
];

const storageTypes=[
    {name:"Mattress",icon:"üõèÔ∏è",cost:8000,cap:80000},
    {name:"Safe",icon:"üîê",cost:80000,cap:800000},
    {name:"Vault",icon:"üè¶",cost:800000,cap:15000000},
    {name:"Offshore",icon:"üèùÔ∏è",cost:8000000,cap:300000000}
];

const crewNames=["Shadow","Ghost","Viper","Raven","Wolf","Phantom","Ace","Blaze","Cipher","Duke","Echo","Frost"];
const crewRanks=["Rookie","Skilled","Pro","Elite","Master"];
const crewRankColors=["#6b7280","#22c55e","#3b82f6","#a855f7","#fbbf24"];
const crewTypes=[
    {id:"enforcer",name:"Enforcer",icon:"üí™",color:"#ef4444",bonus:"heist",desc:"+heist success"},
    {id:"hacker",name:"Hacker",icon:"üíª",color:"#3b82f6",bonus:"income",desc:"+passive income"},
    {id:"driver",name:"Driver",icon:"üöó",color:"#f59e0b",bonus:"heat",desc:"-heat generation"},
    {id:"smuggler",name:"Smuggler",icon:"üì¶",color:"#8b5cf6",bonus:"luck",desc:"+luck chance"},
    {id:"insider",name:"Insider",icon:"üé≠",color:"#ec4899",bonus:"cost",desc:"-training cost"}
];

const achievements=[
    {id:'first_click',name:'First Steps',desc:'Click for the first time',check:()=>totalClicks>=1},
    {id:'clicks_100',name:'Clicker',desc:'Click 100 times',check:()=>totalClicks>=100},
    {id:'clicks_1000',name:'Click Master',desc:'Click 1,000 times',check:()=>totalClicks>=1000},
    {id:'earn_1k',name:'Pocket Change',desc:'Earn $1,000 total',check:()=>totalEarned>=1000},
    {id:'earn_1m',name:'Millionaire',desc:'Earn $1,000,000 total',check:()=>totalEarned>=1e6},
    {id:'earn_1b',name:'Billionaire',desc:'Earn $1,000,000,000 total',check:()=>totalEarned>=1e9},
    {id:'first_offline',name:'Passive Income',desc:'Earn money while offline',check:()=>totalOfflineEarnings>=1},
    {id:'first_heist',name:'First Job',desc:'Complete your first heist',check:()=>totalHeists>=1},
    {id:'heist_10',name:'Career Criminal',desc:'Complete 10 heists',check:()=>totalHeists>=10},
    {id:'first_crew',name:'Gang Leader',desc:'Hire your first crew member',check:()=>thieves.length>=1},
    {id:'full_crew',name:'Crime Family',desc:'Hire maximum crew',check:()=>thieves.length>=maxThieves},
    {id:'first_turf',name:'Turf War',desc:'Capture your first territory',check:()=>ownedTerritories.length>=1},
    {id:'all_turf',name:'Kingpin',desc:'Own all territories',check:()=>ownedTerritories.length>=territories.length},
    {id:'rank_max',name:'Legend',desc:'Reach maximum rank',check:()=>getRank()>=6},
    {id:'first_prestige',name:'Retirement',desc:'Prestige for the first time',check:()=>prestigeLevel>=1},
];

const prestigeUpgradesData=[
    {id:'income1',name:'Income Boost I',desc:'+10% all income',cost:1,owned:0,maxOwned:5,bonus:{type:'income',val:0.1}},
    {id:'income2',name:'Income Boost II',desc:'+25% all income',cost:3,owned:0,maxOwned:3,bonus:{type:'income',val:0.25}},
    {id:'click1',name:'Click Power I',desc:'+15% click power',cost:1,owned:0,maxOwned:5,bonus:{type:'click',val:0.15}},
    {id:'click2',name:'Click Power II',desc:'+30% click power',cost:3,owned:0,maxOwned:3,bonus:{type:'click',val:0.3}},
    {id:'offline1',name:'Offline Earnings I',desc:'+20% offline rate',cost:2,owned:0,maxOwned:3,bonus:{type:'offline',val:0.2}},
    {id:'offline2',name:'Offline Earnings II',desc:'+ 2hrs offline cap',cost:4,owned:0,maxOwned:2,bonus:{type:'offlineCap',val:2*3600}},
    {id:'heist1',name:'Heist Master',desc:'+20% heist success',cost:2,owned:0,maxOwned:4,bonus:{type:'heist',val:0.2}},
    {id:'crew1',name:'Crew Capacity',desc:'+2 max crew',cost:3,owned:0,maxOwned:3,bonus:{type:'crewCap',val:2}},
    {id:'start1',name:'Head Start',desc:'Start with $10K',cost:2,owned:0,maxOwned:1,bonus:{type:'startMoney',val:10000}},
    {id:'start2',name:'Quick Start',desc:'Start at rank 2',cost:5,owned:0,maxOwned:1,bonus:{type:'startRank',val:2}},
];

const crewMissions=[
    {id:'pickpocket',name:'Quick Pickpocket',icon:'üëù',duration:300,baseReward:500,rep:10,skillReq:'skill',desc:'Small quick cash'},
    {id:'carboost',name:'Car Boost',icon:'üöó',duration:900,baseReward:2000,rep:25,skillReq:'exp',desc:'Steal a car'},
    {id:'scout',name:'Building Scout',icon:'üîç',duration:1800,effect:'heistCD',effectVal:60,skillReq:'loyalty',desc:'Reduce heist cooldowns'},
    {id:'weapons',name:'Weapons Deal',icon:'üí£',duration:3600,baseReward:15000,rep:100,skillReq:'skill',desc:'Sell contraband'},
    {id:'recruit',name:'Recruit Search',icon:'üîé',duration:7200,effect:'crewSlot',skillReq:'loyalty',desc:'Find new crew member'},
    {id:'training',name:'Training Camp',icon:'ü•ã',duration:14400,effect:'skillUp',skillReq:'exp',desc:'Gain random skill level'},
    {id:'sabotage',name:'Sabotage',icon:'üí•',duration:5400,effect:'heat',effectVal:-20,skillReq:'skill',desc:'Reduce police heat'},
    {id:'intel',name:'Intel Gathering',icon:'üìã',duration:10800,baseReward:50000,rep:200,skillReq:'exp',desc:'Big payout'},
];

const randomEvents=[
    {id:'lucky_break',name:'Lucky Break',icon:'üí∞',desc:'Found a cash stash!',weight:10,minRank:0,
        trigger:()=>{
            const amount=Math.floor((money*0.15+moneyPerSecond*10)*Math.random());
            money+=amount;lifetimeEarnings+=amount;
            return {msg:`+${fmt(amount)}!`,color:'#22c55e'};
        }},
    {id:'informant_tip',name:'Informant Tip',icon:'üïµÔ∏è',desc:'Got insider info on security',weight:8,minRank:2,
        trigger:()=>{
            Object.keys(heistCDs).forEach(k=>heistCDs[k]=Math.max(Date.now(),heistCDs[k]-120000));
            return {msg:'Heist cooldowns -2 minutes',color:'#3b82f6'};
        }},
    {id:'police_raid',name:'Police Raid',icon:'üöî',desc:'Surprise inspection!',weight:6,minRank:1,
        trigger:()=>{
            const stored=getStored();
            const lossPercent=stored>money*0.5?0.05:0.15;
            const loss=Math.floor(money*lossPercent);
            money=Math.max(0,money-loss);
            policeHeat=Math.min(100,policeHeat+15);
            return {msg:`-${fmt(loss)} (storage saved you!)`,color:'#ef4444'};
        }},
    {id:'crew_betrayal',name:'Crew Betrayal',icon:'ü•∑',desc:'Crew member stole from you',weight:5,minRank:1,
        trigger:()=>{
            if(thieves.length===0)return {msg:'No crew to betray you',color:'#94a3b8'};
            const loss=Math.floor(money*0.08);
            money=Math.max(0,money-loss);
            return {msg:`-${fmt(loss)} stolen!`,color:'#ef4444'};
        }},
    {id:'black_market',name:'Black Market Sale',icon:'üè™',desc:'Limited time discount!',weight:7,minRank:0,
        trigger:()=>{
            activeEffects.discount={ends:Date.now()+30000,val:0.5};
            return {msg:'50% off next purchase (30s)',color:'#a855f7'};
        }},
    {id:'rival_gang',name:'Rival Gang',icon:'‚öîÔ∏è',desc:'Enemies demand protection money',weight:6,minRank:4,
        trigger:()=>{
            const amount=Math.floor(moneyPerSecond*30);
            if(money>=amount){
                money-=amount;
                return {msg:`-${fmt(amount)} protection paid`,color:'#f59e0b'};
            }else{
                activeEffects.territoryLock={ends:Date.now()+60000};
                return {msg:'Territories disabled (1min)',color:'#ef4444'};
            }
        }},
    {id:'street_race',name:'Street Race',icon:'üèéÔ∏è',desc:'Risk it for triple reward',weight:5,minRank:0,
        trigger:()=>{
            activeEffects.raceOffer={amount:Math.floor(money*0.1+moneyPerSecond*20)};
            return {msg:'Accept race challenge?',color:'#f59e0b',hasChoice:true};
        }},
    {id:'vip_client',name:'VIP Client',icon:'üíé',desc:'High roller wants service',weight:7,minRank:2,
        trigger:()=>{
            activeEffects.incomeBoost={ends:Date.now()+60000,val:1};
            return {msg:'2x passive income (1min)',color:'#22c55e'};
        }},
    {id:'heat_wave',name:'Heat Wave',icon:'üî•',desc:'Police distracted by riots',weight:6,minRank:2,
        trigger:()=>{
            activeEffects.fastHeists={ends:Date.now()+120000};
            Object.keys(heistCDs).forEach(k=>heistCDs[k]=Math.max(Date.now(),heistCDs[k]-60000));
            return {msg:'Heists cool down faster (2min)',color:'#f59e0b'};
        }},
    {id:'boom',name:'Economic Boom',icon:'üìà',desc:'Market surge!',weight:8,minRank:0,
        trigger:()=>{
            activeEffects.clickBoost={ends:Date.now()+30000,val:1};
            return {msg:'2x click power (30s)',color:'#4ade80'};
        }},
];

// === UTILITIES ===
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function playSound(freq=440,duration=50,type='sine',volume=0.1){
    if(!settings.sound)return;
    try{
        if(audioCtx.state==='suspended')audioCtx.resume();
        const osc=audioCtx.createOscillator();
        const gain=audioCtx.createGain();
        osc.connect(gain);gain.connect(audioCtx.destination);
        osc.frequency.value=freq;osc.type=type;
        gain.gain.setValueAtTime(volume,audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01,audioCtx.currentTime+duration/1000);
        osc.start(audioCtx.currentTime);osc.stop(audioCtx.currentTime+duration/1000);
    }catch(e){console.warn('Audio error',e)}
}
function vib(p){if(settings.vibration&&navigator.vibrate)navigator.vibrate(p)}
function fmt(n){
    if(!isFinite(n)||n<0)return'$0';
    if(n>=1e18)return'$'+(n/1e18).toFixed(2)+'Qi';
    if(n>=1e15)return'$'+(n/1e15).toFixed(2)+'Qa';
    if(n>=1e12)return'$'+(n/1e12).toFixed(2)+'T';
    if(n>=1e9)return'$'+(n/1e9).toFixed(2)+'B';
    if(n>=1e6)return'$'+(n/1e6).toFixed(2)+'M';
    if(n>=1e3)return'$'+(n/1e3).toFixed(1)+'K';
    return'$'+Math.floor(n);
}
function fmtS(n){
    if(!isFinite(n)||n<0)return'0';
    if(n>=1e15)return(n/1e15).toFixed(1)+'Qa';
    if(n>=1e12)return(n/1e12).toFixed(1)+'T';
    if(n>=1e9)return(n/1e9).toFixed(1)+'B';
    if(n>=1e6)return(n/1e6).toFixed(1)+'M';
    if(n>=1e3)return(n/1e3).toFixed(0)+'K';
    return Math.floor(n);
}
function getRank(){for(let i=ranks.length-1;i>=0;i--)if(reputation>=ranks[i].rep)return i;return 0}
function getTier(o){for(let i=tierThresholds.length-1;i>=0;i--)if(o>=tierThresholds[i])return i;return 0}
function getTierProgress(o){const t=getTier(o);if(t>=tierThresholds.length-1)return 100;const c=tierThresholds[t],n=tierThresholds[t+1];return((o-c)/(n-c))*100}
function getStored(){return storageLocations.reduce((t,s)=>t+s.stored,0)}
function getHeatChance(){return Math.min(policeHeat/100,0.45)}
function getCrewPower(){return thieves.reduce((t,c)=>t+c.loyalty+c.skill+c.exp,0)}
function getHeistChance(h){return Math.min(0.95,h.chance+getCrewPower()*0.004+heistBonus)}
function getCrewIncome(c){const ct=crewTypes.find(t=>t.id===(c.type||'enforcer'));const typeMult=ct&&ct.bonus==='income'?1.5:1;return Math.floor((c.baseIncome*(1+c.exp*0.4)+c.skill*40)*globalMult*typeMult)}
function getCrewSteal(c){return Math.max(0.01,0.18-c.loyalty*0.022)}
function getCrewRank(c){const t=c.loyalty+c.skill+c.exp;if(t>=24)return 4;if(t>=15)return 3;if(t>=8)return 2;if(t>=3)return 1;return 0}

// === SAVE/LOAD ===
function saveGame(){
    if(isResetting)return;
    const save={
        v:SAVE_VERSION,ts:Date.now(),
        money,moneyPerSecond,clickPower,reputation,policeHeat,heatShield,heatDecay,
        critChance,critMult,luckChance,totalEarned,totalClicks,totalHeists,totalOfflineEarnings,
        prestigeLevel,legacyPoints,lifetimeEarnings,prestigeUpgrades,eventHistory,lastEventTime,
        bizUpgrades:bizUpgrades.map(b=>b.owned),
        clickUpgrades:clickUpgrades.map(c=>c.owned),
        territories:territories.map(t=>({level:t.level})),
        ownedTerritories,
        policeUpgrades:policeUpgrades.map(p=>p.owned),
        specialUpgrades:specialUpgrades.map(s=>s.owned),
        storageLocations,thieves,heistCDs,
        achievementsUnlocked,shownTips:[...shownTips],settings
    };
    try{localStorage.setItem(SAVE_KEY,JSON.stringify(save))}catch(e){console.warn('Save failed',e)}
}

function loadGame(){
    try{
        const raw=localStorage.getItem(SAVE_KEY);
        if(!raw)return false;
        const save=JSON.parse(raw);
        if(!save.v)return false;
        
        money=save.money||0;moneyPerSecond=save.moneyPerSecond||0;clickPower=save.clickPower||1;
        reputation=save.reputation||0;policeHeat=save.policeHeat||0;heatShield=save.heatShield||0;
        heatDecay=save.heatDecay||0;critChance=save.critChance||0.05;critMult=save.critMult||3;
        luckChance=save.luckChance||0;totalEarned=save.totalEarned||0;totalClicks=save.totalClicks||0;
        totalHeists=save.totalHeists||0;totalOfflineEarnings=save.totalOfflineEarnings||0;
        prestigeLevel=save.prestigeLevel||0;legacyPoints=save.legacyPoints||0;
        lifetimeEarnings=save.lifetimeEarnings||0;prestigeUpgrades=save.prestigeUpgrades||[];
        eventHistory=save.eventHistory||[];lastEventTime=save.lastEventTime||0;
        
        if(save.bizUpgrades)save.bizUpgrades.forEach((o,i)=>{if(bizUpgrades[i])bizUpgrades[i].owned=o});
        if(save.clickUpgrades)save.clickUpgrades.forEach((o,i)=>{if(clickUpgrades[i])clickUpgrades[i].owned=o});
        if(save.territories)save.territories.forEach((t,i)=>{if(territories[i])territories[i].level=t.level});
        ownedTerritories=save.ownedTerritories||[];
        if(save.policeUpgrades)save.policeUpgrades.forEach((o,i)=>{if(policeUpgrades[i])policeUpgrades[i].owned=o});
        if(save.specialUpgrades)save.specialUpgrades.forEach((o,i)=>{if(specialUpgrades[i])specialUpgrades[i].owned=o});
        storageLocations=save.storageLocations||[];
        thieves=save.thieves||[];
        heistCDs=save.heistCDs||{};
        achievementsUnlocked=save.achievementsUnlocked||[];
        shownTips=new Set(save.shownTips||[]);
        if(save.settings)settings={...settings,...save.settings};

        // Restore prestige upgrades
        prestigeUpgrades.forEach(pu=>{
            const upg=prestigeUpgradesData.find(u=>u.id===pu.id);
            if(upg)upg.owned=pu.owned;
        });

        // Process offline time
        const offlineCap=8*3600+getPrestigeBonus('offlineCap');
        const elapsed=Math.min((Date.now()-save.ts)/1000,offlineCap);
        if(elapsed>10&&moneyPerSecond>0){
            calcBonuses();
            const offlineRate=0.5*(1+getPrestigeBonus('offline'));
            const offlineEarn=Math.floor(moneyPerSecond*globalMult*elapsed*offlineRate);
            money+=offlineEarn;totalEarned+=offlineEarn;totalOfflineEarnings+=offlineEarn;lifetimeEarnings+=offlineEarn;

            // Show welcome back modal
            setTimeout(()=>{
                const modal=document.getElementById('welcomeBackModal');
                const hours=Math.floor(elapsed/3600);
                const mins=Math.floor((elapsed%3600)/60);
                const timeStr=hours>0?`${hours}h ${mins}m`:`${mins}m`;
                const hourlyRate=Math.floor((moneyPerSecond*globalMult*3600*offlineRate));

                document.getElementById('wbEarnings').textContent=`+${fmt(offlineEarn)}`;
                document.getElementById('wbTime').textContent=timeStr;
                document.getElementById('wbRate').textContent=`${fmt(hourlyRate)}/hr`;
                document.getElementById('wbEmoji').textContent=elapsed>3600*4?'üò¥':elapsed>1800?'üí§':'üëã';

                modal.classList.add('active');
                playSound(600,200,'sine',0.15);
                checkAchievements();
            },500);
        }
        // Reduce heist cooldowns by elapsed time
        const now=Date.now();
        Object.keys(heistCDs).forEach(k=>{heistCDs[k]=Math.max(now,heistCDs[k]-elapsed*1000)});
        
        lastSeen=Date.now();
        return true;
    }catch(e){console.warn('Load failed',e);return false}
}

function exportSave(){
    saveGame();
    const data=localStorage.getItem(SAVE_KEY);
    navigator.clipboard.writeText(data).then(()=>showNotif('üì§ Copied!','income','Save data copied to clipboard')).catch(()=>alert(data));
}

function importSave(){
    const data=prompt('Paste save data:');
    if(data){try{JSON.parse(data);localStorage.setItem(SAVE_KEY,data);location.reload()}catch(e){alert('Invalid save data')}}
}

function hardReset(){
    if(confirm('‚ö†Ô∏è Delete ALL progress and reset the game? This cannot be undone!')){
        isResetting=true;
        try{
            localStorage.clear();
            sessionStorage.clear();
            if(caches){caches.keys().then(names=>{names.forEach(name=>caches.delete(name))})}
            setTimeout(()=>{
                window.location.href = window.location.href.split('?')[0] + '?reset=' + Date.now();
            },100);
        }catch(e){
            console.error('Reset error:',e);
            localStorage.clear();
            sessionStorage.clear();
            window.location.reload(true);
        }
    }
}

// === ACHIEVEMENTS ===
function openAchievements(){
    playSound(650,80,'triangle',0.1);
    document.getElementById('achievementsModal').classList.add('active');
    renderAchievements();
}
function closeAchievements(){document.getElementById('achievementsModal').classList.remove('active')}
function closeWelcomeBack(){document.getElementById('welcomeBackModal').classList.remove('active')}
function closePrestige(){document.getElementById('prestigeModal').classList.remove('active')}
function closePrestigeShop(){document.getElementById('prestigeShopModal').classList.remove('active')}
function closeEvent(){document.getElementById('eventModal').classList.remove('active');currentEvent=null}

let currentEvent=null;
function triggerRandomEvent(){
    const now=Date.now();
    if(now-lastEventTime<120000)return; // Min 2 min between events
    if(Math.random()>0.3)return; // 30% chance per check

    const rank=getRank();
    const availableEvents=randomEvents.filter(e=>rank>=e.minRank);
    if(availableEvents.length===0)return;

    const totalWeight=availableEvents.reduce((sum,e)=>sum+e.weight,0);
    let roll=Math.random()*totalWeight;
    let event=availableEvents[0];
    for(const e of availableEvents){
        roll-=e.weight;
        if(roll<=0){event=e;break}
    }

    lastEventTime=now;
    currentEvent=event;
    showEvent(event);
}

function showEvent(event){
    const result=event.trigger();

    document.getElementById('eventTitle').textContent=`‚ö° ${event.name}`;
    document.getElementById('eventIcon').textContent=event.icon;
    document.getElementById('eventName').textContent=event.name;
    document.getElementById('eventDesc').textContent=event.desc;
    document.getElementById('eventResult').textContent=result.msg;
    document.getElementById('eventResult').style.color=result.color||'#fbbf24';

    const header=document.getElementById('eventHeader');
    header.style.background=result.color?`linear-gradient(135deg,${result.color},${result.color}dd)`:'linear-gradient(135deg,#f59e0b,#d97706)';

    if(result.hasChoice&&activeEffects.raceOffer){
        document.getElementById('eventActions').style.display='block';
        document.getElementById('eventContinue').style.display='none';
    }else{
        document.getElementById('eventActions').style.display='none';
        document.getElementById('eventContinue').style.display='block';
    }

    eventHistory.push({id:event.id,time:Date.now(),result:result.msg});
    if(eventHistory.length>20)eventHistory.shift();

    document.getElementById('eventModal').classList.add('active');
    playSound(1000,200,'triangle',0.2);
    vib([30,30,30]);
    checkAchievements();
    updateAll();
}

function acceptEventChoice(){
    if(activeEffects.raceOffer){
        const bet=activeEffects.raceOffer.amount;
        if(money>=bet){
            money-=bet;
            if(Math.random()<0.33){
                const win=bet*3;
                money+=win;lifetimeEarnings+=win;
                document.getElementById('eventResult').textContent=`Won ${fmt(win)}!`;
                document.getElementById('eventResult').style.color='#22c55e';
                playSound(1200,300,'square',0.2);
            }else{
                document.getElementById('eventResult').textContent=`Lost ${fmt(bet)}`;
                document.getElementById('eventResult').style.color='#ef4444';
                playSound(400,200,'sawtooth',0.15);
            }
        }
        delete activeEffects.raceOffer;
    }
    document.getElementById('eventActions').style.display='none';
    document.getElementById('eventContinue').style.display='block';
    updateAll();
}

function declineEventChoice(){
    delete activeEffects.raceOffer;
    document.getElementById('eventResult').textContent='Challenge declined';
    document.getElementById('eventResult').style.color='#94a3b8';
    document.getElementById('eventActions').style.display='none';
    document.getElementById('eventContinue').style.display='block';
}

function calculateLegacyPoints(){
    return Math.floor(Math.pow(lifetimeEarnings/1e7,0.5));
}

function openPrestige(){
    const lp=calculateLegacyPoints();
    if(lp===0){playSound(300,100,'sawtooth',0.1);showNotif('‚ö†Ô∏è Not Ready','event','Need more lifetime earnings to prestige');return}
    playSound(750,120,'square',0.12);
    document.getElementById('currentPrestige').textContent=prestigeLevel;
    document.getElementById('currentLegacy').textContent=legacyPoints+' LP';
    document.getElementById('prestigeReward').textContent=`+${lp} LP`;
    document.getElementById('lifetimeDisplay').textContent=fmt(lifetimeEarnings);
    document.getElementById('prestigeModal').classList.add('active');
}

function confirmPrestige(){
    const lp=calculateLegacyPoints();
    if(lp===0)return;
    if(!confirm('Are you sure? This will reset ALL progress except achievements and Legacy Points!'))return;

    // Award Legacy Points
    prestigeLevel++;
    legacyPoints+=lp;

    // Reset everything except prestige data and achievements
    money=0;moneyPerSecond=0;clickPower=1;reputation=0;policeHeat=0;heatShield=0;heatDecay=0;
    critChance=0.05;critMult=3;luckChance=0;totalEarned=0;totalClicks=0;totalHeists=0;totalOfflineEarnings=0;
    bizUpgrades.forEach(b=>b.owned=0);
    clickUpgrades.forEach(c=>c.owned=0);
    territories.forEach(t=>t.level=0);
    ownedTerritories=[];
    policeUpgrades.forEach(p=>p.owned=false);
    specialUpgrades.forEach(s=>s.owned=false);
    storageLocations=[];
    thieves=[];
    heistCDs={};
    shownTips=new Set();

    // Apply prestige bonuses
    applyPrestigeBonuses();

    closePrestige();
    saveGame();
    calcBonuses();
    updateAll();
    checkAchievements();
    showNotif('üëë RETIRED!','prestige',`+${lp} Legacy Points earned!`);
    playSound(1200,400,'square',0.2);
    vib([50,50,50,50,100]);
}

function applyPrestigeBonuses(){
    // Apply start bonuses
    const startMoney=prestigeUpgrades.find(u=>u.id==='start1');
    if(startMoney&&startMoney.owned>0)money+=startMoney.bonus.val*startMoney.owned;

    const startRank=prestigeUpgrades.find(u=>u.id==='start2');
    if(startRank&&startRank.owned>0){
        reputation=ranks[startRank.bonus.val]?.rep||0;
    }
}

function getPrestigeBonus(type){
    let bonus=0;
    prestigeUpgrades.filter(u=>u.bonus.type===type&&u.owned>0).forEach(u=>{
        bonus+=u.bonus.val*u.owned;
    });
    return bonus;
}

function openPrestigeShop(){
    document.getElementById('lpDisplay').textContent=legacyPoints+' LP';
    renderPrestigeUpgrades();
    document.getElementById('prestigeShopModal').classList.add('active');
}

function renderPrestigeUpgrades(){
    document.getElementById('prestigeUpgradesList').innerHTML=prestigeUpgradesData.map((u,i)=>{
        const cost=u.cost*Math.pow(1.5,u.owned);
        const canBuy=legacyPoints>=cost&&u.owned<u.maxOwned;
        const maxed=u.owned>=u.maxOwned;
        return `<div class="upgrade-card ${canBuy?'affordable':''} ${maxed?'maxed':''}">
            <div class="upgrade-header"><span class="upgrade-name">${u.name}</span><span style="font-size:0.65em;color:#94a3b8">${u.owned}/${u.maxOwned}</span></div>
            <div style="font-size:0.75em;color:#94a3b8;margin:4px 0">${u.desc}</div>
            <div class="upgrade-meta"><span style="color:#fbbf24">${u.bonus.type}</span><b style="color:#fbbf24">${Math.floor(cost)} LP</b></div>
            <button class="upgrade-btn" onclick="buyPrestigeUpgrade(${i})" ${canBuy?'':'disabled'}>${maxed?'‚úì MAX':'Buy'}</button>
        </div>`;
    }).join('');
}

function buyPrestigeUpgrade(idx){
    const u=prestigeUpgradesData[idx];
    const cost=u.cost*Math.pow(1.5,u.owned);
    if(legacyPoints>=cost&&u.owned<u.maxOwned){
        legacyPoints-=cost;
        u.owned++;
        // Copy to persistent array
        const existing=prestigeUpgrades.find(p=>p.id===u.id);
        if(existing)existing.owned=u.owned;
        else prestigeUpgrades.push({id:u.id,owned:u.owned});

        saveGame();
        renderPrestigeUpgrades();
        document.getElementById('lpDisplay').textContent=legacyPoints+' LP';
        updateAll();
        playSound(800,150,'triangle',0.15);
        vib([15,30,15]);
    }
}
function getAchievementProgress(a){
    if(a.id==='clicks_100')return Math.min(100,Math.floor((totalClicks/100)*100));
    if(a.id==='clicks_1000')return Math.min(100,Math.floor((totalClicks/1000)*100));
    if(a.id==='earn_1k')return Math.min(100,Math.floor((totalEarned/1000)*100));
    if(a.id==='earn_1m')return Math.min(100,Math.floor((totalEarned/1e6)*100));
    if(a.id==='earn_1b')return Math.min(100,Math.floor((totalEarned/1e9)*100));
    if(a.id==='heist_10')return Math.min(100,Math.floor((totalHeists/10)*100));
    if(a.id==='full_crew')return Math.min(100,Math.floor((thieves.length/maxThieves)*100));
    if(a.id==='all_turf')return Math.min(100,Math.floor((ownedTerritories.length/territories.length)*100));
    return 0;
}
function renderAchievements(){
    const unlocked=achievementsUnlocked.length;
    document.getElementById('achievementCount').textContent=`${unlocked}/${achievements.length}`;
    document.getElementById('achievementsList').innerHTML=achievements.map(a=>{
        const isUnlocked=achievementsUnlocked.includes(a.id);
        const progress=isUnlocked?100:getAchievementProgress(a);
        const showProgress=!isUnlocked&&progress>0;
        return `<div class="achievement-card ${isUnlocked?'':'locked'}">
            <div class="achievement-icon">${isUnlocked?'üèÜ':'üîí'}</div>
            <div class="achievement-info">
                <div class="achievement-name">${a.name}</div>
                <div class="achievement-desc">${a.desc}</div>
                ${showProgress?`<div class="achievement-progress">${progress}% complete</div>`:''}
            </div>
            ${isUnlocked?'<div class="achievement-checkmark">‚úì</div>':''}
        </div>`;
    }).join('');
}

// === SETTINGS ===
function openSettings(){playSound(500,50,'sine',0.08);document.getElementById('settingsModal').classList.add('active');updateSettingsUI()}
function closeSettings(){playSound(400,50,'sine',0.08);document.getElementById('settingsModal').classList.remove('active')}
function toggleSetting(key){
    settings[key]=!settings[key];
    if(key==='debug')document.getElementById('debugBtns').style.display=settings.debug?'flex':'none';
    updateSettingsUI();saveGame();
}
function updateSettingsUI(){
    document.getElementById('toggleSound').className='toggle'+(settings.sound?' on':'');
    document.getElementById('toggleVib').className='toggle'+(settings.vibration?' on':'');
    document.getElementById('toggleTips').className='toggle'+(settings.tips?' on':'');
    document.getElementById('toggleDebug').className='toggle'+(settings.debug?' on':'');
}

// === NOTIFICATIONS & TIPS ===
function showNotif(msg,type,sub=''){
    document.querySelectorAll('.notification').forEach(n=>n.remove());
    const n=document.createElement('div');n.className='notification '+type;
    n.innerHTML=msg+(sub?`<small>${sub}</small>`:'');n.onclick=()=>n.remove();
    document.body.appendChild(n);setTimeout(()=>n.remove(),2500);
}

function showTip(id,msg){
    if(!settings.tips||shownTips.has(id))return;
    shownTips.add(id);saveGame();
    setTimeout(()=>showNotif('üí° Tip',msg,'tip'),1000);
}

// === ACHIEVEMENTS ===
function checkAchievements(){
    achievements.forEach(a=>{
        if(!achievementsUnlocked.includes(a.id)&&a.check()){
            achievementsUnlocked.push(a.id);
            vib([50,30,50,30,100]);
            showNotif('üèÜ '+a.name,'achievement',a.desc);
        }
    });
}

// === CORE GAME ===
function calcBonuses(){
    globalMult=1;heistBonus=0;heatShield=0;let clickB=0,critB=0,luckB=0;maxThieves=6;

    // Apply prestige bonuses
    globalMult+=getPrestigeBonus('income');
    clickB+=getPrestigeBonus('click');
    heistBonus+=getPrestigeBonus('heist');
    maxThieves+=getPrestigeBonus('crewCap');

    ownedTerritories.forEach(tid=>{
        const t=territories.find(x=>x.id===tid);if(!t)return;
        const v=t.val*(1+t.level*0.6);
        if(t.bonus==='income')globalMult+=v;
        else if(t.bonus==='heist')heistBonus+=v;
        else if(t.bonus==='click')clickB+=v;
        else if(t.bonus==='crit')critB+=v;
        else if(t.bonus==='luck')luckB+=v;
        else if(t.bonus==='crew')maxThieves+=Math.floor(v);
        else if(t.bonus==='all'){globalMult+=v;heistBonus+=v;clickB+=v;critB+=v;luckB+=v}
    });
    thieves.forEach(c=>{
        const ct=crewTypes.find(t=>t.id===(c.type||'enforcer'));if(!ct)return;
        const rankMult=1+getCrewRank(c)*0.1;
        if(ct.bonus==='heist')heistBonus+=0.02*rankMult;
        else if(ct.bonus==='income')globalMult+=0.015*rankMult;
        else if(ct.bonus==='heat')heatShield+=0.03*rankMult;
        else if(ct.bonus==='luck')luckB+=0.01*rankMult;
    });
    let baseCrit=0.05,baseLuck=0;
    specialUpgrades.forEach(u=>{if(u.owned){if(u.id.includes('crit'))baseCrit+=u.id==='crit1'?0.03:u.id==='crit3'?0.05:0;if(u.id.includes('luck'))baseLuck+=u.id==='luck1'?0.02:u.id==='luck2'?0.03:0.05}});
    policeUpgrades.forEach(u=>{if(u.owned)u.fx()});
    critChance=baseCrit+critB;luckChance=baseLuck+luckB;
}

function switchTab(tab,btn){
    const rank=getRank();
    const unlocks={territory:4,heist:2,crew:1};
    if(unlocks[tab]&&rank<unlocks[tab])return;
    vib(5);
    document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    document.getElementById('tab-'+tab).classList.add('active');
    btn.classList.add('active');
}

function clickMoney(event){
    vib(8);totalClicks++;
    const now=Date.now();
    if(now-lastClickTime<400){combo=Math.min(combo+1,20)}else{combo=Math.max(1,combo-1)}
    lastClickTime=now;clearTimeout(comboTimeout);comboTimeout=setTimeout(()=>{combo=0;updateAll()},1500);

    const isCrit=Math.random()<critChance;const comboMult=1+combo*0.05;
    const clickMultiplier=(activeEffects.clickBoost?1+activeEffects.clickBoost.val:1);
    let earned=Math.floor(clickPower*(1+getPrestigeBonus('click'))*comboMult*(isCrit?critMult:1)*clickMultiplier);
    if(isCrit){vib([15,20,15]);playSound(800,100,'square',0.15)}
    else{playSound(600,50,'sine',0.1)}
    money+=earned;totalEarned+=earned;lifetimeEarnings+=earned;reputation+=Math.ceil(earned/800);
    policeHeat=Math.min(100,policeHeat+0.08*(1-heatShield));

    if(Math.random()<luckChance){
        const bonus=Math.floor(money*0.1+clickPower*10);money+=bonus;totalEarned+=bonus;lifetimeEarnings+=bonus;
        playSound(1200,200,'triangle',0.2);
        document.getElementById('eventBanner').style.display='block';
        document.getElementById('eventBanner').textContent=`üéâ +${fmt(bonus)}`;
        setTimeout(()=>document.getElementById('eventBanner').style.display='none',1500);
    }

    checkAchievements();updateAll();

    const e=document.createElement('div');e.className='click-effect '+(isCrit?'crit':'normal');
    e.textContent=(isCrit?'üí•':'+')+fmt(earned);
    const offsetX=(Math.random()-0.5)*30;
    e.style.left=`calc(50% + ${offsetX}px)`;
    e.style.top='-60px';
    e.style.transform='translateX(-50%)';
    document.getElementById('clickBtn').appendChild(e);setTimeout(()=>e.remove(),isCrit?600:500);
}

// Raids on timer instead of per-click
function checkRaid(){
    if(Math.random()<getHeatChance()*0.1){
        vib([150,80,150,80,150]);
        playSound(300,400,'sawtooth',0.25);
        const loss=Math.floor(money*(0.08+Math.random()*0.15));
        money=Math.max(0,money-loss);policeHeat=Math.max(0,policeHeat-25);
        if(loss>0){
            showNotif('üöî RAID!','police',`-${fmt(loss)} cash seized!`);
            document.body.style.animation='raidFlash 0.5s';
            setTimeout(()=>document.body.style.animation='',500);
        }
        updateAll();
    }
}

function attemptHeist(id){
    if(heistCDs[id]>Date.now())return;
    const h=heists[id];const chance=getHeistChance(h);
    policeHeat=Math.min(100,policeHeat+h.heat*(1-heatShield));totalHeists++;
    if(Math.random()<chance){
        vib([25,40,25,40,25,40,80]);
        const reward=h.reward[0]+Math.floor(Math.random()*(h.reward[1]-h.reward[0]));
        money+=reward;totalEarned+=reward;lifetimeEarnings+=reward;reputation+=Math.ceil(reward/400);
        showNotif('üéØ SUCCESS!','heist-win',`+${fmt(reward)}`);
    }else{
        vib([80,40,80]);policeHeat=Math.min(100,policeHeat+h.heat);
        showNotif('üíÄ FAILED!','heist-fail','Increase crew power!');
    }
    heistCDs[id]=Date.now()+h.cd*1000;checkAchievements();updateAll();
}

function addPurchaseFeedback(selector){
    const el=document.querySelector(selector);
    if(el){el.classList.add('just-purchased');setTimeout(()=>el.classList.remove('just-purchased'),500)}
}
function buyBiz(i){const u=bizUpgrades[i];let cost=Math.floor(u.baseCost*Math.pow(u.mult,u.owned));if(activeEffects.discount){cost=Math.floor(cost*(1-activeEffects.discount.val));delete activeEffects.discount}if(money>=cost&&u.owned<u.maxOwned){money-=cost;u.owned++;moneyPerSecond+=u.income;reputation+=Math.ceil(cost/800);vib([15,25,15]);playSound(700,80,'triangle',0.12);checkAchievements();updateAll();setTimeout(()=>addPurchaseFeedback(`#bizList .upgrade-card:nth-child(${i+1})`),10)}}
function buyClick(i){const u=clickUpgrades[i];let cost=Math.floor(u.baseCost*Math.pow(u.costMult,u.owned));if(activeEffects.discount){cost=Math.floor(cost*(1-activeEffects.discount.val));delete activeEffects.discount}if(money>=cost&&u.owned<u.maxOwned){money-=cost;u.owned++;clickPower=Math.floor(clickPower*u.mult);reputation+=Math.ceil(cost/400);vib([15,25,15]);playSound(700,80,'triangle',0.12);updateAll();setTimeout(()=>addPurchaseFeedback(`#clickList .upgrade-card:nth-child(${i+1})`),10)}}
function buyTerritory(id){if(activeEffects.territoryLock){showNotif('‚öîÔ∏è Locked','event','Territories under attack!');return}const t=territories.find(x=>x.id===id);if(!t||ownedTerritories.includes(id)||money<t.cost)return;money-=t.cost;ownedTerritories.push(id);reputation+=Math.ceil(t.cost/150);vib([25,40,25,40,30]);playSound(900,120,'square',0.15);calcBonuses();showNotif('üó∫Ô∏è CAPTURED!','event',t.icon+' '+t.name);checkAchievements();updateAll();setTimeout(()=>addPurchaseFeedback(`.territory-card:nth-child(${id+1})`),10)}
function upgradeTerritory(id){if(activeEffects.territoryLock){showNotif('‚öîÔ∏è Locked','event','Territories under attack!');return}const t=territories.find(x=>x.id===id);if(!t||!ownedTerritories.includes(id)||t.level>=t.maxLvl)return;const cost=t.upCost*Math.pow(2,t.level);if(money>=cost){money-=cost;t.level++;reputation+=Math.ceil(cost/80);vib([25,40,25,40,30]);calcBonuses();updateAll()}}
function buyPolice(id){const u=policeUpgrades.find(x=>x.id===id);if(!u||u.owned||money<u.cost)return;money-=u.cost;u.owned=true;u.fx();reputation+=Math.ceil(u.cost/400);vib([25,40,25,40,30]);updateAll()}
function buySpecial(id){const u=specialUpgrades.find(x=>x.id===id);if(!u||u.owned||money<u.cost)return;money-=u.cost;u.owned=true;u.fx();reputation+=Math.ceil(u.cost/300);vib([25,40,25,40,30]);calcBonuses();updateAll()}
function buyStorage(i){const s=storageTypes[i];if(money>=s.cost&&!storageLocations.find(x=>x.name===s.name)){money-=s.cost;storageLocations.push({...s,stored:0,id:Date.now()});vib([15,25,15]);updateAll()}}
function deposit(id,amt){const s=storageLocations.find(x=>x.id===id);if(s){const mx=Math.min(amt,money,s.cap-s.stored);if(mx>0){money-=mx;s.stored+=mx;updateAll()}}}
function withdraw(id){const s=storageLocations.find(x=>x.id===id);if(s?.stored>0){money+=s.stored;s.stored=0;updateAll()}}
function hireThief(crewTypeId){const cost=10000*Math.pow(2.3,thieves.length);if(money>=cost&&thieves.length<maxThieves){money-=cost;const crewType=crewTypes.find(t=>t.id===crewTypeId)||crewTypes[0];thieves.push({id:Date.now(),name:crewNames[thieves.length%crewNames.length],type:crewType.id,baseIncome:180+Math.floor(Math.random()*250),loyalty:0,skill:0,exp:0});vib([25,40,25,40,80,40,60]);playSound(650,100,'triangle',0.15);setTimeout(()=>playSound(850,100,'sine',0.12),100);setTimeout(()=>playSound(1050,150,'triangle',0.18),200);const btn=event.target.closest('button');if(btn){btn.style.animation='hireSuccess 0.5s';setTimeout(()=>btn.style.animation='',500)}showTip('crew_hired',`Hired ${crewType.name}! ${crewType.desc}`);checkAchievements();updateAll()}}
function trainCrew(id,attr){const c=thieves.find(x=>x.id===id);if(!c||c[attr]>=10)return;const costs={loyalty:2500,skill:7000,exp:4500};const cost=Math.floor(costs[attr]*Math.pow(1.9,c[attr]));if(money>=cost){money-=cost;c[attr]++;reputation+=8;vib([15,25,15]);playSound(550,80,'sine',0.1);updateAll()}}
function fireCrew(id){if(confirm('Fire this crew member?')){playSound(250,150,'sawtooth',0.12);thieves=thieves.filter(c=>c.id!==id);updateAll()}}

function processCrew(){
    thieves.forEach(c=>{
        const stealChance=getCrewSteal(c);
        if(Math.random()<stealChance){
            const stolen=Math.floor(money*0.04*Math.random());
            money=Math.max(0,money-stolen);
            if(stolen>100)showNotif(`ü•∑ ${c.name} stole!`,'theft',`-${fmt(stolen)}`);
        }else{
            const income=getCrewIncome(c);money+=income;totalEarned+=income;
        }
    });
}

function checkRankUp(){
    const newRank=getRank();const oldRank=parseInt(document.body.className.match(/rank-(\d)/)?.[1]||0);
    if(newRank>oldRank){
        document.body.className=`rank-${newRank}`;vib([40,80,40,80,80,40,150]);
        showNotif('üéñÔ∏è RANK UP!','rank-up',ranks[newRank].name);
        if(newRank===1)showTip('crew_unlock','Crew tab unlocked! Hire members for passive income.');
        if(newRank===2)showTip('heist_unlock','Heists unlocked! High risk, high reward.');
        if(newRank===4)showTip('turf_unlock','Territories unlocked! Control turf for bonuses.');
        checkAchievements();
    }
}

function updateTabs(){
    const rank=getRank();
    [{tab:'crew',icon:'ü•∑',name:'Crew',unlock:1},{tab:'heist',icon:'üéØ',name:'Heist',unlock:2},{tab:'territory',icon:'üó∫Ô∏è',name:'Turf',unlock:4}].forEach(t=>{
        const btn=document.querySelector(`[data-tab="${t.tab}"]`);
        if(rank>=t.unlock){btn.innerHTML=`<span>${t.icon}</span>${t.name}`;btn.classList.remove('locked')}
        else{btn.innerHTML=`<span>üîí</span><span class="unlock-hint">Rank ${t.unlock}</span>`;btn.classList.add('locked')}
    });
}

function updateAll(){
    checkRankUp();calcBonuses();updateTabs();
    const rank=getRank();const total=money+getStored();

    // Update prestige UI
    const prestigeAvailable=rank>=6||totalEarned>=1e8;
    const prestigeSection=document.getElementById('prestigeSection');
    if(prestigeSection)prestigeSection.style.display=prestigeAvailable?'block':'none';
    if(prestigeAvailable){
        const nextLP=calculateLegacyPoints();
        document.getElementById('prestigeLvlDisplay').textContent=prestigeLevel;
        document.getElementById('lpCount').textContent=legacyPoints+' LP';
        document.getElementById('nextLpReward').textContent=nextLP+' LP';
    }
    const lpBtn=document.getElementById('lpBtn');
    if(lpBtn){
        lpBtn.style.display=prestigeLevel>0?'inline-block':'none';
        document.getElementById('lpBadge').textContent=legacyPoints;
    }

    document.getElementById('money').innerHTML=`${fmt(total)} <span class="money-label">Net Worth</span>`;
    document.getElementById('onHand').textContent=fmt(money);
    document.getElementById('stored').textContent=fmt(getStored());
    document.getElementById('rankBadge').textContent=ranks[rank].name;
    document.getElementById('rankBadge').className=`rank-badge rank-${rank}-badge`;
    
    const comboBadge=document.getElementById('comboBadge');
    if(combo>1){comboBadge.style.display='inline';comboBadge.textContent=`x${(1+combo*0.05).toFixed(2)}`}else{comboBadge.style.display='none'}
    
    const nextRank=ranks[rank+1];
    if(nextRank){const pct=Math.min(100,((reputation-ranks[rank].rep)/(nextRank.rep-ranks[rank].rep))*100);document.getElementById('progressBar').style.width=pct+'%';document.getElementById('progressText').textContent=`${pct.toFixed(0)}% ‚Üí ${nextRank.name}`}
    else{document.getElementById('progressBar').style.width='100%';document.getElementById('progressText').textContent='üëë MAX RANK'}
    
    const effIncome=Math.floor(moneyPerSecond*globalMult);
    document.getElementById('perSec').textContent=fmt(effIncome);
    document.getElementById('clickVal').textContent=fmt(clickPower);
    document.getElementById('critChance').textContent=(critChance*100).toFixed(0)+'%';
    document.getElementById('heatVal').textContent=Math.floor(policeHeat)+'%';
    document.getElementById('heistBonus').textContent='+'+Math.floor(heistBonus*100)+'%';
    document.getElementById('territoryCount').textContent=ownedTerritories.length;
    document.getElementById('shieldVal').textContent=Math.floor(heatShield*100)+'%';
    document.getElementById('crewPower').textContent=getCrewPower();
    document.getElementById('multVal').textContent='x'+globalMult.toFixed(2);
    document.getElementById('luckVal').textContent=(luckChance*100).toFixed(0)+'%';
    document.getElementById('clickBtn').className=`click-button click-${Math.min(rank,6)}`;
    
    // Biz upgrades
    document.getElementById('bizList').innerHTML=bizUpgrades.map((u,i)=>{
        const cost=Math.floor(u.baseCost*Math.pow(u.mult,u.owned));const can=money>=cost&&u.owned<u.maxOwned;
        const tier=getTier(u.owned),prog=getTierProgress(u.owned);
        const hasMinigame=u.minigame&&tier>=MINIGAME_TIER;
        const atMax=u.owned>=u.maxOwned;
        const pipsPer=Math.ceil(u.maxOwned/5);const pipsOwned=Math.min(5,Math.floor(u.owned/pipsPer));
        const currentPipProgress=((u.owned%pipsPer)/pipsPer)*100;
        return `<div class="upgrade-card ${can?'affordable':''} ${atMax?'maxed':''}">
            <div class="upgrade-header"><span class="upgrade-name">${u.icon} ${u.name}</span><span style="font-size:0.65em;color:#94a3b8">${u.owned}/${u.maxOwned}</span></div>
            <div class="territory-pips">${Array(5).fill(0).map((_,j)=>{
                if(j<pipsOwned)return `<div class="territory-pip filled"></div>`;
                if(j===pipsOwned&&!atMax)return `<div class="territory-pip" style="background:linear-gradient(90deg,#22c55e ${currentPipProgress}%,rgba(255,255,255,0.2) ${currentPipProgress}%)"></div>`;
                return `<div class="territory-pip"></div>`;
            }).join('')}</div>
            <div class="upgrade-meta"><span>+$${u.income}/s</span><b style="color:#fbbf24">$${fmtS(cost)}</b></div>
            ${hasMinigame?`<button class="upgrade-btn minigame-btn" onclick="openMiniGame('${u.minigame}')">üéÆ PLAY</button>`:`<button class="upgrade-btn" onclick="buyBiz(${i})" ${can&&!atMax?'':'disabled'}>${atMax?'‚úì MAX':(u.minigame&&tier<MINIGAME_TIER?`Buy (üéÆ@${tierNames[MINIGAME_TIER]})`:'Buy')}</button>`}
        </div>`;
    }).join('');
    
    // Click upgrades
    document.getElementById('clickList').innerHTML=clickUpgrades.map((u,i)=>{
        const cost=Math.floor(u.baseCost*Math.pow(u.costMult,u.owned));const can=money>=cost&&u.owned<u.maxOwned;
        const atMax=u.owned>=u.maxOwned;
        const pipsPer=Math.ceil(u.maxOwned/5);const pipsOwned=Math.min(5,Math.floor(u.owned/pipsPer));
        const currentPipProgress=((u.owned%pipsPer)/pipsPer)*100;
        return `<div class="upgrade-card ${can?'affordable':''} ${atMax?'maxed':''}"><div class="upgrade-header"><span class="upgrade-name">${u.icon} ${u.name}</span><span style="font-size:0.65em;color:#94a3b8">${u.owned}/${u.maxOwned}</span></div><div class="territory-pips">${Array(5).fill(0).map((_,j)=>{
            if(j<pipsOwned)return `<div class="territory-pip filled"></div>`;
            if(j===pipsOwned&&!atMax)return `<div class="territory-pip" style="background:linear-gradient(90deg,#22c55e ${currentPipProgress}%,rgba(255,255,255,0.2) ${currentPipProgress}%)"></div>`;
            return `<div class="territory-pip"></div>`;
        }).join('')}</div><div class="upgrade-meta"><span>x${u.mult}</span><b style="color:#fbbf24">$${fmtS(cost)}</b></div><button class="upgrade-btn" onclick="buyClick(${i})" ${can&&!atMax?'':'disabled'}>${atMax?'‚úì MAX':'Buy'}</button></div>`;
    }).join('');
    
    // Territory content
    const territoryUnlocked=rank>=4;
    document.getElementById('territoryContent').innerHTML=territoryUnlocked?`
        <div class="section-title">üó∫Ô∏è Territories <span style="font-weight:normal;color:#94a3b8">(${ownedTerritories.length}/${territories.length})</span></div>
        <div class="grid-2col">${territories.map(t=>{
            const owned=ownedTerritories.includes(t.id);const can=money>=t.cost;const upCost=t.upCost*Math.pow(2,t.level);const canUp=owned&&t.level<t.maxLvl&&money>=upCost;
            const bonusMap={income:'üìà Income',click:'üëÜ Click',heist:'üéØ Heist',crit:'‚ö° Crit',luck:'üçÄ Luck',crew:'ü•∑ Crew',all:'‚ú® All'};
            const currVal=(t.val*(1+t.level*0.6)*100).toFixed(0);
            const crewSlots=Math.floor(t.val*(1+t.level*0.6));
            const bonusText=t.bonus==='crew'?`+${crewSlots} slots`:`+${currVal}% ${bonusMap[t.bonus]}`;
            const imgName=t.name==='Casino District'?'Casino':t.name==='Hideout'?'Industrial':t.name;
            const bgImage=`assets/${imgName}.PNG`;
            return `<div class="territory-card ${owned?'owned':''}" style="background-image:url('${bgImage}')"><div class="upgrade-header"><span class="upgrade-name">${t.icon} ${t.name}</span><span style="font-size:0.6em;color:#4ade80">${bonusText}</span></div><div class="territory-pips">${Array(t.maxLvl).fill(0).map((_,j)=>`<div class="territory-pip ${j<t.level?'filled':''}"></div>`).join('')}</div>${owned?(t.level>=t.maxLvl?'':`<button class="btn btn-green" style="width:100%" onclick="upgradeTerritory(${t.id})" ${canUp?'':'disabled'}>‚¨Ü ${fmtS(upCost)}</button>`):`<button class="btn btn-blue" style="width:100%" onclick="buyTerritory(${t.id})" ${can?'':'disabled'}>üéØ ${fmtS(t.cost)}</button>`}</div>`;
        }).join('')}</div>
    `:`<div class="locked-content"><div class="lock-icon">üîí</div><h3>Territories</h3><p>Reach Rank 4 (‚ù§Ô∏è Kingpin) to unlock territory control and earn passive bonuses!</p></div>`;
    
    // Heist content
    const heistUnlocked=rank>=2;
    const now=Date.now();
    document.getElementById('heistContent').innerHTML=heistUnlocked?`
        <div class="heat-info-panel">
            <h4>üöî Police Heat System</h4>
            <p>Current Heat: <b>${Math.floor(policeHeat)}%</b> ‚Üí Raid chance: <b>${(getHeatChance()*10).toFixed(1)}%</b>/sec</p>
            <p>Heat Decay: <b>${(0.4+heatDecay).toFixed(1)}</b>/sec ‚Ä¢ Shield: <b>${Math.floor(heatShield*100)}%</b> reduction</p>
            <p style="font-size:0.9em;margin-top:4px">üí° Raids only take <b>cash on hand</b> - money in storage is safe!</p>
        </div>
        <div class="section-title">üéØ Heists</div>
        <div class="grid-2col">${heists.map(h=>{
            const cd=heistCDs[h.id]||0,onCd=cd>now,cdLeft=onCd?Math.ceil((cd-now)/1000):0;const chance=getHeistChance(h);
            return `<div class="heist-card ${onCd?'on-cooldown':''}"><span class="heist-difficulty ${h.diff}">${h.diff}</span><div class="heist-name">${h.name}</div><div class="heist-info">${fmt(h.reward[0])}-${fmt(h.reward[1])} ‚Ä¢ +${h.heat} heat</div><div class="heist-bar"><div class="heist-bar-fill" style="width:${chance*100}%"></div></div><button class="btn btn-purple" style="width:100%" onclick="attemptHeist(${h.id})" ${onCd?'disabled':''}>${onCd?`‚è± ${cdLeft}s`:`${(chance*100).toFixed(0)}% Success`}</button></div>`;
        }).join('')}</div>
        <div class="section-title" style="margin-top:8px">üõ°Ô∏è Heat Reduction</div>
        <div class="grid-2col">${policeUpgrades.map(u=>`<div class="police-card ${u.owned?'owned':''}"><div class="upgrade-header"><span class="upgrade-name">${u.name}</span><span style="font-size:0.6em;color:${u.owned?'#22c55e':'#fbbf24'}">${u.owned?'‚úì Owned':fmtS(u.cost)}</span></div><div style="font-size:0.6em;color:#94a3b8">${u.desc}</div>${!u.owned?`<button class="btn btn-blue" style="width:100%;margin-top:4px" onclick="buyPolice('${u.id}')" ${money>=u.cost?'':'disabled'}>Buy</button>`:''}</div>`).join('')}</div>
    `:`<div class="locked-content"><div class="lock-icon">üîí</div><h3>Heists</h3><p>Reach Rank 2 (üíô Runner) to unlock heists and big scores!</p></div>`;
    
    // Crew content
    const crewUnlocked=rank>=1;
    const crewCost=10000*Math.pow(2.3,thieves.length);
    document.getElementById('crewContent').innerHTML=crewUnlocked?`
        <div class="section-title">ü•∑ Your Crew <span style="font-weight:normal;color:#94a3b8">(${thieves.length}/${maxThieves})</span></div>
        ${thieves.length>=maxThieves?`<div style="text-align:center;padding:10px;font-size:0.8em;color:#22c55e;font-weight:bold">‚úì MAX CREW CAPACITY</div>`:`<div style="margin-bottom:8px"><div style="font-size:0.7em;color:#94a3b8;margin-bottom:4px;text-align:center">Hire ${fmt(crewCost)} - Choose Type:</div><div class="grid-2col" style="gap:4px">${crewTypes.map(ct=>`<button class="btn btn-purple" onclick="hireThief('${ct.id}')" style="padding:6px;font-size:0.7em;display:flex;flex-direction:column;align-items:center;gap:2px" ${money<crewCost?'disabled':''}><span style="font-size:1.3em">${ct.icon}</span><span style="font-weight:bold;color:${ct.color}">${ct.name}</span><span style="font-size:0.85em;color:#94a3b8">${ct.desc}</span></button>`).join('')}</div></div>`}
        <div style="font-size:0.6em;color:#94a3b8;margin-bottom:8px;padding:6px;background:rgba(0,0,0,0.2);border-radius:4px">
            üí° Crew earns money every 5 seconds but may steal from your cash! Train <b>Loyalty</b> to reduce theft risk.
        </div>
        <div class="grid-2col">${thieves.length?thieves.map(c=>{
            const r=getCrewRank(c);const ct=crewTypes.find(t=>t.id===(c.type||'enforcer'))||crewTypes[0];
            const costMult=(ct.id==='insider'?0.7:1);
            const lc=Math.floor(2500*Math.pow(1.9,c.loyalty)*costMult),sc=Math.floor(7000*Math.pow(1.9,c.skill)*costMult),ec=Math.floor(4500*Math.pow(1.9,c.exp)*costMult);
            const crewImgName=`${c.name.toLowerCase()}_${c.type}`;
            const bgImage=`assets/crew_${crewImgName}.png`;
            const isNew=Date.now()-c.id<1000;
            return `<div class="thief-card" style="background-image:url('${bgImage}');${isNew?'animation:crewAppear 0.6s ease-out;':''}">
                <div class="thief-card-header">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                        <span style="font-weight:bold;font-size:0.95em;text-shadow:0 2px 4px rgba(0,0,0,0.9)">${ct.icon} ${c.name}<span class="thief-rank-badge" style="background:${crewRankColors[r]}">${crewRanks[r]}</span></span>
                        <button class="btn btn-red" style="padding:3px 7px;font-size:0.75em" onclick="fireCrew(${c.id})">‚úï</button>
                    </div>
                    <div style="font-size:0.7em;color:${ct.color};font-weight:bold;text-shadow:0 2px 4px rgba(0,0,0,0.9)">${ct.name} - ${ct.desc}</div>
                </div>
                <div class="thief-stats">
                    <div class="thief-stat">
                        <div class="thief-stat-icon">üí∞</div>
                        <div class="thief-stat-info">
                            <div class="thief-stat-label">Income/5s</div>
                            <div class="thief-stat-value">${fmt(getCrewIncome(c))}</div>
                        </div>
                    </div>
                    <div class="thief-stat">
                        <div class="thief-stat-icon">‚ö†Ô∏è</div>
                        <div class="thief-stat-info">
                            <div class="thief-stat-label">Theft Risk</div>
                            <div class="thief-stat-value" style="color:#ef4444">${(getCrewSteal(c)*100).toFixed(0)}%</div>
                        </div>
                    </div>
                </div>
                <div class="train-grid">
                    <button class="train-btn" onclick="trainCrew(${c.id},'loyalty')" ${money<lc||c.loyalty>=10?'disabled':''}>
                        <div>üõ°Ô∏è ${c.loyalty}/10</div>
                        <div class="train-btn-label">Loyalty<br>${fmtS(lc)}</div>
                    </button>
                    <button class="train-btn" onclick="trainCrew(${c.id},'skill')" ${money<sc||c.skill>=10?'disabled':''}>
                        <div>‚ö° ${c.skill}/10</div>
                        <div class="train-btn-label">Skill<br>${fmtS(sc)}</div>
                    </button>
                    <button class="train-btn" onclick="trainCrew(${c.id},'exp')" ${money<ec||c.exp>=10?'disabled':''}>
                        <div>üìà ${c.exp}/10</div>
                        <div class="train-btn-label">Experience<br>${fmtS(ec)}</div>
                    </button>
                </div>
            </div>`;
        }).join(''):'<div class="empty-state">No crew members yet.<br>Hire your first crew member above!</div>'}</div>
    `:`<div class="locked-content"><div class="lock-icon">üîí</div><h3>Crew</h3><p>Reach Rank 1 (üíú Hustler) to hire crew members for passive income!</p></div>`;
    
    // Storage & Specials
    const allStorage=[...storageLocations.map(s=>({...s,owned:true})),...storageTypes.filter(s=>!storageLocations.find(x=>x.name===s.name)).map((s,i)=>({...s,owned:false,idx:storageTypes.indexOf(s)}))];
    document.getElementById('storageList').innerHTML=allStorage.map(s=>{
        if(s.owned){const pct=s.stored/s.cap*100;return `<div class="storage-card"><div style="display:flex;justify-content:space-between;font-weight:bold">${s.icon} ${s.name}<span style="font-size:0.9em">${fmtS(s.stored)}/${fmtS(s.cap)}</span></div><div class="storage-bar"><div class="storage-fill" style="width:${pct}%"></div></div><div class="storage-btns"><button class="btn btn-gold" onclick="deposit(${s.id},100000)" ${money<100000||s.stored>=s.cap?'disabled':''}>+100K</button><button class="btn btn-gold" onclick="deposit(${s.id},money)" ${money===0||s.stored>=s.cap?'disabled':''}>All</button><button class="btn btn-gold" onclick="withdraw(${s.id})" ${s.stored===0?'disabled':''}>Take</button></div></div>`}
        return `<div class="upgrade-card ${money>=s.cost?'affordable':''}"><div class="upgrade-header"><span class="upgrade-name">${s.icon} ${s.name}</span></div><div class="upgrade-meta"><span>Holds ${fmtS(s.cap)}</span><b>${fmtS(s.cost)}</b></div><button class="upgrade-btn" onclick="buyStorage(${s.idx})" ${money>=s.cost?'':'disabled'}>Buy</button></div>`;
    }).join('');
    
    document.getElementById('specialList').innerHTML=specialUpgrades.map(u=>`<div class="upgrade-card ${u.owned?'maxed':(money>=u.cost?'affordable':'')}"><div class="upgrade-header"><span class="upgrade-name">${u.name}</span><span style="font-size:0.6em;color:${u.owned?'#ffd700':'#fbbf24'}">${u.owned?'‚úì':fmtS(u.cost)}</span></div><div style="font-size:0.6em;color:#94a3b8">${u.desc}</div>${!u.owned?`<button class="upgrade-btn" onclick="buySpecial('${u.id}')" ${money>=u.cost?'':'disabled'}>Buy</button>`:''}</div>`).join('');
}

// === MINIGAMES ===
function closeMiniGame(){document.getElementById('mgOverlay').classList.remove('active')}
function openMiniGame(type){
    document.getElementById('mgOverlay').classList.add('active');
    const c=document.getElementById('mgContainer');
    if(type==='casino')renderCasino(c);
    else if(type==='safe')renderSafe(c);
    else if(type==='factory')renderFactory(c);
}

// CASINO HUB
let casinoGame='slots';
function renderCasino(c){
    c.innerHTML=`<button class="mg-close" onclick="closeMiniGame()">‚úï</button>
        <div class="mg-title">üé∞ CASINO üé∞</div>
        <div class="mg-balance">Cash: <span id="casinoBal">${fmt(money)}</span></div>
        <div class="slot-select">
            <button class="slot-select-btn ${casinoGame==='slots'?'active':''}" onclick="casinoGame='slots';renderCasino(document.getElementById('mgContainer'))"><span class="icon">üé∞</span><span class="name">Slots</span></button>
            <button class="slot-select-btn ${casinoGame==='dice'?'active':''}" onclick="casinoGame='dice';renderCasino(document.getElementById('mgContainer'))"><span class="icon">üé≤</span><span class="name">Dice</span></button>
            <button class="slot-select-btn ${casinoGame==='roulette'?'active':''}" onclick="casinoGame='roulette';renderCasino(document.getElementById('mgContainer'))"><span class="icon">üéØ</span><span class="name">Roulette</span></button>
        </div>
        <div id="casinoGameArea"></div>`;
    if(casinoGame==='slots')renderSlots(document.getElementById('casinoGameArea'));
    else if(casinoGame==='dice')renderDice(document.getElementById('casinoGameArea'));
    else if(casinoGame==='roulette')renderRoulette(document.getElementById('casinoGameArea'));
}

// SLOTS
let slotBet=1000,slotSpinning=false,slotBonusSpins=0,slotType='classic';
const slotSymbols=['üçí','üçã','üîî','üíé','7Ô∏è‚É£','üé∞'];
const slotPayouts={'üçíüçíüçí':3,'üçãüçãüçã':5,'üîîüîîüîî':10,'üíéüíéüíé':25,'7Ô∏è‚É£7Ô∏è‚É£7Ô∏è‚É£':50,'üé∞üé∞üé∞':100};
const megaSymbols=['üí∞','üíé','üîî','‚≠ê','üëë','7Ô∏è‚É£','üÉè'];
const megaValues={'üí∞':1,'üíé':2,'üîî':3,'‚≠ê':5,'üëë':8,'7Ô∏è‚É£':15,'üÉè':0};
let megaMultiplier=1,megaReels=[];

function renderSlots(c){
    c.innerHTML=`<div class="slot-select" style="margin-top:6px;grid-template-columns:1fr 1fr">
            <button class="slot-select-btn ${slotType==='classic'?'active':''}" onclick="slotType='classic';renderSlots(document.getElementById('casinoGameArea'))"><span class="icon">üé∞</span><span class="name">Classic</span></button>
            <button class="slot-select-btn ${slotType==='mega'?'active':''}" onclick="slotType='mega';renderSlots(document.getElementById('casinoGameArea'))"><span class="icon">üíé</span><span class="name">Megaways</span></button>
        </div>
        <div id="slotGameArea"></div>`;
    if(slotType==='classic')renderClassicSlots();else renderMegaways();
}

function renderClassicSlots(){
    const area=document.getElementById('slotGameArea');
    const ext=[...slotSymbols,...slotSymbols,...slotSymbols];
    area.innerHTML=`<div class="slot-machine">
        <div class="slot-reels">${[0,1,2].map(i=>`<div class="slot-reel" id="reel${i}"><div class="reel-strip" id="strip${i}">${ext.map(s=>`<div class="reel-symbol">${s}</div>`).join('')}</div></div>`).join('')}</div>
        <div class="slot-controls">
            <div class="slot-bet-row"><button id="betDown" onclick="adjustSlotBet(-1000)">‚àí</button><div class="slot-bet">Bet: <b id="slotBetAmt">${fmt(slotBet)}</b></div><button id="betUp" onclick="adjustSlotBet(1000)">+</button></div>
            <button class="slot-spin-btn" id="slotSpinBtn" onclick="spinClassicSlots()">üé≤ SPIN üé≤</button>
            <button class="slot-bonus-btn" id="bonusBtn" onclick="buyClassicBonus()">üí´ Buy 5 Bonus (95% Win!) - ${fmt(slotBet*8)}</button>
            <div class="slot-result" id="slotResult"></div>
            <div id="bonusInfo" style="text-align:center;color:#ffd700;font-size:0.8em;display:${slotBonusSpins>0?'block':'none'}">‚ú® BONUS: <span id="bonusCount">${slotBonusSpins}</span> spins (95% win!)</div>
        </div>
        <div class="slot-paytable"><div>üçíx3=3x</div><div>üçãx3=5x</div><div>üîîx3=10x</div><div>üíéx3=25x</div><div>7Ô∏è‚É£x3=50x</div><div>üé∞x3=100x</div></div>
    </div>`;
}

function adjustSlotBet(amt){if(slotSpinning)return;slotBet=Math.max(100,Math.min(money,slotBet+amt));const el=document.getElementById('slotBetAmt');if(el)el.textContent=fmt(slotBet)}
function buyClassicBonus(){if(slotSpinning)return;const cost=slotBet*8;if(money>=cost){money-=cost;slotBonusSpins+=5;updateSlotUI();updateAll();saveGame()}}

function spinClassicSlots(){
    if(slotSpinning)return;
    const isBonus=slotBonusSpins>0;
    if(!isBonus){if(money<slotBet)return;money-=slotBet}else{slotBonusSpins--}
    slotSpinning=true;updateAll();updateSlotUI();
    document.getElementById('slotResult').textContent='';document.getElementById('slotResult').className='slot-result';
    
    let results;
    if(isBonus&&Math.random()<0.95){const w=slotSymbols[Math.floor(Math.random()*slotSymbols.length)];results=[w,w,w]}
    else{results=[0,1,2].map(()=>slotSymbols[Math.floor(Math.random()*slotSymbols.length)])}
    
    const strips=[0,1,2].map(i=>document.getElementById('strip'+i));
    const symbolH=80,totalSyms=slotSymbols.length*3;
    
    strips.forEach((strip,i)=>{
        const targetIdx=slotSymbols.indexOf(results[i])+slotSymbols.length;
        const spins=3+i;const finalY=-(targetIdx*symbolH);
        let currentY=0,speed=40+i*5,decel=0.97;const totalDist=spins*totalSyms*symbolH+Math.abs(finalY);let travelled=0;
        const spin=()=>{
            travelled+=speed;currentY-=speed;
            if(currentY<-totalSyms*symbolH)currentY+=totalSyms*symbolH;
            strip.style.transform=`translateY(${currentY}px)`;
            if(travelled<totalDist*0.7)requestAnimationFrame(spin);
            else{speed*=decel;if(speed>2)requestAnimationFrame(spin);else{strip.style.transform=`translateY(${finalY}px)`;if(i===2)finishClassicSpin(results)}}
        };
        setTimeout(spin,i*150);
    });
}

function finishClassicSpin(results){
    slotSpinning=false;
    const combo=results.join('');const payout=slotPayouts[combo];
    const el=document.getElementById('slotResult');
    if(payout){
        const win=slotBet*payout;money+=win;totalEarned+=win;
        if(payout>=50){el.textContent=`üéâ JACKPOT! +${fmt(win)} üéâ`;el.className='slot-result jackpot';vib([100,50,100,50,100,50,200])}
        else{el.textContent=`WIN! +${fmt(win)}`;el.className='slot-result win';vib([50,30,50])}
    }else if(results[0]===results[1]||results[1]===results[2]){
        const win=Math.floor(slotBet*0.5);money+=win;totalEarned+=win;el.textContent=`Close! +${fmt(win)}`;el.className='slot-result win'
    }else{el.textContent='Try again!';el.className='slot-result lose'}
    updateSlotUI();updateAll();saveGame();
}

function renderMegaways(){
    megaMultiplier=1;megaReels=[];
    for(let i=0;i<6;i++){const count=Math.floor(Math.random()*6)+2;megaReels.push(Array(count).fill(0).map(()=>megaSymbols[Math.floor(Math.random()*megaSymbols.length)]))}
    const ways=megaReels.reduce((a,r)=>a*r.length,1);
    const area=document.getElementById('slotGameArea');
    area.innerHTML=`<div class="slot-machine">
        <div class="mega-info"><span class="ways">Ways: <b id="megaWays">${ways.toLocaleString()}</b></span><span class="mult">Multiplier: <b id="megaMult">x${megaMultiplier}</b></span></div>
        <div class="mega-reels" id="megaReelsContainer">${megaReels.map((reel,ri)=>`<div class="mega-reel">${reel.map((s,si)=>`<div class="mega-symbol" data-r="${ri}" data-s="${si}">${s}</div>`).join('')}</div>`).join('')}</div>
        <div class="mega-cascade-info" id="cascadeInfo"></div>
        <div class="slot-controls">
            <div class="slot-bet-row"><button id="betDown" onclick="adjustSlotBet(-1000)">‚àí</button><div class="slot-bet">Bet: <b id="slotBetAmt">${fmt(slotBet)}</b></div><button id="betUp" onclick="adjustSlotBet(1000)">+</button></div>
            <button class="slot-spin-btn" id="slotSpinBtn" onclick="spinMegaways()">üé≤ SPIN üé≤</button>
            <button class="slot-bonus-btn" id="bonusBtn" onclick="buyMegaBonus()">üí´ Bonus (5 spins, x4 start) - ${fmt(slotBet*12)}</button>
            <div class="slot-result" id="slotResult"></div>
            <div id="bonusInfo" style="text-align:center;color:#ffd700;font-size:0.8em;display:${slotBonusSpins>0?'block':'none'}">‚ú® BONUS: <span id="bonusCount">${slotBonusSpins}</span></div>
        </div>
        <div style="font-size:0.6em;color:#94a3b8;text-align:center;margin-top:6px">Match 3+ adjacent ‚Ä¢ Cascades increase multiplier ‚Ä¢ üÉè=Wild</div>
    </div>`;
}

function buyMegaBonus(){if(slotSpinning)return;const cost=slotBet*12;if(money>=cost){money-=cost;slotBonusSpins+=5;megaMultiplier=4;updateSlotUI();updateAll();saveGame();renderMegaways()}}

function spinMegaways(){
    if(slotSpinning)return;
    const isBonus=slotBonusSpins>0;
    if(!isBonus){if(money<slotBet)return;money-=slotBet;megaMultiplier=1}else{slotBonusSpins--;if(megaMultiplier<4)megaMultiplier=4}
    slotSpinning=true;updateAll();updateSlotUI();
    
    for(let i=0;i<6;i++){const count=Math.floor(Math.random()*6)+2;megaReels[i]=Array(count).fill(0).map(()=>megaSymbols[Math.floor(Math.random()*megaSymbols.length)])}
    document.getElementById('megaReelsContainer').innerHTML=megaReels.map((reel,ri)=>`<div class="mega-reel">${reel.map((s,si)=>`<div class="mega-symbol cascade" data-r="${ri}" data-s="${si}">${s}</div>`).join('')}</div>`).join('');
    document.getElementById('megaWays').textContent=megaReels.reduce((a,r)=>a*r.length,1).toLocaleString();
    document.getElementById('megaMult').textContent='x'+megaMultiplier;
    document.getElementById('slotResult').textContent='';document.getElementById('slotResult').className='slot-result';
    document.getElementById('cascadeInfo').textContent='';
    
    setTimeout(()=>{document.querySelectorAll('.mega-symbol').forEach(s=>s.classList.remove('cascade'));checkMegaWins(0)},400);
}

function checkMegaWins(cascadeNum){
    const wins=findMegaWins();
    if(wins.length===0){slotSpinning=false;if(cascadeNum===0){document.getElementById('slotResult').textContent='No wins';document.getElementById('slotResult').className='slot-result lose'}updateSlotUI();updateAll();saveGame();return}
    
    let totalWin=0;
    wins.forEach(w=>{
        w.positions.forEach(p=>{const el=document.querySelector(`[data-r="${p.r}"][data-s="${p.s}"]`);if(el)el.classList.add('winning')});
        totalWin+=Math.floor(slotBet*(megaValues[w.symbol]||1)*w.count*0.5*megaMultiplier);
    });
    
    money+=totalWin;totalEarned+=totalWin;
    document.getElementById('slotResult').textContent=`+${fmt(totalWin)}`;document.getElementById('slotResult').className='slot-result win';
    document.getElementById('cascadeInfo').textContent=`Cascade #${cascadeNum+1} ‚Ä¢ x${megaMultiplier}`;
    if(totalWin>slotBet*10)vib([50,30,50]);
    updateSlotUI();updateAll();
    
    setTimeout(()=>{
        wins.forEach(w=>{w.positions.forEach(p=>{if(megaReels[p.r])megaReels[p.r][p.s]=null})});
        megaReels=megaReels.map(reel=>{const rem=reel.filter(s=>s!==null);const need=reel.length-rem.length;return[...Array(need).fill(0).map(()=>megaSymbols[Math.floor(Math.random()*megaSymbols.length)]),...rem]});
        megaMultiplier++;
        document.getElementById('megaMult').textContent='x'+megaMultiplier;
        document.getElementById('megaReelsContainer').innerHTML=megaReels.map((reel,ri)=>`<div class="mega-reel">${reel.map((s,si)=>`<div class="mega-symbol cascade" data-r="${ri}" data-s="${si}">${s}</div>`).join('')}</div>`).join('');
        updateSlotUI();
        setTimeout(()=>{document.querySelectorAll('.mega-symbol').forEach(s=>s.classList.remove('cascade'));checkMegaWins(cascadeNum+1)},400);
    },600);
}

function findMegaWins(){
    const wins=[],checked=new Set();
    for(let r=0;r<megaReels.length-2;r++){
        for(let s=0;s<megaReels[r].length;s++){
            const sym=megaReels[r][s];if(sym==='üÉè')continue;
            const chain=[{r,s}];
            for(let nr=r+1;nr<megaReels.length;nr++){
                const next=[];for(let ns=0;ns<megaReels[nr].length;ns++){if(megaReels[nr][ns]===sym||megaReels[nr][ns]==='üÉè')next.push({r:nr,s:ns})}
                if(next.length===0)break;chain.push(...next);
            }
            if(chain.length>=3){const key=chain.map(p=>`${p.r}-${p.s}`).sort().join('|');if(!checked.has(key)){checked.add(key);wins.push({symbol:sym,count:chain.length,positions:chain})}}
        }
    }
    return wins;
}

function updateSlotUI(){
    const bal=document.getElementById('casinoBal');if(bal)bal.textContent=fmt(money);
    const btn=document.getElementById('slotSpinBtn');if(btn)btn.disabled=slotSpinning||money<slotBet;
    ['betUp','betDown','bonusBtn'].forEach(id=>{const el=document.getElementById(id);if(el)el.disabled=slotSpinning});
    const bi=document.getElementById('bonusInfo');if(bi){bi.style.display=slotBonusSpins>0?'block':'none';const bc=document.getElementById('bonusCount');if(bc)bc.textContent=slotBonusSpins}
}

// SAFE CRACKER
let safeCombo=[],safeTarget=[],safePointer=0,safeIdx=0,safeBet=5000;
function renderSafe(c){
    safeBet=Math.min(money,Math.max(1000,Math.floor(money*0.01)));
    safeTarget=[Math.floor(Math.random()*100),Math.floor(Math.random()*100),Math.floor(Math.random()*100)];
    safeCombo=[];safeIdx=0;safePointer=0;
    const markers=[0,25,50,75].map(n=>`<div class="safe-marker" style="transform: rotate(${n*3.6}deg)"><span style="transform: rotate(-${n*3.6}deg)">${n}</span></div>`).join('');
    c.innerHTML=`<button class="mg-close" onclick="closeMiniGame()">‚úï</button>
        <div class="mg-title">üîê VAULT CRACKER üîê</div>
        <div class="mg-balance">Cash: <span id="safeBal">${fmt(money)}</span></div>
        <div class="safe-game">
            <div class="safe-info">Crack the 3-number combo! Bet: <b style="color:#4ade80">${fmt(safeBet)}</b> ‚Üí Win: <b style="color:#ffd700">${fmt(safeBet*10)}</b></div>
            <div style="position:relative;display:flex;flex-direction:column;align-items:center">
                <div class="safe-dial">${markers}<div class="safe-pointer" id="safePointer"></div></div>
                <div style="margin-top:8px;font-size:1.2em;font-weight:bold;color:#fbbf24">Current: <span id="safeCurrentNum">0</span></div>
            </div>
            <div class="safe-combo"><div class="safe-combo-num active" id="sc0">?</div><div class="safe-combo-num" id="sc1">?</div><div class="safe-combo-num" id="sc2">?</div></div>
            <div class="safe-controls"><button onclick="turnSafe(-5)">‚ü≤ -5</button><button onclick="turnSafe(-1)">‚ü≤ -1</button><button onclick="turnSafe(1)">+1 ‚ü≥</button><button onclick="turnSafe(5)">+5 ‚ü≥</button></div>
            <button class="safe-submit" onclick="submitSafe()">üîì TRY</button>
            <div class="slot-result" id="safeResult"></div>
            <div style="margin-top:6px;font-size:0.65em;color:#64748b">Turn the dial to set numbers 0-99. Get within ¬±5 of target!</div>
        </div>`;
    document.getElementById('safePointer').style.transform=`translateX(-50%) rotate(${(safePointer/100)*360}deg)`;
}
function turnSafe(amt){safePointer=(safePointer+amt+100)%100;document.getElementById('safePointer').style.transform=`translateX(-50%) rotate(${(safePointer/100)*360}deg)`;const numEl=document.getElementById('safeCurrentNum');if(numEl)numEl.textContent=safePointer}
function submitSafe(){
    if(safeIdx>=3)return;
    const target=safeTarget[safeIdx];const diff=Math.abs(safePointer-target);const correct=diff<=5||diff>=95;
    const el=document.getElementById('sc'+safeIdx);el.textContent=safePointer;el.classList.remove('active');el.classList.add(correct?'correct':'wrong');
    safeCombo.push({val:safePointer,correct});
    if(!correct){document.getElementById('safeResult').textContent=safePointer<target?'‚Üë Higher':'‚Üì Lower';document.getElementById('safeResult').className='slot-result lose';money-=Math.floor(safeBet/3);vib([80]);updateAll()}
    safeIdx++;
    if(safeIdx<3){document.getElementById('sc'+safeIdx).classList.add('active');if(correct){document.getElementById('safeResult').textContent='‚úì Click!';document.getElementById('safeResult').className='slot-result win'}}
    else{
        const wins=safeCombo.filter(x=>x.correct).length;const res=document.getElementById('safeResult');
        if(wins===3){const win=safeBet*10;money+=win;totalEarned+=win;res.textContent=`üéâ CRACKED! +${fmt(win)}`;res.className='slot-result jackpot';vib([100,50,100,50,200])}
        else if(wins===2){const win=safeBet*2;money+=win;totalEarned+=win;res.textContent=`Close! 2/3 +${fmt(win)}`;res.className='slot-result win';vib([50,30])}
        else{res.textContent='Vault secured!';res.className='slot-result lose'}
        updateAll();saveGame();setTimeout(()=>{if(document.getElementById('mgOverlay').classList.contains('active'))renderSafe(document.getElementById('mgContainer'))},2500);
    }
    document.getElementById('safeBal').textContent=fmt(money);
}

// DICE GAME
let diceBet=1000,diceChoice=null,diceRolling=false;
const diceOpts=[{id:'low',name:'Low 2-6',payout:2},{id:'mid',name:'Mid 7',payout:4},{id:'high',name:'High 8-12',payout:2},{id:'doubles',name:'Doubles',payout:5},{id:'snake',name:'Snake Eyes',payout:30},{id:'boxcars',name:'Boxcars',payout:30}];
function getDiceFace(num){
    const dots={
        1:['c'],
        2:['a','e'],
        3:['a','c','e'],
        4:['a','b','d','e'],
        5:['a','b','c','d','e'],
        6:['a','b','c','d','e','c']
    };
    const positions={a:'grid-area:a',b:'grid-area:b',c:'grid-area:c',d:'grid-area:d',e:'grid-area:e'};
    if(num===6)return '<div class="dice-dot" style="grid-area:a"></div><div class="dice-dot" style="grid-area:c"></div><div class="dice-dot" style="grid-area:b"></div><div class="dice-dot" style="grid-area:d"></div><div class="dice-dot" style="grid-area:c"></div><div class="dice-dot" style="grid-area:e"></div>';
    return dots[num].map(p=>`<div class="dice-dot" style="${positions[p]}"></div>`).join('');
}
function renderDice(c){
    c.innerHTML=`<div class="dice-game" style="margin-top:8px">
            <div class="dice-container" style="margin:15px 0"><div class="dice" id="dice1">${getDiceFace(1)}</div><div class="dice" id="dice2">${getDiceFace(1)}</div></div>
            <div class="slot-bet-row" style="margin:10px 0"><button onclick="diceBet=Math.max(100,diceBet-1000);document.getElementById('diceBetAmt').textContent=fmt(diceBet)">‚àí</button><div class="slot-bet">Bet: <b id="diceBetAmt">${fmt(diceBet)}</b></div><button onclick="diceBet=Math.min(money,diceBet+1000);document.getElementById('diceBetAmt').textContent=fmt(diceBet)">+</button></div>
            <div style="font-size:0.75em;color:#94a3b8;margin-bottom:8px;font-weight:bold">Choose your bet:</div>
            <div class="dice-bet-options">${diceOpts.map(o=>`<div class="dice-bet-opt" data-id="${o.id}" onclick="diceChoice='${o.id}';document.querySelectorAll('.dice-bet-opt').forEach(x=>x.classList.remove('selected'));this.classList.add('selected');document.getElementById('diceRollBtn').disabled=false"><div style="font-weight:bold;margin-bottom:2px">${o.name}</div><div class="payout">${o.payout}x payout</div></div>`).join('')}</div>
            <button class="dice-roll-btn" id="diceRollBtn" onclick="rollDice()" disabled>üé≤ ROLL DICE üé≤</button>
            <div class="slot-result" id="diceResult"></div>
        </div>`;
    diceChoice=null;
}
function rollDice(){
    if(diceRolling||!diceChoice||money<diceBet)return;
    money-=diceBet;diceRolling=true;updateAll();
    document.querySelectorAll('.dice').forEach(d=>d.classList.add('rolling'));
    document.getElementById('diceResult').textContent='';document.getElementById('diceResult').className='slot-result';
    const d1=Math.floor(Math.random()*6)+1,d2=Math.floor(Math.random()*6)+1,total=d1+d2;
    setTimeout(()=>{document.getElementById('dice1').innerHTML=getDiceFace(d1);document.getElementById('dice1').classList.remove('rolling')},400);
    setTimeout(()=>{
        document.getElementById('dice2').innerHTML=getDiceFace(d2);document.getElementById('dice2').classList.remove('rolling');
        diceRolling=false;
        let win=0;const opt=diceOpts.find(o=>o.id===diceChoice);
        if((diceChoice==='low'&&total<=6)||(diceChoice==='mid'&&total===7)||(diceChoice==='high'&&total>=8)||(diceChoice==='doubles'&&d1===d2)||(diceChoice==='snake'&&d1===1&&d2===1)||(diceChoice==='boxcars'&&d1===6&&d2===6))win=diceBet*opt.payout;
        const res=document.getElementById('diceResult');res.textContent=`Rolled: ${total}`;
        if(win>0){money+=win;totalEarned+=win;res.textContent+=` ‚Üí WIN! +${fmt(win)}`;res.className='slot-result '+(opt.payout>=10?'jackpot':'win');vib(opt.payout>=10?[100,50,100,50,200]:[50,30])}
        else{res.textContent+=' ‚Üí No match';res.className='slot-result lose'}
        document.getElementById('casinoBal').textContent=fmt(money);updateAll();saveGame();
    },800);
}

// FACTORY ASSEMBLY LINE
let factoryActive=false,factoryScore=0,factoryTime=30,factoryItems=[],factoryInterval=null;
const factoryProducts=['üì¶','üîß','‚öôÔ∏è','üî©','üõ†Ô∏è'];
function renderFactory(c){
    c.innerHTML=`<button class="mg-close" onclick="closeMiniGame();if(factoryInterval)clearInterval(factoryInterval)">‚úï</button>
        <div class="mg-title">üè≠ ASSEMBLY LINE üè≠</div>
        <div class="mg-balance">Cash: <span id="factoryBal">${fmt(money)}</span></div>
        <div class="safe-game">
            <div class="safe-info">Click matching items as they pass! Time: <b style="color:#4ade80"><span id="factoryTimer">30</span>s</b> | Score: <b style="color:#ffd700"><span id="factoryScore">0</span></b></div>
            <div style="margin:15px 0;min-height:180px">
                <div style="text-align:center;font-size:2em;margin-bottom:10px">Target: <span id="factoryTarget" style="color:#ffd700">?</span></div>
                <div id="factoryBelt" style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin:10px auto;max-width:300px"></div>
            </div>
            <button class="safe-submit" id="factoryStartBtn" onclick="startFactory()">üè≠ START PRODUCTION</button>
            <div class="slot-result" id="factoryResult"></div>
            <div style="margin-top:6px;font-size:0.65em;color:#64748b">Click correct items quickly! Each correct: +$${fmt(500)}. Wrong click: -$${fmt(100)}</div>
        </div>`;
}
function startFactory(){
    if(factoryActive)return;
    factoryActive=true;factoryScore=0;factoryTime=30;factoryItems=[];
    document.getElementById('factoryStartBtn').disabled=true;
    document.getElementById('factoryResult').textContent='';
    const target=factoryProducts[Math.floor(Math.random()*factoryProducts.length)];
    document.getElementById('factoryTarget').textContent=target;
    factoryInterval=setInterval(()=>{
        factoryTime--;
        document.getElementById('factoryTimer').textContent=factoryTime;
        if(factoryTime<=0){endFactory();return}
        if(Math.random()<0.7){
            const item=Math.random()<0.4?target:factoryProducts[Math.floor(Math.random()*factoryProducts.length)];
            const id=Date.now()+Math.random();
            factoryItems.push({id,item,correct:item===target});
            if(factoryItems.length>12)factoryItems.shift();
        }
        renderFactoryBelt(target);
    },800);
}
function renderFactoryBelt(target){
    const belt=document.getElementById('factoryBelt');
    belt.innerHTML=factoryItems.map(fi=>`<div onclick="clickFactoryItem('${fi.id}','${fi.correct}')" style="font-size:2.5em;cursor:pointer;background:rgba(255,255,255,0.1);border-radius:8px;padding:10px;text-align:center;transition:transform 0.1s" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">${fi.item}</div>`).join('');
}
function clickFactoryItem(id,correct){
    if(!factoryActive)return;
    const isCorrect=correct==='true';
    factoryItems=factoryItems.filter(fi=>fi.id!=id);
    if(isCorrect){factoryScore++;money+=500;totalEarned+=500;vib([20,10])}
    else{money=Math.max(0,money-100);vib([50])}
    document.getElementById('factoryScore').textContent=factoryScore;
    document.getElementById('factoryBal').textContent=fmt(money);
    updateAll();
}
function endFactory(){
    clearInterval(factoryInterval);factoryActive=false;
    const bonus=factoryScore*500;const total=bonus;
    const res=document.getElementById('factoryResult');
    if(factoryScore>=20){res.textContent=`üéâ EXCELLENT! Score: ${factoryScore} ‚Üí Bonus: +${fmt(total)}`;res.className='slot-result jackpot';money+=total;totalEarned+=total;vib([100,50,100,50,200])}
    else if(factoryScore>=10){res.textContent=`‚úì Good work! Score: ${factoryScore}`;res.className='slot-result win';vib([50,30])}
    else{res.textContent=`Score: ${factoryScore}. Keep practicing!`;res.className='slot-result'}
    document.getElementById('factoryStartBtn').disabled=false;
    document.getElementById('factoryBal').textContent=fmt(money);
    updateAll();saveGame();
}

// ROULETTE
let rouletteBet=1000,rouletteChoice=null,rouletteSpinning=false;
const rouletteNumbers=[0,32,15,19,4,21,2,25,17,34,6,27,13,36,11,30,8,23,10,5,24,16,33,1,20,14,31,9,22,18,29,7,28,12,35,3,26];
const redNums=[1,3,5,7,9,12,14,16,18,19,21,23,25,27,30,32,34,36];
const rouletteBets=[
    {id:'red',name:'Red',payout:2,desc:'1-18 red'},
    {id:'black',name:'Black',payout:2,desc:'1-18 black'},
    {id:'low',name:'1-18',payout:2,desc:'Low half'},
    {id:'high',name:'19-36',payout:2,desc:'High half'},
    {id:'even',name:'Even',payout:2,desc:'Even numbers'},
    {id:'odd',name:'Odd',payout:2,desc:'Odd numbers'},
    {id:'zero',name:'0 (Zero)',payout:35,desc:'Jackpot!'}
];
function renderRoulette(c){
    c.innerHTML=`<div style="margin-top:8px">
            <div style="position:relative;width:180px;height:180px;margin:10px auto;background:radial-gradient(circle,#1a1a2e,#0f0f1e);border-radius:50%;border:8px solid #ffd700;display:flex;align-items:center;justify-content:center;flex-direction:column">
                <div id="rouletteWheel" style="font-size:2.5em;transition:transform 0.05s">üéØ</div>
                <div id="rouletteResult" style="font-size:1.8em;font-weight:bold;color:#ffd700;margin-top:8px"></div>
            </div>
            <div class="slot-bet-row" style="margin:8px 0"><button onclick="rouletteBet=Math.max(100,rouletteBet-1000);document.getElementById('rouletteBetAmt').textContent=fmt(rouletteBet)">‚àí</button><div class="slot-bet">Bet: <b id="rouletteBetAmt">${fmt(rouletteBet)}</b></div><button onclick="rouletteBet=Math.min(money,rouletteBet+1000);document.getElementById('rouletteBetAmt').textContent=fmt(rouletteBet)">+</button></div>
            <div style="font-size:0.7em;color:#94a3b8;margin-bottom:6px;font-weight:bold">Place your bet:</div>
            <div class="dice-bet-options" style="grid-template-columns:repeat(2,1fr)">${rouletteBets.map(b=>`<div class="dice-bet-opt" data-id="${b.id}" onclick="rouletteChoice='${b.id}';document.querySelectorAll('.dice-bet-opt').forEach(x=>x.classList.remove('selected'));this.classList.add('selected');document.getElementById('rouletteSpinBtn').disabled=false"><div style="font-weight:bold;margin-bottom:2px">${b.name}</div><div class="payout">${b.payout}x</div></div>`).join('')}</div>
            <button class="dice-roll-btn" id="rouletteSpinBtn" onclick="spinRoulette()" disabled>üéØ SPIN üéØ</button>
            <div class="slot-result" id="rouletteWinResult" style="margin-top:8px"></div>
        </div>`;
    rouletteChoice=null;
}
function spinRoulette(){
    if(rouletteSpinning||!rouletteChoice||money<rouletteBet)return;
    money-=rouletteBet;rouletteSpinning=true;updateAll();
    const wheel=document.getElementById('rouletteWheel');
    const result=document.getElementById('rouletteResult');
    const winResult=document.getElementById('rouletteWinResult');
    result.textContent='';winResult.textContent='';winResult.className='slot-result';
    let spins=0;const maxSpins=30;
    const spinInterval=setInterval(()=>{
        wheel.style.transform=`rotate(${spins*36}deg)`;
        spins++;
        if(spins>=maxSpins){
            clearInterval(spinInterval);
            const num=rouletteNumbers[Math.floor(Math.random()*rouletteNumbers.length)];
            const isRed=redNums.includes(num);
            result.textContent=num;result.style.color=num===0?'#22c55e':(isRed?'#ef4444':'#1f2937');
            setTimeout(()=>{
                let win=0;const bet=rouletteBets.find(b=>b.id===rouletteChoice);
                if((rouletteChoice==='red'&&isRed)||(rouletteChoice==='black'&&!isRed&&num!==0)||(rouletteChoice==='low'&&num>=1&&num<=18)||(rouletteChoice==='high'&&num>=19)||(rouletteChoice==='even'&&num>0&&num%2===0)||(rouletteChoice==='odd'&&num%2===1)||(rouletteChoice==='zero'&&num===0))win=rouletteBet*bet.payout;
                if(win>0){money+=win;totalEarned+=win;winResult.textContent=`WIN! +${fmt(win)}`;winResult.className='slot-result '+(bet.payout>=10?'jackpot':'win');vib(bet.payout>=10?[100,50,100,50,200]:[50,30])}
                else{winResult.textContent='No match';winResult.className='slot-result lose'}
                document.getElementById('casinoBal').textContent=fmt(money);updateAll();saveGame();
                rouletteSpinning=false;
            },500);
        }
    },50);
}

// === GAME LOOP ===
loadGame();
document.body.className=`rank-${getRank()}`;
if(settings.debug)document.getElementById('debugBtns').style.display='flex';
updateAll();

// === PRESS AND HOLD SYSTEM ===
let holdTimer=null;
let holdInterval=null;
let lastHoldButton=null;

function setupHoldToRepeat(){
    let isHolding=false;

    document.addEventListener('mousedown',(e)=>{
        const btn=e.target.closest('button, .money-circle');
        if(!btn||btn.disabled)return;
        if(btn.classList.contains('modal-close')||btn.classList.contains('tab-btn'))return;

        // Exclude critical buttons that need confirm dialogs
        const clickHandler=btn.getAttribute('onclick');
        if(!clickHandler)return;
        if(clickHandler.includes('hardReset')||clickHandler.includes('confirmPrestige')||clickHandler.includes('fireCrew'))return;

        isHolding=false;
        lastHoldButton=btn;
        holdTimer=setTimeout(()=>{
            isHolding=true;
            holdInterval=setInterval(()=>{
                if(btn.disabled)return;
                try{eval(clickHandler)}catch(e){}
            },100);
        },1000);
    });

    const stopHold=()=>{
        if(holdTimer){clearTimeout(holdTimer);holdTimer=null}
        if(holdInterval){clearInterval(holdInterval);holdInterval=null}
        isHolding=false;
        lastHoldButton=null;
    };

    document.addEventListener('mouseup',stopHold);
    document.addEventListener('mouseleave',(e)=>{if(e.target===document.body)stopHold()});
    document.addEventListener('touchend',stopHold);
    document.addEventListener('touchcancel',stopHold);

    // Touch support
    document.addEventListener('touchstart',(e)=>{
        const btn=e.target.closest('button, .money-circle');
        if(!btn||btn.disabled)return;
        if(btn.classList.contains('modal-close')||btn.classList.contains('tab-btn'))return;

        // Exclude critical buttons that need confirm dialogs
        const clickHandler=btn.getAttribute('onclick');
        if(!clickHandler)return;
        if(clickHandler.includes('hardReset')||clickHandler.includes('confirmPrestige')||clickHandler.includes('fireCrew'))return;

        isHolding=false;
        lastHoldButton=btn;
        holdTimer=setTimeout(()=>{
            isHolding=true;
            holdInterval=setInterval(()=>{
                if(btn.disabled)return;
                try{eval(clickHandler)}catch(e){}
            },100);
        },1000);
    });
}

setupHoldToRepeat();

setInterval(()=>{
    const incomeMultiplier=(activeEffects.incomeBoost?1+activeEffects.incomeBoost.val:1);
    const earned=Math.floor(moneyPerSecond*globalMult*incomeMultiplier);
    money+=earned;
    if(moneyPerSecond>0){totalEarned+=earned;lifetimeEarnings+=earned;reputation+=Math.ceil(earned/4000)}
    policeHeat=Math.max(0,policeHeat-(0.4+heatDecay)/10);
    checkRaid();updateAll();
},1000);

setInterval(()=>{if(thieves.length){processCrew();checkAchievements();updateAll()}},5000);
setInterval(()=>{triggerRandomEvent();clearExpiredEffects()},60000); // Events & effects every minute
setInterval(saveGame,5000);
document.addEventListener('visibilitychange',()=>{if(document.hidden)saveGame()});

function clearExpiredEffects(){
    const now=Date.now();
    Object.keys(activeEffects).forEach(key=>{
        if(activeEffects[key].ends&&now>=activeEffects[key].ends){
            delete activeEffects[key];
        }
    });
}
</script>

</body>
</html>
