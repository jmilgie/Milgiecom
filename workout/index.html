<!DOCTYPE html>

<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
  <title>Upper Body Coach</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0a0a0a;
      --surface: #141414;
      --surface-raised: #1a1a1a;
      --border: rgba(255,255,255,0.08);
      --text: #ffffff;
      --text-muted: #888;
      --accent: #00ff88;
      --accent-glow: rgba(0, 255, 136, 0.15);
      --warning: #ff9500;
      --danger: #ff3b5c;
      --rest: #6366f1;
      --prep: #f59e0b;
      --font-display: 'Bebas Neue', sans-serif;
      --font-body: 'DM Sans', -apple-system, sans-serif;
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }

```
* { box-sizing: border-box; margin: 0; padding: 0; }

html, body {
  height: 100%;
  overflow: hidden;
}

body {
  font-family: var(--font-body);
  background: var(--bg);
  color: var(--text);
  -webkit-font-smoothing: antialiased;
  -webkit-tap-highlight-color: transparent;
  overscroll-behavior: none;
}

/* ===== APP SHELL ===== */
.app {
  height: 100%;
  display: flex;
  flex-direction: column;
}

/* ===== HEADER ===== */
.header {
  flex-shrink: 0;
  padding: 12px 16px;
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
}

.logo {
  font-family: var(--font-display);
  font-size: 24px;
  letter-spacing: 2px;
  color: var(--accent);
}

.session-tabs {
  display: flex;
  gap: 4px;
  background: var(--bg);
  padding: 4px;
  border-radius: 12px;
}

.session-tab {
  width: 44px;
  height: 36px;
  border: none;
  background: transparent;
  color: var(--text-muted);
  font-family: var(--font-display);
  font-size: 18px;
  letter-spacing: 1px;
  cursor: pointer;
  border-radius: 8px;
  transition: all 0.2s;
}

.session-tab.active {
  background: var(--accent);
  color: var(--bg);
}

.header-actions {
  display: flex;
  gap: 8px;
}

.icon-btn {
  width: 40px;
  height: 40px;
  border: 1px solid var(--border);
  background: transparent;
  color: var(--text-muted);
  border-radius: 10px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  transition: all 0.2s;
}

.icon-btn:hover {
  border-color: var(--accent);
  color: var(--accent);
}

/* ===== MAIN CONTENT ===== */
.main {
  flex: 1;
  overflow: hidden;
  position: relative;
}

/* ===== VIEWS ===== */
.view {
  position: absolute;
  inset: 0;
  display: none;
  flex-direction: column;
}

.view.active {
  display: flex;
}

/* ===== WORKOUT VIEW ===== */
.workout-view {
  padding: 0;
}

/* Current Exercise Display */
.current-exercise {
  flex: 1;
  display: flex;
  flex-direction: column;
  justify-content: center;
  padding: 24px;
  text-align: center;
  position: relative;
  overflow: hidden;
}

.current-exercise::before {
  content: '';
  position: absolute;
  top: -50%;
  left: -50%;
  width: 200%;
  height: 200%;
  background: radial-gradient(circle at center, var(--accent-glow) 0%, transparent 50%);
  opacity: 0;
  transition: opacity 0.5s;
  pointer-events: none;
}

.current-exercise.timer-active::before {
  opacity: 1;
  animation: pulse-glow 2s ease-in-out infinite;
}

@keyframes pulse-glow {
  0%, 100% { opacity: 0.3; transform: scale(1); }
  50% { opacity: 0.6; transform: scale(1.1); }
}

.progress-indicator {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: var(--border);
}

.progress-bar {
  height: 100%;
  background: var(--accent);
  width: 0%;
  transition: width 0.2s linear;
}

.progress-bar.rest { background: var(--rest); }
.progress-bar.prep { background: var(--prep); }

.step-counter {
  font-size: 13px;
  color: var(--text-muted);
  margin-bottom: 8px;
  letter-spacing: 1px;
}

.phase-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 14px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 16px;
}

.phase-badge.work {
  background: rgba(0, 255, 136, 0.15);
  color: var(--accent);
}

.phase-badge.rest {
  background: rgba(99, 102, 241, 0.15);
  color: var(--rest);
}

.phase-badge.prep {
  background: rgba(245, 158, 11, 0.15);
  color: var(--prep);
}

.phase-badge.ready {
  background: rgba(255,255,255,0.1);
  color: var(--text-muted);
}

.exercise-name {
  font-family: var(--font-display);
  font-size: clamp(32px, 8vw, 56px);
  letter-spacing: 2px;
  line-height: 1.1;
  margin-bottom: 8px;
}

.exercise-detail {
  font-size: 18px;
  color: var(--text-muted);
  margin-bottom: 24px;
}

.timer-display {
  font-family: var(--font-display);
  font-size: clamp(72px, 20vw, 120px);
  letter-spacing: 4px;
  line-height: 1;
  margin-bottom: 24px;
}

.timer-display.rest { color: var(--rest); }
.timer-display.prep { color: var(--prep); }
.timer-display.work { color: var(--accent); }

/* Instructions Panel */
.instructions-panel {
  background: var(--surface);
  border-top: 1px solid var(--border);
  max-height: 35vh;
  overflow-y: auto;
}

.instructions-toggle {
  width: 100%;
  padding: 14px 20px;
  background: transparent;
  border: none;
  color: var(--text);
  display: flex;
  align-items: center;
  justify-content: space-between;
  cursor: pointer;
  font-size: 14px;
  font-weight: 600;
}

.instructions-toggle .arrow {
  transition: transform 0.2s;
}

.instructions-toggle.open .arrow {
  transform: rotate(180deg);
}

.instructions-content {
  display: none;
  padding: 0 20px 20px;
  color: var(--text-muted);
  font-size: 14px;
  line-height: 1.6;
}

.instructions-content.open {
  display: block;
}

.instructions-content p {
  margin-bottom: 12px;
}

.instructions-content b {
  color: var(--text);
}

/* ===== CONFIRMATION VIEW ===== */
.confirm-view {
  background: var(--bg);
}

.confirm-content {
  flex: 1;
  overflow-y: auto;
  padding: 24px;
}

.confirm-header {
  text-align: center;
  margin-bottom: 32px;
}

.confirm-step {
  font-size: 13px;
  color: var(--text-muted);
  margin-bottom: 8px;
  letter-spacing: 1px;
}

.confirm-title {
  font-family: var(--font-display);
  font-size: 36px;
  letter-spacing: 2px;
  margin-bottom: 8px;
}

.confirm-subtitle {
  color: var(--text-muted);
  font-size: 16px;
}

.confirm-instructions {
  background: var(--surface);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 24px;
}

.confirm-instructions h3 {
  font-size: 14px;
  font-weight: 600;
  margin-bottom: 12px;
  color: var(--accent);
}

.confirm-instructions-text {
  color: var(--text-muted);
  font-size: 14px;
  line-height: 1.7;
}

.confirm-instructions-text p {
  margin-bottom: 10px;
}

.confirm-instructions-text b {
  color: var(--text);
}

/* Upcoming List */
.upcoming-section {
  margin-top: 24px;
}

.upcoming-title {
  font-size: 12px;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 12px;
}

.upcoming-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.upcoming-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px;
  background: var(--surface);
  border-radius: 10px;
}

.upcoming-item.current {
  border: 1px solid var(--accent);
  background: rgba(0, 255, 136, 0.05);
}

.upcoming-number {
  width: 28px;
  height: 28px;
  border-radius: 8px;
  background: var(--surface-raised);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  font-weight: 600;
  color: var(--text-muted);
}

.upcoming-item.current .upcoming-number {
  background: var(--accent);
  color: var(--bg);
}

.upcoming-info {
  flex: 1;
  min-width: 0;
}

.upcoming-name {
  font-size: 14px;
  font-weight: 500;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.upcoming-meta {
  font-size: 12px;
  color: var(--text-muted);
}

/* ===== INTRO/OVERVIEW VIEW ===== */
.intro-view {
  padding: 24px;
  overflow-y: auto;
}

.intro-header {
  text-align: center;
  margin-bottom: 32px;
}

.intro-title {
  font-family: var(--font-display);
  font-size: 28px;
  letter-spacing: 2px;
  margin-bottom: 8px;
}

.intro-subtitle {
  color: var(--text-muted);
  font-size: 14px;
}

.program-explanation {
  background: var(--surface);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 24px;
}

.program-explanation h3 {
  font-size: 14px;
  font-weight: 600;
  margin-bottom: 12px;
  color: var(--accent);
  display: flex;
  align-items: center;
  gap: 8px;
}

.program-explanation p {
  color: var(--text-muted);
  font-size: 14px;
  line-height: 1.6;
  margin-bottom: 12px;
}

.program-explanation p:last-child {
  margin-bottom: 0;
}

.rotation-visual {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
  margin: 20px 0;
  padding: 16px;
  background: var(--bg);
  border-radius: 12px;
}

.rotation-day {
  text-align: center;
}

.rotation-day .letter {
  width: 48px;
  height: 48px;
  border-radius: 12px;
  background: var(--surface-raised);
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: var(--font-display);
  font-size: 24px;
  margin-bottom: 6px;
}

.rotation-day .letter.active {
  background: var(--accent);
  color: var(--bg);
}

.rotation-day .label {
  font-size: 11px;
  color: var(--text-muted);
}

.rotation-arrow {
  color: var(--text-muted);
  font-size: 20px;
}

.workout-overview {
  background: var(--surface);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 24px;
}

.workout-overview h3 {
  font-size: 14px;
  font-weight: 600;
  margin-bottom: 16px;
  color: var(--text);
}

.overview-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.overview-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 10px 12px;
  background: var(--bg);
  border-radius: 10px;
}

.overview-item.warmup {
  opacity: 0.7;
}

.overview-number {
  width: 24px;
  height: 24px;
  border-radius: 6px;
  background: var(--surface-raised);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 11px;
  font-weight: 600;
  color: var(--text-muted);
}

.overview-item.main .overview-number {
  background: var(--accent-glow);
  color: var(--accent);
}

.overview-info {
  flex: 1;
}

.overview-name {
  font-size: 13px;
  font-weight: 500;
}

.overview-meta {
  font-size: 11px;
  color: var(--text-muted);
}

.overview-tag {
  font-size: 10px;
  padding: 4px 8px;
  border-radius: 6px;
  background: var(--surface-raised);
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.overview-tag.main {
  background: var(--accent-glow);
  color: var(--accent);
}

/* ===== PROGRAM SELECTOR ===== */
.program-selector {
  background: var(--surface);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 24px;
}

.program-selector label {
  display: block;
  font-size: 12px;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 10px;
}

.program-selector select {
  width: 100%;
  padding: 14px 16px;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 10px;
  color: var(--text);
  font-size: 15px;
  font-family: inherit;
  cursor: pointer;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23888' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 16px center;
}

.program-selector select:focus {
  outline: none;
  border-color: var(--accent);
}

.program-selector select option {
  background: var(--surface);
  color: var(--text);
}

/* Loading State */
.app.loading .intro-view {
  opacity: 0.5;
  pointer-events: none;
}

.loading-overlay {
  position: fixed;
  inset: 0;
  background: var(--bg);
  display: flex;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  gap: 16px;
  z-index: 1000;
}

.loading-overlay.hidden {
  display: none;
}

.loading-spinner {
  width: 48px;
  height: 48px;
  border: 3px solid var(--border);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.loading-text {
  color: var(--text-muted);
  font-size: 14px;
}

.session-selector {
  background: var(--surface);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 24px;
}

.session-selector h3 {
  font-size: 14px;
  font-weight: 600;
  margin-bottom: 16px;
  color: var(--text);
}

.session-buttons {
  display: flex;
  gap: 12px;
}

.session-btn {
  flex: 1;
  padding: 16px;
  border-radius: 12px;
  border: 2px solid var(--border);
  background: var(--bg);
  cursor: pointer;
  transition: all 0.2s;
}

.session-btn.active {
  border-color: var(--accent);
  background: var(--accent-glow);
}

.session-btn .letter {
  font-family: var(--font-display);
  font-size: 32px;
  color: var(--text);
  margin-bottom: 4px;
}

.session-btn.active .letter {
  color: var(--accent);
}

.session-btn .focus {
  font-size: 11px;
  color: var(--text-muted);
}

/* ===== HISTORY VIEW ===== */
.history-view {
  padding: 24px;
  overflow-y: auto;
}

.history-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 24px;
}

.history-title {
  font-family: var(--font-display);
  font-size: 32px;
  letter-spacing: 2px;
}

.back-btn {
  padding: 10px 16px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 10px;
  color: var(--text);
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
}

.history-stats {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 12px;
  margin-bottom: 32px;
}

.stat-card {
  background: var(--surface);
  border-radius: 12px;
  padding: 16px;
  text-align: center;
}

.stat-value {
  font-family: var(--font-display);
  font-size: 36px;
  color: var(--accent);
  letter-spacing: 1px;
}

.stat-label {
  font-size: 11px;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-top: 4px;
}

.history-list {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.history-item {
  background: var(--surface);
  border-radius: 12px;
  padding: 16px;
  display: flex;
  align-items: center;
  gap: 16px;
}

.history-session-badge {
  width: 48px;
  height: 48px;
  border-radius: 12px;
  background: var(--accent-glow);
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: var(--font-display);
  font-size: 24px;
  color: var(--accent);
}

.history-info {
  flex: 1;
}

.history-date {
  font-weight: 500;
  margin-bottom: 4px;
}

.history-meta {
  font-size: 13px;
  color: var(--text-muted);
}

.history-empty {
  text-align: center;
  padding: 48px 24px;
  color: var(--text-muted);
}

/* ===== SETTINGS VIEW ===== */
.settings-view {
  padding: 24px;
  overflow-y: auto;
}

.settings-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 24px;
}

.settings-title {
  font-family: var(--font-display);
  font-size: 32px;
  letter-spacing: 2px;
}

.settings-section {
  margin-bottom: 32px;
}

.settings-section-title {
  font-size: 12px;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 12px;
}

.setting-item {
  background: var(--surface);
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 8px;
}

.setting-item label {
  display: block;
  font-size: 14px;
  font-weight: 500;
  margin-bottom: 8px;
}

.setting-item input,
.setting-item select {
  width: 100%;
  padding: 12px;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 8px;
  color: var(--text);
  font-size: 16px;
  font-family: inherit;
}

.setting-item input:focus,
.setting-item select:focus {
  outline: none;
  border-color: var(--accent);
}

.setting-hint {
  font-size: 12px;
  color: var(--text-muted);
  margin-top: 6px;
}

.danger-zone {
  margin-top: 48px;
  padding-top: 24px;
  border-top: 1px solid var(--border);
}

.danger-btn {
  width: 100%;
  padding: 14px;
  background: rgba(255, 59, 92, 0.1);
  border: 1px solid var(--danger);
  border-radius: 10px;
  color: var(--danger);
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
}

/* ===== BOTTOM CONTROLS ===== */
.bottom-controls {
  flex-shrink: 0;
  padding: 16px;
  padding-bottom: calc(16px + var(--safe-bottom));
  background: var(--surface);
  border-top: 1px solid var(--border);
}

.controls-row {
  display: flex;
  gap: 12px;
}

.control-btn {
  flex: 1;
  height: 56px;
  border: none;
  border-radius: 14px;
  font-family: var(--font-display);
  font-size: 18px;
  letter-spacing: 2px;
  cursor: pointer;
  transition: all 0.15s;
}

.control-btn:active {
  transform: scale(0.98);
}

.control-btn.primary {
  background: var(--accent);
  color: var(--bg);
}

.control-btn.secondary {
  background: var(--surface-raised);
  color: var(--text);
  border: 1px solid var(--border);
}

.control-btn.danger {
  background: rgba(255, 59, 92, 0.15);
  color: var(--danger);
  border: 1px solid rgba(255, 59, 92, 0.3);
}

.control-btn.small {
  flex: 0 0 56px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.control-btn.cancel {
  background: transparent;
  border: 1px solid rgba(255, 59, 92, 0.3);
  color: var(--danger);
  font-size: 18px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.control-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* ===== TOAST ===== */
.toast {
  position: fixed;
  top: 80px;
  left: 50%;
  transform: translateX(-50%) translateY(-20px);
  background: var(--surface-raised);
  color: var(--text);
  padding: 12px 20px;
  border-radius: 10px;
  font-size: 14px;
  font-weight: 500;
  opacity: 0;
  pointer-events: none;
  transition: all 0.3s;
  z-index: 100;
  border: 1px solid var(--border);
}

.toast.show {
  opacity: 1;
  transform: translateX(-50%) translateY(0);
}

/* ===== MODAL ===== */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.8);
  display: none;
  align-items: center;
  justify-content: center;
  padding: 24px;
  z-index: 200;
}

.modal-overlay.show {
  display: flex;
}

.modal {
  background: var(--surface);
  border-radius: 20px;
  padding: 24px;
  max-width: 360px;
  width: 100%;
}

.modal-title {
  font-family: var(--font-display);
  font-size: 24px;
  letter-spacing: 1px;
  margin-bottom: 12px;
}

.modal-text {
  color: var(--text-muted);
  font-size: 14px;
  line-height: 1.6;
  margin-bottom: 24px;
}

.modal-actions {
  display: flex;
  gap: 12px;
}

.modal-btn {
  flex: 1;
  padding: 14px;
  border-radius: 10px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  border: none;
}

.modal-btn.cancel {
  background: var(--surface-raised);
  color: var(--text);
}

.modal-btn.confirm {
  background: var(--accent);
  color: var(--bg);
}

.modal-btn.danger {
  background: var(--danger);
  color: white;
}

/* Log Modal */
.log-field {
  margin-bottom: 16px;
}

.log-field label {
  display: block;
  font-size: 13px;
  color: var(--text-muted);
  margin-bottom: 6px;
}

.log-field input,
.log-field textarea {
  width: 100%;
  padding: 12px;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 8px;
  color: var(--text);
  font-size: 15px;
  font-family: inherit;
}

.log-field textarea {
  min-height: 80px;
  resize: vertical;
}

.log-field input:focus,
.log-field textarea:focus {
  outline: none;
  border-color: var(--accent);
}
```

  </style>
</head>
<body>
  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
    <div class="loading-text">Loading workout programs...</div>
  </div>

  <div class="app" id="app">
    <!-- Header -->
    <header class="header">
      <div class="logo" id="programLogo">WORKOUT</div>
      <div class="session-tabs" id="sessionTabs">
        <!-- Dynamically populated -->
      </div>
      <div class="header-actions">
        <button class="icon-btn" id="historyBtn" title="History">üìä</button>
        <button class="icon-btn" id="settingsBtn" title="Settings">‚öôÔ∏è</button>
      </div>
    </header>

```
<!-- Main Content -->
<main class="main">
  <!-- Intro/Overview View -->
  <div class="view intro-view active" id="introView">
    <div class="intro-header">
      <h1 class="intro-title" id="programTitle">WORKOUT PROGRAM</h1>
      <p class="intro-subtitle" id="programSubtitle">Loading...</p>
    </div>

    <div class="program-selector">
      <label for="programSelect">Select Program</label>
      <select id="programSelect">
        <option value="">Loading programs...</option>
      </select>
    </div>

    <div class="program-explanation" id="programExplanation">
      <h3>üìã How It Works</h3>
      <p><b>Rotate through A ‚Üí B ‚Üí C</b> each workout day. Rest at least one day between sessions. Most people train 3-4 days per week.</p>
      <p><b>Example week:</b> Monday (A), Wednesday (B), Friday (C), then next week continue with A, B, C...</p>
      <div class="rotation-visual">
        <div class="rotation-day">
          <div class="letter active" id="rotationA">A</div>
          <div class="label">Bench + Row</div>
        </div>
        <div class="rotation-arrow">‚Üí</div>
        <div class="rotation-day">
          <div class="letter" id="rotationB">B</div>
          <div class="label">OHP + Pull</div>
        </div>
        <div class="rotation-arrow">‚Üí</div>
        <div class="rotation-day">
          <div class="letter" id="rotationC">C</div>
          <div class="label">Volume</div>
        </div>
        <div class="rotation-arrow">‚Üí</div>
        <div class="rotation-day">
          <div class="letter">‚Ü∫</div>
          <div class="label">Repeat</div>
        </div>
      </div>
      <p><b>Pull-up focus:</b> Every session includes pull-up practice or strength work. The goal is building toward clean, controlled pull-ups over time.</p>
    </div>

    <div class="session-selector">
      <h3>Select Today's Session</h3>
      <div class="session-buttons" id="sessionButtons">
        <!-- Dynamically populated -->
      </div>
    </div>

    <div class="workout-overview">
      <h3 id="overviewTitle">Session A Overview</h3>
      <div class="overview-list" id="overviewList"></div>
    </div>
  </div>

  <!-- Workout View (Active Exercise) -->
  <div class="view workout-view" id="workoutView">
    <div class="current-exercise" id="currentExercise">
      <div class="progress-indicator">
        <div class="progress-bar" id="progressBar"></div>
      </div>
      
      <div class="step-counter" id="stepCounter">STEP 0 OF 0</div>
      <div class="phase-badge ready" id="phaseBadge">
        <span id="phaseText">READY</span>
      </div>
      <h1 class="exercise-name" id="exerciseName">Select Session</h1>
      <p class="exercise-detail" id="exerciseDetail">Choose A, B, or C to begin</p>
      <div class="timer-display" id="timerDisplay">00:00</div>
    </div>

    <div class="instructions-panel">
      <button class="instructions-toggle" id="instructionsToggle">
        <span>How to do it</span>
        <span class="arrow">‚ñº</span>
      </button>
      <div class="instructions-content" id="instructionsContent"></div>
    </div>
  </div>

  <!-- Confirm View (Before starting each exercise) -->
  <div class="view confirm-view" id="confirmView">
    <div class="confirm-content">
      <div class="confirm-header">
        <div class="confirm-step" id="confirmStep">NEXT UP</div>
        <h2 class="confirm-title" id="confirmTitle">Exercise Name</h2>
        <p class="confirm-subtitle" id="confirmSubtitle">3 sets √ó 8-12 reps</p>
      </div>

      <div class="confirm-instructions">
        <h3>üìñ Instructions</h3>
        <div class="confirm-instructions-text" id="confirmInstructions"></div>
      </div>

      <div class="upcoming-section">
        <div class="upcoming-title">Coming Up</div>
        <div class="upcoming-list" id="upcomingList"></div>
      </div>
    </div>
  </div>

  <!-- History View -->
  <div class="view history-view" id="historyView">
    <div class="history-header">
      <h2 class="history-title">HISTORY</h2>
      <button class="back-btn" id="historyBackBtn">‚Üê Back</button>
    </div>

    <div class="history-stats">
      <div class="stat-card">
        <div class="stat-value" id="totalWorkouts">0</div>
        <div class="stat-label">Workouts</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="thisWeek">0</div>
        <div class="stat-label">This Week</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="streak">0</div>
        <div class="stat-label">Day Streak</div>
      </div>
    </div>

    <div class="history-list" id="historyList"></div>
  </div>

  <!-- Settings View -->
  <div class="view settings-view" id="settingsView">
    <div class="settings-header">
      <h2 class="settings-title">SETTINGS</h2>
      <button class="back-btn" id="settingsBackBtn">‚Üê Back</button>
    </div>

    <div class="settings-section">
      <div class="settings-section-title">Timers</div>
      
      <div class="setting-item">
        <label for="prepTime">Get Ready Countdown</label>
        <input type="number" id="prepTime" min="3" max="30" step="1">
        <div class="setting-hint">Seconds to prepare before each timed segment</div>
      </div>

      <div class="setting-item">
        <label for="mainRest">Main Lift Rest</label>
        <input type="number" id="mainRest" min="60" max="300" step="15">
        <div class="setting-hint">Rest between bench/OHP/row sets (seconds)</div>
      </div>

      <div class="setting-item">
        <label for="accessoryRest">Accessory Rest</label>
        <input type="number" id="accessoryRest" min="30" max="180" step="15">
        <div class="setting-hint">Rest between accessory exercises (seconds)</div>
      </div>

      <div class="setting-item">
        <label for="microRest">Pull-up Practice Rest</label>
        <input type="number" id="microRest" min="30" max="120" step="15">
        <div class="setting-hint">Rest during pull-up holds/negatives</div>
      </div>
    </div>

    <div class="settings-section">
      <div class="settings-section-title">Audio</div>
      
      <div class="setting-item">
        <label for="soundMode">Sound Mode</label>
        <select id="soundMode">
          <option value="beep">Beep</option>
          <option value="vibrate">Vibrate</option>
          <option value="both">Beep + Vibrate</option>
          <option value="off">Off</option>
        </select>
      </div>
    </div>

    <div class="danger-zone">
      <div class="settings-section-title">Danger Zone</div>
      <button class="danger-btn" id="resetBtn">Reset All Data</button>
    </div>
  </div>
</main>

<!-- Bottom Controls -->
<div class="bottom-controls">
  <div class="controls-row" id="controlsRow">
    <button class="control-btn secondary small" id="prevBtn" disabled>‚óÄ</button>
    <button class="control-btn primary" id="mainBtn">START</button>
    <button class="control-btn secondary small" id="skipBtn" disabled>‚ñ∂</button>
    <button class="control-btn cancel small" id="cancelBtn" style="display:none" title="End workout">‚úï</button>
  </div>
</div>
```

  </div>

  <!-- Toast -->

  <div class="toast" id="toast">Saved!</div>

  <!-- Confirm Modal -->

  <div class="modal-overlay" id="resetModal">
    <div class="modal">
      <h3 class="modal-title">Reset All Data?</h3>
      <p class="modal-text">This will clear all your workout history, logs, and settings. This cannot be undone.</p>
      <div class="modal-actions">
        <button class="modal-btn cancel" id="resetCancel">Cancel</button>
        <button class="modal-btn danger" id="resetConfirm">Reset</button>
      </div>
    </div>
  </div>

  <!-- Cancel Workout Modal -->

  <div class="modal-overlay" id="cancelWorkoutModal">
    <div class="modal">
      <h3 class="modal-title">End Workout?</h3>
      <p class="modal-text">This will end your current workout without saving. Are you sure?</p>
      <div class="modal-actions">
        <button class="modal-btn cancel" id="cancelWorkoutNo">Keep Going</button>
        <button class="modal-btn danger" id="cancelWorkoutYes">End Workout</button>
      </div>
    </div>
  </div>

  <!-- Log Modal -->

  <div class="modal-overlay" id="logModal">
    <div class="modal">
      <h3 class="modal-title">Log This Set</h3>
      <div class="log-field">
        <label for="logWeight">Weight Used</label>
        <input type="text" id="logWeight" placeholder="e.g., 135 lbs">
      </div>
      <div class="log-field">
        <label for="logNotes">Notes</label>
        <textarea id="logNotes" placeholder="How did it feel? Any form cues?"></textarea>
      </div>
      <div class="modal-actions">
        <button class="modal-btn cancel" id="logCancel">Skip</button>
        <button class="modal-btn confirm" id="logSave">Save</button>
      </div>
    </div>
  </div>

<script>
(function() {
  'use strict';

  // ===== STORAGE =====
  const STORAGE_KEY = 'workout_coach_v3';
  const DATA_PATH = 'data/';

  // ===== PROGRAM DATA (loaded dynamically) =====
  let availablePrograms = [];
  let currentProgram = null;
  let INSTRUCTIONS = {};
  let WORKOUTS = {};

  const defaultState = {
    currentProgramId: null,
    session: 'A',
    settings: {
      prepTime: 8,
      mainRest: 150,
      accessoryRest: 75,
      microRest: 60,
      soundMode: 'beep'
    },
    history: [],
    logs: {}
  };

  function loadState() {
    try {
      const saved = localStorage.getItem(STORAGE_KEY);
      if (!saved) return { ...defaultState };
      const parsed = JSON.parse(saved);
      return {
        ...defaultState,
        ...parsed,
        settings: { ...defaultState.settings, ...parsed.settings }
      };
    } catch (e) {
      return { ...defaultState };
    }
  }

  function saveState() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  }

  let state = loadState();

  // ===== PROGRAM LOADING =====
  async function loadProgramsList() {
    try {
      const response = await fetch(DATA_PATH + 'programs.json');
      if (!response.ok) throw new Error('Failed to load programs list');
      const data = await response.json();
      availablePrograms = data.programs || [];
      return availablePrograms;
    } catch (e) {
      console.error('Error loading programs list:', e);
      return [];
    }
  }

  async function loadProgram(programInfo) {
    try {
      const response = await fetch(DATA_PATH + programInfo.file);
      if (!response.ok) throw new Error('Failed to load program: ' + programInfo.file);
      const program = await response.json();

      currentProgram = program;
      INSTRUCTIONS = program.instructions || {};
      WORKOUTS = program.sessions || {};

      // Apply program's default settings if user hasn't customized them
      if (program.settings) {
        const savedSettings = state.settings;
        state.settings = {
          ...program.settings,
          soundMode: savedSettings.soundMode || 'beep'
        };
      }

      // Validate session exists in this program
      if (!WORKOUTS[state.session]) {
        state.session = Object.keys(WORKOUTS)[0] || 'A';
      }

      state.currentProgramId = program.id;
      saveState();

      return program;
    } catch (e) {
      console.error('Error loading program:', e);
      return null;
    }
  }

  function updateProgramUI() {
    if (!currentProgram) return;

    // Update logo
    const logoText = currentProgram.name.split('‚Äî')[0].trim().toUpperCase();
    const programLogo = document.getElementById('programLogo');
    if (programLogo) programLogo.textContent = logoText;

    // Update intro title and subtitle
    const programTitle = document.getElementById('programTitle');
    const programSubtitle = document.getElementById('programSubtitle');
    if (programTitle) programTitle.textContent = currentProgram.name.toUpperCase();
    if (programSubtitle) programSubtitle.textContent = currentProgram.description;

    // Update session tabs in header
    renderSessionTabs();

    // Update session buttons in intro
    renderSessionButtons();

    // Update rotation visual
    updateRotationVisual();
  }

  function renderSessionTabs() {
    const sessionTabs = document.getElementById('sessionTabs');
    if (!sessionTabs || !WORKOUTS) return;

    const sessions = Object.keys(WORKOUTS);
    sessionTabs.innerHTML = sessions.map(key =>
      `<button class="session-tab ${key === state.session ? 'active' : ''}" data-session="${key}">${key}</button>`
    ).join('');

    // Re-attach event listeners
    sessionTabs.querySelectorAll('.session-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        if (player.active) return;
        selectSession(tab.dataset.session);
      });
    });
  }

  function renderSessionButtons() {
    const sessionButtons = document.getElementById('sessionButtons');
    if (!sessionButtons || !WORKOUTS) return;

    const sessions = Object.keys(WORKOUTS);
    sessionButtons.innerHTML = sessions.map(key => {
      const session = WORKOUTS[key];
      const focus = session.name.split('‚Äî')[1]?.trim() || key;
      return `
        <button class="session-btn ${key === state.session ? 'active' : ''}" data-session="${key}">
          <div class="letter">${key}</div>
          <div class="focus">${focus}</div>
        </button>
      `;
    }).join('');

    // Re-attach event listeners
    sessionButtons.querySelectorAll('.session-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        selectSession(btn.dataset.session);
      });
    });
  }

  function updateRotationVisual() {
    const sessions = Object.keys(WORKOUTS);
    sessions.forEach(key => {
      const el = document.getElementById(`rotation${key}`);
      if (el) el.classList.toggle('active', key === state.session);
    });
  }

  function populateProgramSelector() {
    const select = document.getElementById('programSelect');
    if (!select) return;

    select.innerHTML = availablePrograms.map(p =>
      `<option value="${p.id}" ${p.id === state.currentProgramId ? 'selected' : ''}>${p.name}</option>`
    ).join('');

    select.addEventListener('change', async (e) => {
      const programInfo = availablePrograms.find(p => p.id === e.target.value);
      if (programInfo) {
        showLoading();
        await loadProgram(programInfo);
        updateProgramUI();
        renderWorkoutOverview();
        hideLoading();
      }
    });
  }

  function showLoading() {
    const overlay = document.getElementById('loadingOverlay');
    if (overlay) overlay.classList.remove('hidden');
  }

  function hideLoading() {
    const overlay = document.getElementById('loadingOverlay');
    if (overlay) overlay.classList.add('hidden');
  }

  // ===== AUDIO =====
  let audioCtx = null;
  
  function playBeep(freq = 880, duration = 100) {
    if (state.settings.soundMode === 'off') return;
    
    const doVibrate = state.settings.soundMode === 'vibrate' || state.settings.soundMode === 'both';
    const doBeep = state.settings.soundMode === 'beep' || state.settings.soundMode === 'both';
    
    if (doVibrate && navigator.vibrate) {
      navigator.vibrate([50, 30, 50]);
    }
    
    if (doBeep) {
      try {
        if (!audioCtx) {
          audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
        if (audioCtx.state === 'suspended') {
          audioCtx.resume();
        }
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = 'sine';
        osc.frequency.value = freq;
        gain.gain.value = 0.1;
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start();
        setTimeout(() => osc.stop(), duration);
      } catch (e) {}
    }
  }

  // ===== EXERCISE DATA =====
  // INSTRUCTIONS and WORKOUTS are now loaded dynamically from JSON files
  // See data/WORKOUT_FORMAT.md for the JSON schema

  // Fallback data in case loading fails
  const FALLBACK_INSTRUCTIONS = {
    "Finish": "<p><b>Great work!</b></p><p>Workout complete.</p>"
  };

  const FALLBACK_WORKOUTS = {
    A: {
      name: "Default Workout",
      exercises: [
        { name: "Finish", type: "complete" }
      ]
    }
  };

  // Note: INSTRUCTIONS and WORKOUTS variables are declared at the top of the script
  // and populated when a program is loaded via loadProgram()

  // ===== PLAYER STATE =====
  let player = {
    active: false,
    paused: false,
    currentExerciseIndex: 0,
    currentSetIndex: 0,
    currentSequenceIndex: 0,
    phase: 'ready', // ready, prep, work, rest, confirm
    timeRemaining: 0,
    timeTotal: 0,
    timerInterval: null,
    sessionStartTime: null
  };

  // ===== DOM ELEMENTS =====
  const $ = id => document.getElementById(id);
  const $$ = sel => document.querySelectorAll(sel);

  const views = {
    intro: $('introView'),
    workout: $('workoutView'),
    confirm: $('confirmView'),
    history: $('historyView'),
    settings: $('settingsView')
  };

  const els = {
    stepCounter: $('stepCounter'),
    phaseBadge: $('phaseBadge'),
    phaseText: $('phaseText'),
    exerciseName: $('exerciseName'),
    exerciseDetail: $('exerciseDetail'),
    timerDisplay: $('timerDisplay'),
    progressBar: $('progressBar'),
    currentExercise: $('currentExercise'),
    instructionsToggle: $('instructionsToggle'),
    instructionsContent: $('instructionsContent'),
    confirmStep: $('confirmStep'),
    confirmTitle: $('confirmTitle'),
    confirmSubtitle: $('confirmSubtitle'),
    confirmInstructions: $('confirmInstructions'),
    upcomingList: $('upcomingList'),
    controlsRow: $('controlsRow'),
    mainBtn: $('mainBtn'),
    prevBtn: $('prevBtn'),
    skipBtn: $('skipBtn'),
    cancelBtn: $('cancelBtn'),
    toast: $('toast')
  };

  // ===== UTILITY FUNCTIONS =====
  function formatTime(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
  }

  function escapeHtml(str) {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  let toastTimeout = null;
  function showToast(message) {
    if (toastTimeout) clearTimeout(toastTimeout);
    els.toast.textContent = message;
    els.toast.classList.add('show');
    toastTimeout = setTimeout(() => els.toast.classList.remove('show'), 2000);
  }

  function showView(viewName) {
    Object.values(views).forEach(v => v.classList.remove('active'));
    views[viewName].classList.add('active');
  }

  function getCurrentWorkout() {
    return WORKOUTS[state.session];
  }

  function getCurrentExercise() {
    const workout = getCurrentWorkout();
    if (!workout || !workout.exercises || player.currentExerciseIndex >= workout.exercises.length) {
      return { name: 'Unknown', type: 'instruction' };
    }
    return workout.exercises[player.currentExerciseIndex];
  }

  function getRestTime(restType) {
    switch (restType) {
      case 'main': return state.settings.mainRest;
      case 'accessory': return state.settings.accessoryRest;
      case 'micro': return state.settings.microRest;
      default: return state.settings.accessoryRest;
    }
  }

  function getInstructions(name) {
    return INSTRUCTIONS[name] || INSTRUCTIONS[name.split(' (')[0]] || `<p>Perform ${name} with good form.</p>`;
  }

  function renderWorkoutOverview() {
    const workout = getCurrentWorkout();
    $('overviewTitle').textContent = `Session ${state.session} Overview`;
    
    const exercises = workout.exercises.filter(ex => ex.type !== 'complete');
    
    $('overviewList').innerHTML = exercises.map((ex, i) => {
      const isWarmup = ex.name.toLowerCase().includes('warm-up') || ex.name === 'Ramp Sets';
      const isMain = ex.type === 'sets' && ex.rest === 'main';
      
      let meta = '';
      if (ex.type === 'sets') {
        meta = `${ex.sets} sets √ó ${ex.reps}`;
      } else if (ex.type === 'timed-sequence') {
        const totalTime = ex.sequence.reduce((sum, s) => sum + (s.time || 30) * s.reps + s.rest * (s.reps - 1), 0);
        meta = `~${Math.round(totalTime / 60)} min`;
      } else if (ex.type === 'instruction') {
        meta = 'Self-paced';
      }
      
      let tag = '';
      if (isWarmup) tag = 'Warm-up';
      else if (isMain) tag = 'Main';
      else if (ex.type === 'timed-sequence') tag = 'Timed';
      else tag = 'Accessory';
      
      return `
        <div class="overview-item ${isWarmup ? 'warmup' : ''} ${isMain ? 'main' : ''}">
          <div class="overview-number">${i + 1}</div>
          <div class="overview-info">
            <div class="overview-name">${ex.name}</div>
            <div class="overview-meta">${meta}</div>
          </div>
          <div class="overview-tag ${isMain ? 'main' : ''}">${tag}</div>
        </div>
      `;
    }).join('');
    
    // Update rotation visual
    ['A', 'B', 'C'].forEach(s => {
      const el = $(`rotation${s}`);
      if (el) el.classList.toggle('active', s === state.session);
    });
    
    // Update session buttons
    document.querySelectorAll('.session-btn').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.session === state.session);
    });
  }

  // ===== VIEW UPDATES =====
  function updateWorkoutView() {
    const workout = getCurrentWorkout();
    const exercise = getCurrentExercise();
    const totalExercises = workout.exercises.length;
    
    els.stepCounter.textContent = `STEP ${player.currentExerciseIndex + 1} OF ${totalExercises}`;
    
    // Phase badge
    els.phaseBadge.className = `phase-badge ${player.phase}`;
    const phaseNames = {
      ready: 'READY',
      prep: 'GET READY',
      work: 'GO',
      rest: 'REST',
      confirm: 'NEXT UP'
    };
    els.phaseText.textContent = phaseNames[player.phase] || 'READY';
    
    // Exercise info
    let displayName = exercise.name;
    let displayDetail = '';
    
    if (exercise.type === 'sets') {
      const currentSet = player.currentSetIndex + 1;
      const totalSets = exercise.sets;
      
      if (player.phase === 'rest') {
        displayName = 'Rest';
        // During rest, we're resting AFTER completing currentSetIndex, so next set is currentSetIndex + 2
        const nextSet = Math.min(currentSet + 1, totalSets);
        displayDetail = `Next: ${exercise.name} Set ${nextSet} of ${totalSets}`;
      } else {
        displayDetail = `Set ${currentSet} of ${totalSets} ‚Ä¢ ${exercise.reps} reps`;
      }
    } else if (exercise.type === 'timed-sequence' && exercise.sequence) {
      const seq = exercise.sequence[player.currentSequenceIndex];
      if (seq) {
        const currentRep = player.currentSetIndex + 1;
        const totalReps = seq.reps;
        
        if (player.phase === 'rest') {
          displayName = 'Rest';
          const nextRep = Math.min(currentRep + 1, totalReps);
          displayDetail = `Next: ${seq.name} (${nextRep} of ${totalReps})`;
        } else {
          displayName = seq.name;
          displayDetail = `${currentRep} of ${totalReps}`;
        }
      }
    } else if (exercise.type === 'instruction') {
      displayDetail = 'Follow the instructions below';
    } else if (exercise.type === 'complete') {
      displayDetail = 'Tap Finish to save your workout';
    }
    
    els.exerciseName.textContent = displayName;
    els.exerciseDetail.textContent = displayDetail;
    
    // Timer
    els.timerDisplay.textContent = formatTime(player.timeRemaining);
    els.timerDisplay.className = `timer-display ${player.phase}`;
    
    // Progress bar
    const progress = player.timeTotal > 0 ? ((player.timeTotal - player.timeRemaining) / player.timeTotal) * 100 : 0;
    els.progressBar.style.width = `${progress}%`;
    els.progressBar.className = `progress-bar ${player.phase}`;
    
    // Active state for glow
    els.currentExercise.classList.toggle('timer-active', player.active && !player.paused && player.timeRemaining > 0);
    
    // Instructions
    els.instructionsContent.innerHTML = getInstructions(displayName);
    
    // Button states
    els.prevBtn.disabled = !player.active || player.currentExerciseIndex === 0;
    els.skipBtn.disabled = !player.active;
    els.cancelBtn.style.display = player.active ? 'flex' : 'none';
    
    // Main button
    if (!player.active) {
      els.mainBtn.textContent = 'START';
      els.mainBtn.className = 'control-btn primary';
    } else if (player.paused) {
      els.mainBtn.textContent = 'RESUME';
      els.mainBtn.className = 'control-btn primary';
    } else if (exercise.type === 'complete') {
      els.mainBtn.textContent = 'FINISH';
      els.mainBtn.className = 'control-btn primary';
    } else if (player.phase === 'ready' || player.phase === 'confirm') {
      els.mainBtn.textContent = 'BEGIN';
      els.mainBtn.className = 'control-btn primary';
    } else if (player.phase === 'work' && player.timeRemaining <= 0) {
      els.mainBtn.textContent = 'SET DONE';
      els.mainBtn.className = 'control-btn primary';
    } else {
      els.mainBtn.textContent = 'PAUSE';
      els.mainBtn.className = 'control-btn secondary';
    }
  }

  function updateConfirmView() {
    const workout = getCurrentWorkout();
    const exercise = getCurrentExercise();
    const totalExercises = workout.exercises.length;
    
    els.confirmStep.textContent = `STEP ${player.currentExerciseIndex + 1} OF ${totalExercises}`;
    els.confirmTitle.textContent = exercise.name;
    
    if (exercise.type === 'sets') {
      els.confirmSubtitle.textContent = `${exercise.sets} sets √ó ${exercise.reps}`;
    } else if (exercise.type === 'timed-sequence') {
      els.confirmSubtitle.textContent = 'Timed practice sequence';
    } else if (exercise.type === 'complete') {
      els.confirmSubtitle.textContent = 'Great job!';
    } else {
      els.confirmSubtitle.textContent = 'Guided exercise';
    }
    
    els.confirmInstructions.innerHTML = getInstructions(exercise.name);
    
    // Upcoming list
    const upcoming = [];
    for (let i = player.currentExerciseIndex; i < Math.min(player.currentExerciseIndex + 5, totalExercises); i++) {
      const ex = workout.exercises[i];
      let meta = '';
      if (ex.type === 'sets') meta = `${ex.sets} sets √ó ${ex.reps}`;
      else if (ex.type === 'timed-sequence') meta = 'Timed sequence';
      else if (ex.type === 'complete') meta = 'Complete';
      else meta = 'Guided';
      
      upcoming.push({
        number: i + 1,
        name: ex.name,
        meta: meta,
        current: i === player.currentExerciseIndex
      });
    }
    
    els.upcomingList.innerHTML = upcoming.map(item => `
      <div class="upcoming-item ${item.current ? 'current' : ''}">
        <div class="upcoming-number">${item.number}</div>
        <div class="upcoming-info">
          <div class="upcoming-name">${item.name}</div>
          <div class="upcoming-meta">${item.meta}</div>
        </div>
      </div>
    `).join('');
    
    // Update main button for confirm view
    if (exercise.type === 'complete') {
      els.mainBtn.textContent = 'FINISH';
    } else {
      els.mainBtn.textContent = "I'M READY";
    }
    els.mainBtn.className = 'control-btn primary';
    
    // Update other button states for confirm view
    els.prevBtn.disabled = player.currentExerciseIndex === 0;
    els.skipBtn.disabled = false;
    els.cancelBtn.style.display = 'flex';
  }

  function updateHistoryView() {
    const history = state.history || [];
    
    // Stats
    $('totalWorkouts').textContent = history.length;
    
    // This week
    const weekAgo = Date.now() - 7 * 24 * 60 * 60 * 1000;
    const thisWeek = history.filter(h => h.timestamp > weekAgo).length;
    $('thisWeek').textContent = thisWeek;
    
    // Streak (consecutive days)
    let streak = 0;
    if (history.length > 0) {
      const days = new Set();
      history.forEach(h => {
        const date = new Date(h.timestamp);
        days.add(`${date.getFullYear()}-${date.getMonth()}-${date.getDate()}`);
      });
      
      const today = new Date();
      let checkDate = new Date(today);
      
      while (true) {
        const key = `${checkDate.getFullYear()}-${checkDate.getMonth()}-${checkDate.getDate()}`;
        if (days.has(key)) {
          streak++;
          checkDate.setDate(checkDate.getDate() - 1);
        } else if (streak === 0) {
          // Check yesterday if today hasn't been done yet
          checkDate.setDate(checkDate.getDate() - 1);
          const yesterdayKey = `${checkDate.getFullYear()}-${checkDate.getMonth()}-${checkDate.getDate()}`;
          if (!days.has(yesterdayKey)) break;
        } else {
          break;
        }
      }
    }
    $('streak').textContent = streak;
    
    // History list
    const historyList = $('historyList');
    if (history.length === 0) {
      historyList.innerHTML = '<div class="history-empty">No workouts yet. Complete a session to see your history.</div>';
    } else {
      historyList.innerHTML = history.slice(0, 20).map(h => {
        const date = new Date(h.timestamp);
        const dateStr = date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
        const duration = h.duration ? `${Math.floor(h.duration / 60)}m ${h.duration % 60}s` : '';
        const sessionName = WORKOUTS[h.session]?.name.split('‚Äî')[1]?.trim() || 'Workout';
        
        return `
          <div class="history-item">
            <div class="history-session-badge">${escapeHtml(h.session)}</div>
            <div class="history-info">
              <div class="history-date">${escapeHtml(dateStr)}</div>
              <div class="history-meta">${escapeHtml(sessionName)} ${duration ? '‚Ä¢ ' + escapeHtml(duration) : ''}</div>
            </div>
          </div>
        `;
      }).join('');
    }
  }

  function updateSettingsView() {
    $('prepTime').value = state.settings.prepTime;
    $('mainRest').value = state.settings.mainRest;
    $('accessoryRest').value = state.settings.accessoryRest;
    $('microRest').value = state.settings.microRest;
    $('soundMode').value = state.settings.soundMode;
  }

  // ===== TIMER LOGIC =====
  let lastBeepedSecond = -1;
  
  function startTimer(duration, phase) {
    stopTimer();
    
    player.timeTotal = duration;
    player.timeRemaining = duration;
    player.phase = phase;
    lastBeepedSecond = -1; // Reset beep tracker
    
    updateWorkoutView();
    
    if (duration <= 0) return;
    
    const startTime = Date.now();
    
    player.timerInterval = setInterval(() => {
      const elapsed = (Date.now() - startTime) / 1000;
      player.timeRemaining = Math.max(0, duration - elapsed);
      
      // Countdown beeps at 3, 2, 1 - only once per second
      const remaining = Math.ceil(player.timeRemaining);
      if (remaining <= 3 && remaining > 0 && remaining !== lastBeepedSecond) {
        lastBeepedSecond = remaining;
        playBeep(remaining === 1 ? 1200 : 880, 80);
      }
      
      updateWorkoutView();
      
      if (player.timeRemaining <= 0) {
        stopTimer();
        playBeep(1400, 200);
        onTimerComplete();
      }
    }, 50);
  }

  function stopTimer() {
    if (player.timerInterval) {
      clearInterval(player.timerInterval);
      player.timerInterval = null;
    }
  }

  function pauseTimer() {
    stopTimer();
    player.paused = true;
    updateWorkoutView();
  }

  function resumeTimer() {
    player.paused = false;
    if (player.timeRemaining > 0) {
      startTimer(player.timeRemaining, player.phase);
    } else {
      updateWorkoutView();
    }
  }

  // ===== WAKE LOCK =====
  let wakeLock = null;
  
  async function requestWakeLock() {
    if ('wakeLock' in navigator) {
      try {
        wakeLock = await navigator.wakeLock.request('screen');
        wakeLock.addEventListener('release', () => {
          wakeLock = null;
        });
      } catch (e) {
        // Wake lock not available or denied
      }
    }
  }
  
  function releaseWakeLock() {
    if (wakeLock) {
      wakeLock.release();
      wakeLock = null;
    }
  }

  // ===== CANCEL WORKOUT =====
  function cancelWorkout() {
    stopTimer();
    releaseWakeLock();
    
    player.active = false;
    player.paused = false;
    player.currentExerciseIndex = 0;
    player.currentSetIndex = 0;
    player.currentSequenceIndex = 0;
    player.phase = 'ready';
    player.timeRemaining = 0;
    player.timeTotal = 0;
    
    goToIntro();
    showToast('Workout cancelled');
  }

  // ===== WORKOUT FLOW =====
  function startSession() {
    player.active = true;
    player.paused = false;
    player.currentExerciseIndex = 0;
    player.currentSetIndex = 0;
    player.currentSequenceIndex = 0;
    player.phase = 'confirm';
    player.sessionStartTime = Date.now();
    
    requestWakeLock();
    
    showView('confirm');
    updateConfirmView();
    updateWorkoutView(); // Update button states
  }

  function goToIntro() {
    showView('intro');
    renderWorkoutOverview();
    els.mainBtn.textContent = 'START WORKOUT';
    els.mainBtn.className = 'control-btn primary';
    els.prevBtn.disabled = true;
    els.skipBtn.disabled = true;
    els.cancelBtn.style.display = 'none';
  }

  function showConfirmForExercise() {
    player.phase = 'confirm';
    player.currentSetIndex = 0;
    player.currentSequenceIndex = 0;
    stopTimer();
    showView('confirm');
    updateConfirmView();
  }

  function beginExercise() {
    const exercise = getCurrentExercise();
    
    showView('workout');
    
    if (exercise.type === 'complete') {
      player.phase = 'ready';
      player.timeRemaining = 0;
      player.timeTotal = 0;
      updateWorkoutView();
      return;
    }
    
    if (exercise.type === 'instruction') {
      // No timer, just show instructions
      player.phase = 'work';
      player.timeRemaining = 0;
      player.timeTotal = 0;
      updateWorkoutView();
      return;
    }
    
    if (exercise.type === 'sets') {
      // Start prep for first set
      startTimer(state.settings.prepTime, 'prep');
      return;
    }
    
    if (exercise.type === 'timed-sequence') {
      // Start prep for first item in sequence
      startTimer(state.settings.prepTime, 'prep');
      return;
    }
  }

  function onTimerComplete() {
    const exercise = getCurrentExercise();
    
    if (exercise.type === 'sets') {
      handleSetsTimerComplete(exercise);
    } else if (exercise.type === 'timed-sequence') {
      handleSequenceTimerComplete(exercise);
    }
  }

  function handleSetsTimerComplete(exercise) {
    if (player.phase === 'prep') {
      // Prep done, now it's work time (user does the set)
      player.phase = 'work';
      player.timeRemaining = 0;
      player.timeTotal = 0;
      updateWorkoutView();
      // Wait for user to mark set complete
    } else if (player.phase === 'rest') {
      // Rest done, move to next set
      // currentSetIndex was already incremented when we started rest
      // Now check if we still have sets to do
      if (player.currentSetIndex >= exercise.sets) {
        // All sets done, move to next exercise
        advanceToNextExercise();
      } else {
        // Prep for the next set
        startTimer(state.settings.prepTime, 'prep');
      }
    }
  }

  function handleSequenceTimerComplete(exercise) {
    const sequence = exercise.sequence;
    const currentSeq = sequence[player.currentSequenceIndex];
    
    if (player.phase === 'prep') {
      // Prep done, start work timer
      if (currentSeq.time) {
        startTimer(currentSeq.time, 'work');
      } else {
        // No timer (like perfect singles), wait for user
        player.phase = 'work';
        player.timeRemaining = 0;
        player.timeTotal = 0;
        updateWorkoutView();
      }
    } else if (player.phase === 'work') {
      // Work/hold done - this counts as completing the current rep
      const completedRep = player.currentSetIndex + 1;
      
      if (completedRep >= currentSeq.reps) {
        // This sequence item is done
        player.currentSetIndex = 0;
        player.currentSequenceIndex++;
        
        if (player.currentSequenceIndex >= sequence.length) {
          // All sequence done
          advanceToNextExercise();
        } else {
          // Prep for next sequence item
          startTimer(state.settings.prepTime, 'prep');
        }
      } else {
        // More reps to do - increment and rest
        player.currentSetIndex++;
        startTimer(currentSeq.rest || state.settings.microRest, 'rest');
      }
    } else if (player.phase === 'rest') {
      // Rest done, prep for next rep (index already incremented when rest started)
      startTimer(state.settings.prepTime, 'prep');
    }
  }

  function markSetComplete() {
    const exercise = getCurrentExercise();
    
    if (exercise.type === 'instruction' || exercise.type === 'complete') {
      advanceToNextExercise();
      return;
    }
    
    if (exercise.type === 'sets') {
      // Just completed set at currentSetIndex
      const completedSet = player.currentSetIndex + 1; // 1-based for comparison
      
      if (completedSet >= exercise.sets) {
        // All sets done, move to next exercise
        advanceToNextExercise();
      } else {
        // More sets to do - increment index and start rest
        player.currentSetIndex++;
        const restTime = getRestTime(exercise.rest);
        startTimer(restTime, 'rest');
      }
    } else if (exercise.type === 'timed-sequence') {
      const seq = exercise.sequence[player.currentSequenceIndex];
      // Just completed rep at currentSetIndex
      const completedRep = player.currentSetIndex + 1; // 1-based for comparison
      
      if (completedRep >= seq.reps) {
        // This sequence item is done
        player.currentSetIndex = 0;
        player.currentSequenceIndex++;
        
        if (player.currentSequenceIndex >= exercise.sequence.length) {
          // All sequence items done
          advanceToNextExercise();
        } else {
          // Prep for next sequence item
          startTimer(state.settings.prepTime, 'prep');
        }
      } else {
        // More reps to do - increment and start rest
        player.currentSetIndex++;
        startTimer(seq.rest || state.settings.microRest, 'rest');
      }
    }
  }

  function advanceToNextExercise() {
    const workout = getCurrentWorkout();
    player.currentExerciseIndex++;
    
    if (player.currentExerciseIndex >= workout.exercises.length) {
      // Workout complete
      finishWorkout();
      return;
    }
    
    showConfirmForExercise();
  }

  function previousExercise() {
    if (player.currentExerciseIndex > 0) {
      player.currentExerciseIndex--;
      player.currentSetIndex = 0;
      player.currentSequenceIndex = 0;
      showConfirmForExercise();
    }
  }

  function skipToNext() {
    const exercise = getCurrentExercise();
    stopTimer();
    
    if (player.phase === 'confirm') {
      // Skip this entire exercise
      advanceToNextExercise();
    } else if (player.phase === 'prep') {
      // Skip prep, go straight to work
      if (exercise.type === 'sets') {
        player.phase = 'work';
        player.timeRemaining = 0;
        player.timeTotal = 0;
        updateWorkoutView();
      } else if (exercise.type === 'timed-sequence') {
        const seq = exercise.sequence[player.currentSequenceIndex];
        if (seq && seq.time) {
          startTimer(seq.time, 'work');
        } else {
          player.phase = 'work';
          player.timeRemaining = 0;
          player.timeTotal = 0;
          updateWorkoutView();
        }
      }
    } else if (player.phase === 'rest') {
      // Skip rest, go to prep for next set/rep
      if (exercise.type === 'sets') {
        if (player.currentSetIndex >= exercise.sets) {
          advanceToNextExercise();
        } else {
          startTimer(state.settings.prepTime, 'prep');
        }
      } else if (exercise.type === 'timed-sequence') {
        const seq = exercise.sequence[player.currentSequenceIndex];
        if (player.currentSetIndex >= seq.reps) {
          player.currentSetIndex = 0;
          player.currentSequenceIndex++;
          if (player.currentSequenceIndex >= exercise.sequence.length) {
            advanceToNextExercise();
          } else {
            startTimer(state.settings.prepTime, 'prep');
          }
        } else {
          startTimer(state.settings.prepTime, 'prep');
        }
      }
    } else if (player.phase === 'work') {
      // Skip current set/rep - mark it complete
      markSetComplete();
    } else {
      // Default: mark complete
      markSetComplete();
    }
  }

  function finishWorkout() {
    stopTimer();
    releaseWakeLock();
    
    // Save to history
    const duration = player.sessionStartTime ? Math.floor((Date.now() - player.sessionStartTime) / 1000) : 0;
    state.history.unshift({
      session: state.session,
      timestamp: Date.now(),
      duration: duration
    });
    state.history = state.history.slice(0, 100); // Keep last 100
    saveState();
    
    // Reset player
    player.active = false;
    player.paused = false;
    player.currentExerciseIndex = 0;
    player.currentSetIndex = 0;
    player.currentSequenceIndex = 0;
    player.phase = 'ready';
    player.timeRemaining = 0;
    player.timeTotal = 0;
    
    showToast('Workout saved!');
    goToIntro();
  }

  // ===== EVENT HANDLERS =====
  function handleMainButton() {
    // Init audio context on user interaction
    if (!audioCtx) {
      try {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      } catch (e) {}
    }
    
    // Handle intro view - start workout
    if (views.intro.classList.contains('active')) {
      startSession();
      return;
    }
    
    const exercise = getCurrentExercise();
    
    if (!player.active) {
      goToIntro();
      return;
    }
    
    if (player.phase === 'confirm') {
      if (exercise.type === 'complete') {
        finishWorkout();
      } else {
        beginExercise();
      }
      return;
    }
    
    if (player.paused) {
      resumeTimer();
      return;
    }
    
    if (exercise.type === 'complete') {
      finishWorkout();
      return;
    }
    
    if (player.phase === 'work' && player.timeRemaining <= 0) {
      // User marking set complete
      markSetComplete();
      return;
    }
    
    if (player.timerInterval) {
      pauseTimer();
    }
  }

  function selectSession(session) {
    if (player.active) {
      showToast('Finish current workout first');
      return;
    }

    state.session = session;
    saveState();

    // Update header tabs
    $$('.session-tab').forEach(tab => {
      tab.classList.toggle('active', tab.dataset.session === session);
    });

    // Update intro session buttons
    $$('.session-btn').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.session === session);
    });

    // Update rotation visual
    updateRotationVisual();

    // Update workout overview and view
    renderWorkoutOverview();
    updateWorkoutView();
  }

  // ===== INIT =====
  async function init() {
    // Load programs first
    await loadProgramsList();

    if (availablePrograms.length === 0) {
      // No programs found, show error
      document.getElementById('loadingOverlay').innerHTML = `
        <div style="text-align: center; padding: 24px;">
          <h2 style="color: var(--danger); margin-bottom: 16px;">No Programs Found</h2>
          <p style="color: var(--text-muted);">Could not load workout programs from data/programs.json</p>
        </div>
      `;
      return;
    }

    // Populate program selector
    populateProgramSelector();

    // Load last used program or first available
    let programToLoad = availablePrograms[0];
    if (state.currentProgramId) {
      const savedProgram = availablePrograms.find(p => p.id === state.currentProgramId);
      if (savedProgram) programToLoad = savedProgram;
    }

    await loadProgram(programToLoad);
    updateProgramUI();

    // Hide loading overlay
    hideLoading();

    // Session tabs are now rendered dynamically by updateProgramUI()
    // Session buttons are now rendered dynamically by updateProgramUI()

    // Main controls
    els.mainBtn.addEventListener('click', handleMainButton);
    els.prevBtn.addEventListener('click', previousExercise);
    els.skipBtn.addEventListener('click', skipToNext);
    els.cancelBtn.addEventListener('click', () => {
      $('cancelWorkoutModal').classList.add('show');
    });
    
    // Cancel workout modal
    $('cancelWorkoutNo').addEventListener('click', () => {
      $('cancelWorkoutModal').classList.remove('show');
    });
    $('cancelWorkoutYes').addEventListener('click', () => {
      $('cancelWorkoutModal').classList.remove('show');
      cancelWorkout();
    });
    
    // Instructions toggle
    els.instructionsToggle.addEventListener('click', () => {
      els.instructionsToggle.classList.toggle('open');
      els.instructionsContent.classList.toggle('open');
    });
    
    // Header buttons
    $('historyBtn').addEventListener('click', () => {
      updateHistoryView();
      showView('history');
    });
    
    $('settingsBtn').addEventListener('click', () => {
      updateSettingsView();
      showView('settings');
    });
    
    // Back buttons
    $('historyBackBtn').addEventListener('click', () => {
      if (player.active) {
        if (player.phase === 'confirm') {
          showView('confirm');
          updateConfirmView();
        } else {
          showView('workout');
          updateWorkoutView();
        }
      } else {
        goToIntro();
      }
    });
    
    $('settingsBackBtn').addEventListener('click', () => {
      if (player.active) {
        if (player.phase === 'confirm') {
          showView('confirm');
          updateConfirmView();
        } else {
          showView('workout');
          updateWorkoutView();
        }
      } else {
        goToIntro();
      }
    });
    
    // Settings inputs
    ['prepTime', 'mainRest', 'accessoryRest', 'microRest', 'soundMode'].forEach(id => {
      $(id).addEventListener('change', (e) => {
        const value = id === 'soundMode' ? e.target.value : parseInt(e.target.value);
        state.settings[id] = value;
        saveState();
        showToast('Settings saved');
      });
    });
    
    // Reset button
    $('resetBtn').addEventListener('click', () => {
      $('resetModal').classList.add('show');
    });
    
    $('resetCancel').addEventListener('click', () => {
      $('resetModal').classList.remove('show');
    });
    
    $('resetConfirm').addEventListener('click', () => {
      localStorage.removeItem(STORAGE_KEY);
      state = { ...defaultState };
      $('resetModal').classList.remove('show');
      showToast('All data reset');
      updateSettingsView();
      updateWorkoutView();
    });
    
    // Initial render - show intro view
    goToIntro();
  }

  init();
})();
</script>

</body>
</html>
